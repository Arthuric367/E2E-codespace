<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notification Management - E2E Outage Communication Platform - Notification Management</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: white;
            color: #333;
        }

        /* Header Styles */
        .header {
            background-color: white;
            color: #2c5aa0;
            padding: 12px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding-bottom: 15px;
            border-bottom: 2px solid #e0e0e0;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .menu-icon {
            background: none;
            border: none;
            color: black;
            font-size: 16px;
            cursor: pointer;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 26px;
            font-weight: bold;
        }

        .logo-icon {
            width: 35px;
            height: 35px;
            background-color: #2c5aa0;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 20px;
        }

        .platform-title {
            font-size: 26px;
            font-weight: bold;
        }

        .user-avatar {
            width: 35px;
            height: 35px;
            background-color: #4a6fa5;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 14px;
        }

        /* Sidebar */
        .sidebar {
            width: 280px;
            background-color: white;
            border-right: 1px solid #e0e0e0;
            padding: 20px 0;
            overflow-y: auto;
            position: fixed;
            top: 70px;
            left: -280px;
            height: calc(100vh - 70px);
            transition: left 0.3s ease;
            z-index: 1000;
            box-shadow: 2px 0 8px rgba(0, 0, 0, 0.1);
        }

        .sidebar.show {
            left: 0;
        }

        /* Sidebar overlay for mobile/tablet */
        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .sidebar-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .nav-menu {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .nav-item {
            margin: 0;
        }

        .nav-link {
            display: block;
            padding: 15px 25px;
            color: #666;
            text-decoration: none;
            font-size: 16px;
            font-weight: 400;
            transition: all 0.2s ease;
            border-left: 3px solid transparent;
        }

        .nav-link:hover {
            background-color: #f8f9fa;
            color: #333;
        }

        .nav-link.active {
            background-color: #b3c6e0;
            color: #2c5aa0;
            border-left-color: #2c5aa0;
            font-weight: 500;
        }

        /* Main Container */
        .app-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 24px;
        }

        .main-content {
            background-color: white;
            border-radius: 8px;
            padding: 18px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.4);
        }

        .page-title {
            font-size: 28px;
            font-weight: 400;
            color: #666;
            margin-bottom: 30px;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 32px;
            border-bottom: 2px solid #e0e0e0;
            margin-bottom: 0;
        }

        .tab {
            padding: 12px 0;
            font-size: 16px;
            font-weight: 500;
            color: #666;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            margin-bottom: -2px;
            transition: all 0.3s;
        }

        .tab:hover {
            color: #2c5aa0;
        }

        .tab.active {
            color: #2c5aa0;
            border-bottom-color: #2c5aa0;
        }

        /* Section Header */
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            margin-top: 24px;
        }

        .section-title {
            font-size: 20px;
            font-weight: 600;
            color: #333;
        }

        .action-buttons {
            display: flex;
            gap: 12px;
        }

        /* Buttons */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background-color: #2c5aa0;
            color: white;
        }

        .btn-primary:hover {
            background-color: #234a87;
        }

        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background-color: #5a6268;
        }

        /* Filter Section */
        .filter-section {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 20px;
        }

        .filter-dropdown {
            min-width: 200px;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            background-color: white;
        }

        /* History Filters */
        .history-filters {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            justify-content: flex-start;
        }

        .history-filters .filter-dropdown {
            flex: 0 0 auto;
        }

        .history-filters input[type="text"] {
            flex: 1;
            max-width: 300px;
        }

        /* ============================================================
           REUSABLE COMPONENT: Date Filter Dropdown Styles
           ============================================================
           This section contains all styles for the date filter component.
           Copy this entire section when reusing the component.
           ============================================================ */

        /* Date Filter Dropdown */
        .date-filter-dropdown {
            position: relative;
            min-width: 200px;
        }

        .date-filter-trigger {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: white;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .date-filter-trigger:hover {
            border-color: #2c5aa0;
        }

        .filter-icon {
            font-size: 16px;
        }

        .date-filter-content {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            margin-top: 4px;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            min-width: 520px;
        }

        .date-filter-dropdown.open .date-filter-content {
            display: block;
        }

        .date-filter-layout {
            display: flex;
        }

        /* Date Preset Options */
        .date-preset-options {
            width: 180px;
            padding: 8px;
            border-right: 1px solid #e0e0e0;
            background-color: #f8f9fa;
        }

        .date-preset-item {
            padding: 10px 12px;
            cursor: pointer;
            font-size: 14px;
            color: #333;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .date-preset-item:hover {
            background-color: #e9ecef;
        }

        .date-preset-item.active {
            background-color: #2c5aa0;
            color: white;
        }

        .date-preset-divider {
            height: 1px;
            background-color: #ddd;
            margin: 8px 0;
        }

        .date-clear-btn {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            background-color: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            color: #666;
            transition: all 0.2s;
        }

        .date-clear-btn:hover {
            background-color: #f8f9fa;
            border-color: #2c5aa0;
        }

        /* Calendar Section */
        .date-calendar-section {
            flex: 1;
            padding: 12px;
        }

        .calendar-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            gap: 8px;
        }

        .calendar-month {
            font-weight: 600;
            font-size: 14px;
            color: #333;
            flex: 1;
            text-align: center;
        }

        .calendar-nav-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 14px;
            color: #666;
            padding: 4px 8px;
            transition: all 0.2s;
        }

        .calendar-nav-btn:hover {
            color: #2c5aa0;
            background-color: #f0f0f0;
            border-radius: 4px;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
            margin-bottom: 16px;
        }

        .calendar-day-header {
            text-align: center;
            font-size: 12px;
            font-weight: 600;
            color: #666;
            padding: 8px 4px;
        }

        .calendar-day {
            text-align: center;
            padding: 8px 4px;
            font-size: 13px;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.2s;
            color: #333;
        }

        .calendar-day:hover {
            background-color: #e9ecef;
        }

        .calendar-day.empty {
            cursor: default;
            color: #ccc;
        }

        .calendar-day.empty:hover {
            background-color: transparent;
        }

        .calendar-day.selected {
            background-color: #2c5aa0;
            color: white;
        }

        .calendar-day.in-range {
            background-color: #d4e3f7;
        }

        .calendar-day.other-month {
            color: #999;
        }

        .calendar-actions {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #e0e0e0;
        }

        .calendar-btn {
            padding: 8px 16px;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .calendar-cancel {
            background-color: white;
            color: #666;
        }

        .calendar-cancel:hover {
            background-color: #f8f9fa;
        }

        .calendar-apply {
            background-color: #2c5aa0;
            color: white;
            border-color: #2c5aa0;
        }

        .calendar-apply:hover {
            background-color: #234a87;
        }

        /* ============================================================
           END: Date Filter Dropdown Styles
           ============================================================ */

        /* ============================================================
           REUSABLE COMPONENT: Multi-Select Dropdown with Checkboxes
           ============================================================
           This section contains all styles for the multi-select dropdown.
           Copy this entire section when reusing the component.
           ============================================================ */

        /* Multi-Select Dropdown */
        .multi-select-dropdown {
            position: relative;
            min-width: 200px;
        }

        .multi-select-trigger {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: white;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .multi-select-trigger:hover {
            border-color: #2c5aa0;
        }

        .dropdown-arrow {
            font-size: 10px;
            color: #666;
            transition: transform 0.3s;
        }

        .multi-select-dropdown.open .dropdown-arrow {
            transform: rotate(180deg);
        }

        .multi-select-content {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            margin-top: 4px;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            max-height: 250px;
            overflow-y: auto;
        }

        .multi-select-dropdown.open .multi-select-content {
            display: block;
        }

        .multi-select-option {
            padding: 8px 12px;
            transition: background-color 0.2s;
        }

        .multi-select-option:hover {
            background-color: #f8f9fa;
        }

        .multi-select-option label {
            display: flex;
            align-items: center;
            cursor: pointer;
            font-size: 14px;
            color: #333;
            user-select: none;
        }

        .multi-select-option input[type="checkbox"] {
            margin-right: 8px;
            cursor: pointer;
            width: 16px;
            height: 16px;
        }

        .multi-select-option span {
            flex: 1;
        }

        /* Selected items display in trigger */
        .multi-select-trigger .selected-count {
            background-color: #2c5aa0;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 12px;
            margin-left: 8px;
        }

        /* ============================================================
           END: Multi-Select Dropdown Styles
           ============================================================ */

        /* Table Styles */
        .notification-table {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background-color: #f8f9fa;
        }

        th {
            padding: 12px 16px;
            text-align: left;
            font-weight: 600;
            color: #2c5aa0;
            font-size: 14px;
            border-bottom: 2px solid #e0e0e0;
        }

        td {
            padding: 16px;
            border-bottom: 1px solid #e0e0e0;
            font-size: 14px;
            color: #333;
        }

        tbody tr:hover {
            background-color: #f8f9fa;
        }

        /* Checkbox Styles */
        th input[type="checkbox"],
        td input[type="checkbox"] {
            cursor: pointer;
            width: 16px;
            height: 16px;
        }

        /* Status Badges */
        .status-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            display: inline-block;
        }

        .status-draft {
            background-color: #fff3cd;
            color: #856404;
        }

        .status-sent {
            background-color: #d4edda;
            color: #155724;
        }

        .status-completed {
            background-color: #d1ecf1;
            color: #0c5460;
        }

        /* Opt-Out Status Icons */
        .opt-status {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            font-size: 16px;
            font-weight: bold;
        }

        .opt-in {
            background-color: #d4edda;
            color: #28a745;
        }

        .opt-out {
            background-color: #f8d7da;
            color: #dc3545;
        }

        /* Action Icons */
        .table-actions {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .action-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 18px;
            color: #666;
            padding: 4px;
            transition: all 0.3s;
        }

        .action-btn:hover {
            color: #2c5aa0;
        }

        .action-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .action-btn:disabled:hover {
            color: #666;
        }

        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            margin-top: 24px;
            padding-top: 20px;
            border-top: 1px solid #e0e0e0;
        }

        .pagination button {
            padding: 8px 12px;
            border: 1px solid #ddd;
            background-color: white;
            cursor: pointer;
            border-radius: 4px;
            font-size: 14px;
            transition: all 0.3s;
        }

        .pagination button:hover {
            background-color: #f8f9fa;
            border-color: #2c5aa0;
        }

        .pagination button.active {
            background-color: #2c5aa0;
            color: white;
            border-color: #2c5aa0;
        }

        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Modal Overlay */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.show {
            display: flex;
        }

        /* Modal */
        .modal {
            background-color: white;
            border-radius: 8px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
            color: #333;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 28px;
            color: #666;
            cursor: pointer;
            line-height: 1;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-close:hover {
            color: #333;
        }

        .modal-body {
            padding: 24px;
        }

        .modal-footer {
            padding: 16px 24px;
            border-top: 1px solid #e0e0e0;
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        /* Form Styles */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #333;
            font-size: 14px;
        }

        .form-input,
        .form-select,
        .form-textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            font-family: inherit;
        }

        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            outline: none;
            border-color: #2c5aa0;
            box-shadow: 0 0 0 3px rgba(44, 90, 160, 0.1);
        }

        .form-textarea {
            resize: vertical;
            min-height: 100px;
        }

        .required {
            color: #dc3545;
            margin-left: 4px;
        }

        /* Info Display */
        .info-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            margin-bottom: 20px;
        }

        .info-item {
            padding: 12px;
            background-color: #f8f9fa;
            border-radius: 4px;
        }

        .info-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 4px;
        }

        .info-value {
            font-size: 14px;
            font-weight: 500;
            color: #333;
        }

        /* Message Content Display */
        .message-preview {
            padding: 16px;
            background-color: #f8f9fa;
            border-radius: 4px;
            border: 1px solid #e0e0e0;
            margin-top: 12px;
            white-space: pre-wrap;
            font-size: 14px;
            line-height: 1.6;
        }

        /* Update Message */
        .update-message {
            position: fixed;
            top: 80px;
            right: 24px;
            padding: 16px 24px;
            border-radius: 4px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 3000;
            display: none;
            align-items: center;
            gap: 12px;
            max-width: 400px;
            animation: slideIn 0.3s ease;
        }

        .update-message.show {
            display: flex;
        }

        .update-message.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .update-message.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .update-message.info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Preview Modal Styles */
        .preview-modal {
            max-width: 800px;
            width: 95%;
        }

        /* Auto-Triggered Modal Styles */
        .auto-triggered-modal {
            max-width: 900px;
            width: 95%;
        }

        .auto-triggered-table {
            overflow-x: auto;
        }

        .auto-triggered-table table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        .auto-triggered-table th {
            padding: 12px 16px;
            text-align: left;
            font-weight: 600;
            color: #2c5aa0;
            font-size: 14px;
            border-bottom: 2px solid #e0e0e0;
            background-color: #f8f9fa;
        }

        .auto-triggered-table td {
            padding: 12px 16px;
            border-bottom: 1px solid #e0e0e0;
            font-size: 14px;
            color: #333;
        }

        .auto-triggered-table tbody tr:hover {
            background-color: #f8f9fa;
        }

        .template-link {
            color: #2c5aa0;
            text-decoration: underline;
            cursor: pointer;
            font-size: 14px;
        }

        .template-link:hover {
            color: #1e3d6f;
            text-decoration: none;
        }

        /* Create Notification Modal Styles */
        .create-notification-modal {
            max-width: 1400px;
            width: 95%;
            max-height: 90vh;
        }

        .create-notification-container {
            display: flex;
            gap: 25px;
            min-height: 500px;
        }

        .notification-form-section {
            flex: 1;
            min-width: 500px;
        }

        .variables-section {
            width: 280px;
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
            flex-shrink: 0;
        }

        .variables-section h4 {
            margin: 0 0 8px 0;
            color: #333;
            font-size: 16px;
            font-weight: 600;
        }

        .variables-help {
            font-size: 13px;
            color: #6c757d;
            margin-bottom: 16px;
            line-height: 1.4;
        }

        .variables-grid {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .variable-item {
            background-color: #e3f2fd;
            border: 1px solid #2c5aa0;
            border-radius: 4px;
            padding: 8px 12px;
            cursor: grab;
            transition: all 0.2s ease;
            user-select: none;
        }

        .variable-item:hover {
            background-color: #bbdefb;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .variable-item:active {
            cursor: grabbing;
        }

        .variable-name {
            font-size: 12px;
            color: #2c5aa0;
            font-weight: 500;
        }

        /* Form Row Layout */
        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-row .form-group {
            flex: 1;
            margin-bottom: 0;
        }

        /* Template Name Row with Language Tabs */
        .template-name-row {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            margin-bottom: 20px;
        }

        .template-name-group {
            flex: 1;
        }

        .template-name-group .form-input {
            width: 95%;
        }

        .inline-language-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 6px;
        }

        .inline-language-tab {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 6px 16px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: #495057;
            transition: all 0.2s ease;
            border: none;
        }

        .inline-language-tab.active {
            background-color: #2c5aa0;
            border-color: #2c5aa0;
            color: white;
        }

        .inline-language-tab:hover:not(.active) {
            background-color: #e9ecef;
        }

        /* Multi-Select Dropdown */
        .multi-select-dropdown {
            position: relative;
        }

        .multi-select-trigger {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: white;
            cursor: pointer;
            min-height: 44px;
        }

        .multi-select-trigger:hover {
            border-color: #2c5aa0;
        }

        .dropdown-arrow {
            transition: transform 0.2s ease;
            color: #666;
            font-size: 12px;
        }

        .multi-select-dropdown.open .dropdown-arrow {
            transform: rotate(180deg);
        }

        .multi-select-options {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background-color: white;
            border: 1px solid #ddd;
            border-top: none;
            border-radius: 0 0 4px 4px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            z-index: 1000;
            display: none;
            max-height: 200px;
            overflow-y: auto;
        }

        .multi-select-dropdown.open .multi-select-options {
            display: block;
        }

        .checkbox-option {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .checkbox-option:hover {
            background-color: #f8f9fa;
        }

        .checkbox-option input[type="checkbox"] {
            margin-right: 10px;
            cursor: pointer;
        }

        .checkmark {
            margin-left: 5px;
        }

        /* Message Input Containers */
        .message-input-container {
            display: none;
            position: relative;
        }

        .message-input-container.active {
            display: block;
        }

        .message-textarea {
            min-height: 120px;
            resize: vertical;
            font-family: inherit;
        }

        .char-counter {
            text-align: right;
            font-size: 12px;
            color: #6c757d;
            margin-top: 4px;
        }

        .char-counter.warning {
            color: #ffc107;
        }

        .char-counter.danger {
            color: #dc3545;
        }

        .template-info {
            display: flex;
            gap: 30px;
            margin-bottom: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 6px;
        }

        .template-info-item {
            display: flex;
            flex-direction: column;
        }

        .template-info-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 4px;
            font-weight: 500;
        }

        .template-info-value {
            font-size: 14px;
            color: #333;
            font-weight: 600;
        }

        /* Language Tabs */
        .language-tabs {
            display: flex;
            border-bottom: 1px solid #e9ecef;
            margin-bottom: 20px;
        }

        .language-tab {
            padding: 12px 24px;
            background: none;
            border: none;
            border-bottom: 2px solid transparent;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: #666;
            transition: all 0.2s ease;
        }

        .language-tab.active {
            color: white;
            background-color: #2c5aa0;
            border-bottom-color: #2c5aa0;
            border-radius: 4px 4px 0 0;
        }

        .language-tab:hover {
            color: #2c5aa0;
        }

        /* Preview Content */
        .preview-content {
            display: none;
        }

        .preview-content.active {
            display: block;
        }

        .weather-content {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            border-left: 4px solid #2c5aa0;
            font-size: 14px;
            line-height: 1.6;
            color: #333;
        }

        /* Email Preview Styles */
        .email-preview-container {
            background-color: transparent;
            margin-bottom: 24px;
        }

        .email-header-section {
            background-color: #f9fafb;
            border: 1px solid #d1d5db;
            border-bottom: 1px solid #e5e7eb;
            border-radius: 8px 8px 0 0;
            padding: 16px 20px;
        }

        .email-subject-line {
            font-size: 20px;
            color: #111827;
            margin-bottom: 12px;
            padding-bottom: 8px;
        }

        .email-metadata {
            margin-bottom: 12px;
        }

        .email-from {
            display: flex;
            flex-direction: column;
        }

        .email-label {
            font-weight: 600;
            font-size: 14px;
            color: #374151;
        }

        .email-meta-text {
            font-size: 13px;
            color: #6b7280;
            margin-top: 2px;
        }

        .email-details {
            background-color: white;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 12px 16px;
            font-size: 13px;
            margin-top: 12px;
        }

        .email-detail-row {
            display: flex;
            margin-bottom: 6px;
            line-height: 1.5;
        }

        .email-detail-row:last-child {
            margin-bottom: 0;
        }

        .email-detail-label {
            font-weight: 600;
            color: #374151;
            min-width: 60px;
            margin-right: 8px;
        }

        .email-detail-value {
            color: #6b7280;
            flex: 1;
        }

        .email-body-section {
            padding: 20px;
            background-color: white;
            border: 1px solid #d1d5db;
            border-top: none;
            border-radius: 0 0 8px 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .email-body-content {
            font-size: 14px;
            line-height: 1.7;
            color: #374151;
            white-space: pre-wrap;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .empty-state-text {
            font-size: 16px;
        }

        /* New Row Animation */
        @keyframes highlightRow {
            0% {
                background-color: #d4edda;
            }
            100% {
                background-color: transparent;
            }
        }

        .new-row-highlight {
            animation: highlightRow 2s ease-in-out;
        }

        .highlight-row {
            animation: highlightRow 2s ease-in-out;
        }

        /* Toggle Switch */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        .toggle-switch input:checked + .toggle-slider {
            background-color: #2c5aa0;
        }

        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(20px);
        }

        /* Logic Configuration Styles */
        .logic-stage-container {
            background-color: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            margin-bottom: 24px;
            overflow: hidden;
        }

        .logic-stage-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            background-color: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }

        .logic-stage-body {
            padding: 20px;
            min-height: 80px;
        }

        .logic-summary {
            padding: 16px 20px;
            background-color: #fef9e7;
            border-top: 1px solid #dee2e6;
        }

        .scenario-container {
            background-color: #e3f2fd;
            border: 1px solid #90caf9;
            border-radius: 6px;
            padding: 16px;
            margin-bottom: 16px;
            position: relative;
        }

        .scenario-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .scenario-title {
            font-weight: 600;
            color: #1976d2;
            font-size: 14px;
            cursor: pointer;
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
        }

        .scenario-title:hover {
            background-color: rgba(25, 118, 210, 0.1);
        }

        .scenario-title-input {
            font-weight: 600;
            color: #1976d2;
            font-size: 14px;
            border: 1px solid #2c5aa0;
            border-radius: 4px;
            padding: 4px 8px;
            outline: none;
        }

        .condition-row {
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 12px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .condition-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .condition-name {
            font-weight: 500;
            color: #333;
            font-size: 13px;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            min-width: 100px;
        }

        .condition-name:hover {
            background-color: #f5f5f5;
        }

        .condition-name-input {
            font-weight: 500;
            color: #333;
            font-size: 13px;
            border: 1px solid #2c5aa0;
            border-radius: 4px;
            padding: 4px 8px;
            outline: none;
            min-width: 100px;
        }

        .condition-select {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
            background-color: white;
            cursor: pointer;
        }

        .condition-select:focus {
            outline: none;
            border-color: #2c5aa0;
        }

        .condition-input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
        }

        .condition-input:focus {
            outline: none;
            border-color: #2c5aa0;
        }

        .btn-edit-small {
            background-color: #2c5aa0;
            color: white;
            border: none;
            padding: 6px 16px;
            border-radius: 4px;
            font-size: 13px;
            cursor: pointer;
        }

        .btn-edit-small:hover {
            background-color: #1e4070;
        }

        .btn-icon {
            background: none;
            border: none;
            color: #666;
            cursor: pointer;
            padding: 4px 8px;
            font-size: 16px;
        }

        .btn-icon:hover {
            color: #333;
        }

        .btn-icon.delete:hover {
            color: #dc3545;
        }

        .btn-add-condition,
        .btn-add-scenario {
            background-color: transparent;
            color: #2c5aa0;
            border: 1px dashed #2c5aa0;
            padding: 8px 16px;
            border-radius: 4px;
            font-size: 13px;
            cursor: pointer;
            margin-top: 8px;
        }

        .btn-add-condition:hover,
        .btn-add-scenario:hover {
            background-color: rgba(44, 90, 160, 0.05);
        }

        .logic-operator {
            text-align: center;
            color: #666;
            font-weight: 600;
            font-size: 12px;
            margin: 8px 0;
        }

        .scenario-divider {
            text-align: center;
            color: #1976d2;
            font-weight: 600;
            font-size: 14px;
            margin: 16px 0;
            padding: 8px 0;
            background-color: #e3f2fd;
            border-radius: 4px;
        }

        /* Searchable Dropdown */
        .searchable-dropdown {
            position: relative;
            width: 100%;
        }

        .searchable-dropdown-trigger {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: white;
            cursor: pointer;
            min-height: 44px;
        }

        .searchable-dropdown-trigger:hover {
            border-color: #2c5aa0;
        }

        .searchable-dropdown.open .dropdown-arrow {
            transform: rotate(180deg);
        }

        .searchable-dropdown-content {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background-color: white;
            border: 1px solid #ddd;
            border-top: none;
            border-radius: 0 0 4px 4px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            z-index: 1000;
            display: none;
            max-height: 300px;
            overflow: hidden;
        }

        .searchable-dropdown.open .searchable-dropdown-content {
            display: block;
        }

        .search-input {
            width: 100%;
            padding: 10px 15px;
            border: none;
            border-bottom: 1px solid #e0e0e0;
            font-size: 14px;
            outline: none;
        }

        .search-input:focus {
            border-bottom-color: #2c5aa0;
        }

        .searchable-dropdown-options {
            max-height: 240px;
            overflow-y: auto;
        }

        .dropdown-option {
            padding: 10px 15px;
            cursor: pointer;
            transition: background-color 0.2s ease;
            font-size: 14px;
        }

        .dropdown-option:hover {
            background-color: #f8f9fa;
        }

        .dropdown-option.hidden {
            display: none;
        }

        /* Template Filter Modal Styles */
        .filter-checkbox-label {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            cursor: pointer;
            border-radius: 4px;
            transition: background-color 0.2s ease;
        }

        .filter-checkbox-label:hover {
            background-color: #f8f9fa;
        }

        .filter-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: #2c5aa0;
        }

        .filter-checkbox-label span {
            font-size: 14px;
            color: #333;
            user-select: none;
        }

        .filter-checkbox-label input:checked + span {
            font-weight: 500;
            color: #2c5aa0;
        }

        /* Reusable Recipient Group Multi-Select Styles */
        .recipient-group-select {
            position: relative;
            width: 100%;
        }

        .recipient-group-trigger {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: white;
            cursor: pointer;
            min-height: 44px;
            transition: border-color 0.2s ease;
        }

        .recipient-group-trigger:hover {
            border-color: #2c5aa0;
        }

        .recipient-group-select.open .recipient-group-trigger {
            border-color: #2c5aa0;
        }

        .recipient-display-text {
            color: #333;
            font-size: 14px;
        }

        .recipient-display-text.placeholder {
            color: #999;
        }

        .recipient-dropdown-arrow {
            transition: transform 0.2s ease;
            color: #666;
            font-size: 12px;
        }

        .recipient-group-select.open .recipient-dropdown-arrow {
            transform: rotate(180deg);
        }

        .recipient-group-options {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background-color: white;
            border: 1px solid #ddd;
            border-top: none;
            border-radius: 0 0 4px 4px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            z-index: 1000;
            display: none;
            max-height: 200px;
            overflow-y: auto;
        }

        .recipient-group-select.open .recipient-group-options {
            display: block;
        }

        .recipient-option {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .recipient-option:hover {
            background-color: #f8f9fa;
        }

        .recipient-option input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: #2c5aa0;
            margin-right: 10px;
        }

        .recipient-option label {
            cursor: pointer;
            font-size: 14px;
            color: #333;
            user-select: none;
            flex: 1;
        }

        .recipient-option input:checked + label {
            font-weight: 500;
            color: #2c5aa0;
        }

        /* Auto-Triggered External Layout Styles */
        .auto-priority-section {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 24px;
            padding: 16px;
            background-color: #f8f9fa;
            border-radius: 6px;
        }

        .auto-priority-label {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
            font-weight: 500;
            color: #333;
        }

        .auto-priority-channels {
            display: flex;
            align-items: center;
            gap: 16px;
            flex: 1;
        }

        .auto-channel-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .auto-channel-group label {
            font-size: 14px;
            color: #666;
            min-width: 50px;
        }

        .auto-channel-group select {
            padding: 6px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            background-color: white;
            cursor: pointer;
            min-width: 120px;
        }

        /* New Frame-based Layout */
        .auto-channels-container {
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }

        .auto-channel-frame {
            flex: 1;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            background-color: #fafafa;
        }

        .auto-channel-frame-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 2px solid #e0e0e0;
        }

        .auto-channel-frame-header label {
            font-size: 15px;
            font-weight: 600;
            color: #333;
            min-width: auto;
        }

        .auto-channel-frame-header select {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            background-color: white;
            cursor: pointer;
        }

        .auto-channel-frame-body {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .auto-stage-section {
            background-color: white;
            border-radius: 6px;
            padding: 12px;
            border: 1px solid #e9ecef;
        }

        .auto-stage-section-header {
            background-color: #e3f2fd;
            color: #2c5aa0;
            font-weight: 600;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 13px;
            margin-bottom: 12px;
        }

        .auto-stage-row {
            margin-bottom: 12px;
        }

        .auto-stage-row:last-child {
            margin-bottom: 0;
        }

        .auto-stage-row-label {
            font-size: 13px;
            color: #555;
            margin-bottom: 6px;
            font-weight: 500;
        }

        .auto-stage-row-label.indent {
            padding-left: 16px;
            font-size: 12px;
            color: #666;
        }

        .auto-template-select select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
            background-color: white;
            cursor: pointer;
        }

        .auto-template-select select:focus {
            outline: none;
            border-color: #2c5aa0;
        }

        .auto-stage-grid {
            display: none;
        }

        .internal-layout {
            display: block;
        }

        .external-layout {
            display: none;
        }

        .internal-layout.hidden {
            display: none;
        }

        .external-layout.visible {
            display: block;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-left">
            <button class="menu-icon"></button>
            <div class="logo">
                <span>CLP</span>
                <div class="logo-icon"></div>
                <span></span>
            </div>
        </div>
        <div class="platform-title">E2E Outage Communication Platform</div>
        <div class="user-avatar">JD</div>
    </header>

    <!-- Main Container -->
    <div class="app-container">
        <h1 class="page-title">Notification Management</h1>
        
        <!-- Tabs -->
        <div class="tabs">
            <div class="tab active" onclick="switchTab('notifications')">Notifications</div>
            <div class="tab" onclick="switchTab('opt-out')">Opt-Out Record</div>
            <div class="tab" onclick="switchTab('history')">History</div>
        </div>

        <!-- Notifications List Section -->
        <section id="notificationsSection">
            <div class="section-header">
                <h2 class="section-title">Notifications List</h2>
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="showCreateManualNotificationModal()">Create Manual Notification</button>
                    <button class="btn btn-primary" onclick="showCreateAutoModal()">Create Auto-Triggered Notification</button>
                </div>
            </div>

            <!-- Main Content -->
            <main class="main-content">
                <!-- Filter -->
                <div class="filter-section">
                    <select class="filter-dropdown" id="statusFilter" onchange="filterNotifications()">
                        <option value="">All Statuses</option>
                        <option value="Draft">Draft</option>
                        <option value="Sent">Sent</option>
                        <option value="Completed">Completed</option>
                    </select>
                </div>

                <!-- Notification Table -->
                <div class="notification-table">
                    <table>
                        <thead>
                            <tr>
                                <th>Subject Line</th>
                                <th>Channel</th>
                                <th>Recipient Group</th>
                                <th>Creation Method</th>
                                <th>Status</th>
                                <th>Last Updated</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="notificationTableBody">
                            <tr>
                                <td>1st Notification</td>
                                <td>SMS</td>
                                <td>Internal</td>
                                <td>Manual</td>
                                <td><span class="status-badge status-draft">Draft</span></td>
                                <td>2025-08-11 13:41:30</td>
                                <td>
                                    <div class="table-actions">
                                        <button class="action-btn" onclick="previewNotification('notif-1')" title="Preview Notification"></button>
                                        <button class="action-btn" onclick="editNotification('notif-1')" title="Edit Notification"></button>
                                        <button class="action-btn" onclick="deleteNotification('notif-1')" title="Delete Notification"></button>
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <td>1st Notification</td>
                                <td>Email</td>
                                <td>Internal</td>
                                <td>Manual</td>
                                <td><span class="status-badge status-sent">Sent</span></td>
                                <td>2025-08-11 13:41:30</td>
                                <td>
                                    <div class="table-actions">
                                        <button class="action-btn" onclick="previewNotification('notif-2')" title="Preview Notification"></button>
                                        <button class="action-btn" disabled title="Cannot edit sent notification"></button>
                                        <button class="action-btn" disabled title="Cannot delete sent notification"></button>
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <td>1st Notification</td>
                                <td>TEAMS</td>
                                <td>Internal</td>
                                <td>Auto-triggered</td>
                                <td><span class="status-badge status-draft">Draft</span></td>
                                <td>2025-08-11 13:41:30</td>
                                <td>
                                    <div class="table-actions">
                                        <button class="action-btn" onclick="previewNotification('notif-3')" title="Preview Notification"></button>
                                        <button class="action-btn" onclick="editNotification('notif-3')" title="Edit Notification"></button>
                                        <button class="action-btn" onclick="deleteNotification('notif-3')" title="Delete Notification"></button>
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <td>1st Notification</td>
                                <td>TEAMS</td>
                                <td>Internal</td>
                                <td>Auto-triggered</td>
                                <td><span class="status-badge status-completed">Completed</span></td>
                                <td>2025-08-11 13:41:30</td>
                                <td>
                                    <div class="table-actions">
                                        <button class="action-btn" onclick="previewNotification('notif-4')" title="Preview Notification"></button>
                                        <button class="action-btn" disabled title="Cannot edit completed notification"></button>
                                        <button class="action-btn" disabled title="Cannot delete completed notification"></button>
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <td>1st Notification</td>
                                <td>TEAMS</td>
                                <td>Internal</td>
                                <td>Manual</td>
                                <td><span class="status-badge status-sent">Sent</span></td>
                                <td>2025-08-11 13:41:30</td>
                                <td>
                                    <div class="table-actions">
                                        <button class="action-btn" onclick="previewNotification('notif-5')" title="Preview Notification"></button>
                                        <button class="action-btn" disabled title="Cannot edit sent notification"></button>
                                        <button class="action-btn" disabled title="Cannot delete sent notification"></button>
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <td>1st Notification</td>
                                <td>TEAMS</td>
                                <td>Internal</td>
                                <td>Auto-triggered</td>
                                <td><span class="status-badge status-draft">Draft</span></td>
                                <td>2025-08-11 13:41:30</td>
                                <td>
                                    <div class="table-actions">
                                        <button class="action-btn" onclick="previewNotification('notif-6')" title="Preview Notification"></button>
                                        <button class="action-btn" onclick="editNotification('notif-6')" title="Edit Notification"></button>
                                        <button class="action-btn" onclick="deleteNotification('notif-6')" title="Delete Notification"></button>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Pagination -->
                <div class="pagination">
                    <button onclick="changePage('prev')" id="prevBtn"></button>
                    <button class="active" onclick="changePage(1)">1</button>
                    <button onclick="changePage(2)">2</button>
                    <button onclick="changePage(3)">3</button>
                    <button onclick="changePage(4)">...</button>
                    <button onclick="changePage(8)">8</button>
                    <button onclick="changePage('next')" id="nextBtn"></button>
                </div>
            </main>
        </section>

        <!-- Opt-Out Record Section -->
        <section id="optOutSection" style="display: none;">
            <div class="section-header">
                <h2 class="section-title">Opt-Out List</h2>
            </div>
            
            <!-- Opt-Out Records Table -->
            <div class="notification-table">
                <table>
                    <thead>
                        <tr>
                            <th>Customer Account</th>
                            <th>SMS</th>
                            <th>Email</th>
                            <th>App Push</th>
                        </tr>
                    </thead>
                    <tbody id="optOutTableBody">
                        <tr>
                            <td>CLP001</td>
                            <td><span class="opt-status opt-in"></span></td>
                            <td><span class="opt-status opt-out"></span></td>
                            <td><span class="opt-status opt-in"></span></td>
                        </tr>
                        <tr>
                            <td>CLP002</td>
                            <td><span class="opt-status opt-in"></span></td>
                            <td><span class="opt-status opt-out"></span></td>
                            <td><span class="opt-status opt-in"></span></td>
                        </tr>
                        <tr>
                            <td>CLP003</td>
                            <td><span class="opt-status opt-in"></span></td>
                            <td><span class="opt-status opt-out"></span></td>
                            <td><span class="opt-status opt-in"></span></td>
                        </tr>
                        <tr>
                            <td>CLP004</td>
                            <td><span class="opt-status opt-in"></span></td>
                            <td><span class="opt-status opt-out"></span></td>
                            <td><span class="opt-status opt-in"></span></td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <!-- Pagination -->
            <div class="pagination">
                <button class="page-btn" onclick="changePage('prev')"></button>
                <button class="page-btn active" onclick="changePage(1)">1</button>
                <button class="page-btn" onclick="changePage(2)">2</button>
                <button class="page-btn" onclick="changePage(3)">3</button>
                <span class="page-ellipsis">...</span>
                <button class="page-btn" onclick="changePage(8)">8</button>
                <button class="page-btn" onclick="changePage('next')"></button>
            </div>
        </section>

        <!-- History Section -->
        <section id="historySection" style="display: none;">
            <div class="section-header">
                <h2 class="section-title">Notifications History</h2>
            </div>
            
            <!-- Filters -->
            <div class="history-filters">
                <!-- Custom Date Filter -->
                <div class="date-filter-dropdown" id="dateFilterDropdown">
                    <div class="date-filter-trigger" onclick="toggleDateFilter()">
                        <span id="dateFilterDisplay">Date</span>
                        <span class="filter-icon"></span>
                    </div>
                    <div class="date-filter-content" id="dateFilterContent">
                        <div class="date-filter-layout">
                            <!-- Preset Options -->
                            <div class="date-preset-options">
                                <div class="date-preset-item" onclick="selectDatePreset('today')">Today</div>
                                <div class="date-preset-item" onclick="selectDatePreset('past7')">Past 7 days</div>
                                <div class="date-preset-item" onclick="selectDatePreset('past30')">Previous 30 days</div>
                                <div class="date-preset-item" onclick="selectDatePreset('pastYear')">Previous year</div>
                                <div class="date-preset-divider"></div>
                                <button class="date-clear-btn" onclick="clearDateFilter()">Clear filter</button>
                            </div>
                            
                            <!-- Calendar Section -->
                            <div class="date-calendar-section">
                                <div class="calendar-controls">
                                    <button class="calendar-nav-btn" onclick="previousMonth('start')">&lt;&lt;</button>
                                    <button class="calendar-nav-btn" onclick="previousMonth('start', false)">&lt;</button>
                                    <span class="calendar-month" id="startMonthDisplay">January 2025</span>
                                    <button class="calendar-nav-btn" onclick="nextMonth('start', false)">&gt;</button>
                                    <button class="calendar-nav-btn" onclick="nextMonth('start')">&gt;&gt;</button>
                                </div>
                                <div class="calendar-grid" id="startCalendar"></div>
                                
                                <div class="calendar-controls">
                                    <button class="calendar-nav-btn" onclick="previousMonth('end')">&lt;&lt;</button>
                                    <button class="calendar-nav-btn" onclick="previousMonth('end', false)">&lt;</button>
                                    <span class="calendar-month" id="endMonthDisplay">February 2025</span>
                                    <button class="calendar-nav-btn" onclick="nextMonth('end', false)">&gt;</button>
                                    <button class="calendar-nav-btn" onclick="nextMonth('end')">&gt;&gt;</button>
                                </div>
                                <div class="calendar-grid" id="endCalendar"></div>
                                
                                <div class="calendar-actions">
                                    <button class="calendar-btn calendar-cancel" onclick="cancelDateSelection()">Cancel</button>
                                    <button class="calendar-btn calendar-apply" onclick="applyDateSelection()">Apply Dates</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Multi-select Recipient Group Filter -->
                <div class="multi-select-dropdown" id="recipientGroupDropdown">
                    <div class="multi-select-trigger" onclick="event.stopPropagation(); toggleRecipientGroupDropdown();">
                        <span id="recipientGroupDisplay">Recipient group</span>
                        <span class="dropdown-arrow"></span>
                    </div>
                    <div class="multi-select-content" id="recipientGroupContent">
                        <div class="multi-select-option">
                            <label>
                                <input type="checkbox" value="Internal" onchange="updateRecipientGroupFilter()">
                                <span>Internal</span>
                            </label>
                        </div>
                        <div class="multi-select-option">
                            <label>
                                <input type="checkbox" value="External-RT" onchange="updateRecipientGroupFilter()">
                                <span>External-RT</span>
                            </label>
                        </div>
                        <div class="multi-select-option">
                            <label>
                                <input type="checkbox" value="External-NRT" onchange="updateRecipientGroupFilter()">
                                <span>External-NRT</span>
                            </label>
                        </div>
                    </div>
                </div>
                
                <input type="text" class="filter-dropdown" id="historyIncidentSearch" placeholder="Enter Incident ID to search" oninput="filterHistory()">
            </div>
            
            <!-- History Table -->
            <div class="notification-table">
                <table>
                    <thead>
                        <tr>
                            <th><input type="checkbox" id="selectAllHistory" onchange="toggleSelectAllHistory()"></th>
                            <th>Date/Time</th>
                            <th>Stage</th>
                            <th>Channel</th>
                            <th>Recipient Group</th>
                            <th>Status</th>
                            <th># of CA</th>
                            <th>Success</th>
                            <th>Failed</th>
                            <th>Success Rate</th>
                            <th>Incident ID</th>
                        </tr>
                    </thead>
                    <tbody id="historyTableBody">
                        <tr>
                            <td><input type="checkbox" class="row-checkbox"></td>
                            <td>2025-10-30<br>14:30:00</td>
                            <td>Stage 1</td>
                            <td>SMS, Email, App Push</td>
                            <td>Internal</td>
                            <td><span class="status-badge status-sent">Sent</span></td>
                            <td>3,295</td>
                            <td>3,287</td>
                            <td>8</td>
                            <td>99.8%</td>
                            <td>INT-001</td>
                        </tr>
                        <tr>
                            <td><input type="checkbox" class="row-checkbox"></td>
                            <td>2025-10-30<br>09:15:00</td>
                            <td>Stage 2</td>
                            <td>SMS, Email</td>
                            <td>External-RT</td>
                            <td><span class="status-badge status-sent">Sent</span></td>
                            <td>12,450</td>
                            <td>12,402</td>
                            <td>48</td>
                            <td>99.6%</td>
                            <td>EXT-RT-045</td>
                        </tr>
                        <tr>
                            <td><input type="checkbox" class="row-checkbox"></td>
                            <td>2025-10-29<br>16:45:00</td>
                            <td>Stage 3</td>
                            <td>SMS</td>
                            <td>External-NRT</td>
                            <td><span class="status-badge status-sent">Sent</span></td>
                            <td>8,721</td>
                            <td>8,695</td>
                            <td>26</td>
                            <td>99.7%</td>
                            <td>EXT-NRT-089</td>
                        </tr>
                        <tr>
                            <td><input type="checkbox" class="row-checkbox"></td>
                            <td>2025-10-28<br>11:20:00</td>
                            <td>Stage 1</td>
                            <td>Email, App Push</td>
                            <td>Internal</td>
                            <td><span class="status-badge status-sent">Sent</span></td>
                            <td>3,295</td>
                            <td>3,280</td>
                            <td>15</td>
                            <td>99.5%</td>
                            <td>INT-002</td>
                        </tr>
                        <tr>
                            <td><input type="checkbox" class="row-checkbox"></td>
                            <td>2025-10-27<br>08:00:00</td>
                            <td>Stage 2</td>
                            <td>SMS, Email, App Push</td>
                            <td>External-RT</td>
                            <td><span class="status-badge status-sent">Sent</span></td>
                            <td>15,680</td>
                            <td>15,589</td>
                            <td>91</td>
                            <td>99.4%</td>
                            <td>EXT-RT-046</td>
                        </tr>
                        <tr>
                            <td><input type="checkbox" class="row-checkbox"></td>
                            <td>2025-10-23<br>13:30:00</td>
                            <td>Stage 1</td>
                            <td>SMS</td>
                            <td>Internal</td>
                            <td><span class="status-badge status-sent">Sent</span></td>
                            <td>3,295</td>
                            <td>3,291</td>
                            <td>4</td>
                            <td>99.9%</td>
                            <td>INT-003</td>
                        </tr>
                        <tr>
                            <td><input type="checkbox" class="row-checkbox"></td>
                            <td>2025-10-22<br>10:15:00</td>
                            <td>Stage 3</td>
                            <td>SMS, Email</td>
                            <td>External-RT</td>
                            <td><span class="status-badge status-sent">Sent</span></td>
                            <td>14,230</td>
                            <td>14,156</td>
                            <td>74</td>
                            <td>99.5%</td>
                            <td>EXT-RT-047</td>
                        </tr>
                        <tr>
                            <td><input type="checkbox" class="row-checkbox"></td>
                            <td>2025-10-15<br>14:45:00</td>
                            <td>Stage 1</td>
                            <td>App Push</td>
                            <td>External-NRT</td>
                            <td><span class="status-badge status-sent">Sent</span></td>
                            <td>9,500</td>
                            <td>9,462</td>
                            <td>38</td>
                            <td>99.6%</td>
                            <td>EXT-NRT-090</td>
                        </tr>
                        <tr>
                            <td><input type="checkbox" class="row-checkbox"></td>
                            <td>2025-10-10<br>09:00:00</td>
                            <td>Stage 2</td>
                            <td>SMS, Email, App Push</td>
                            <td>Internal</td>
                            <td><span class="status-badge status-sent">Sent</span></td>
                            <td>3,295</td>
                            <td>3,282</td>
                            <td>13</td>
                            <td>99.6%</td>
                            <td>INT-004</td>
                        </tr>
                        <tr>
                            <td><input type="checkbox" class="row-checkbox"></td>
                            <td>2025-10-05<br>15:20:00</td>
                            <td>Stage 1</td>
                            <td>SMS, Email</td>
                            <td>External-RT</td>
                            <td><span class="status-badge status-sent">Sent</span></td>
                            <td>13,890</td>
                            <td>13,812</td>
                            <td>78</td>
                            <td>99.4%</td>
                            <td>EXT-RT-048</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <!-- Export Button -->
            <div style="margin-top: 20px;">
                <button class="btn btn-primary" onclick="exportDetailedReport()">Export Detailed Report</button>
            </div>
            
            <!-- Pagination -->
            <div class="pagination">
                <button class="page-btn" onclick="changePage('prev')"></button>
                <button class="page-btn active" onclick="changePage(1)">1</button>
                <button class="page-btn" onclick="changePage(2)">2</button>
                <button class="page-btn" onclick="changePage('next')"></button>
            </div>
        </section>
    </div>

    <!-- View Notification Modal -->
    <div id="viewNotificationModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">View Notification</h3>
                <button class="modal-close" onclick="hideViewNotificationModal()"></button>
            </div>
            <div class="modal-body">
                <div class="info-grid">
                    <div class="info-item">
                        <div class="info-label">Subject Line</div>
                        <div class="info-value" id="viewSubject">1st Notification</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Channel</div>
                        <div class="info-value" id="viewChannel">SMS</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Recipient Group</div>
                        <div class="info-value" id="viewRecipient">Internal</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Status</div>
                        <div class="info-value" id="viewStatus">Draft</div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Message Content</label>
                    <div class="message-preview" id="viewMessage">
                        [CLP] A power outage report has been received for 14:00 at Yau Ma Tei, and your unit may be affected. Our maintenance personnel are on site to carry out repairs. During this period, the emergency service hotline may be busy. If you need assistance, please visit clp.com.hk to fill out the online form to contact us. We apologize for any inconvenience caused.
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="hideViewNotificationModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Preview Auto-Triggered Notification Modal -->
    <div id="previewAutoTriggeredModal" class="modal-overlay">
        <div class="modal auto-triggered-modal">
            <div class="modal-header">
                <h3 class="modal-title">Preview of Notification</h3>
                <button class="modal-close" onclick="hidePreviewAutoTriggeredModal()"></button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label"><strong>Recipient Group</strong></label>
                    <div style="padding: 8px 12px; background-color: #f8f9fa; border-radius: 4px; margin-bottom: 20px;">
                        <span id="autoTriggeredRecipientGroup">External-RT</span>
                    </div>
                </div>

                <!-- Auto-Triggered Template Table -->
                <div class="auto-triggered-table">
                    <table>
                        <thead>
                            <tr>
                                <th style="width: 200px;"></th>
                                <th>SMS</th>
                                <th>Email</th>
                                <th>App Push</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="4" style="background-color: #e3f2fd; font-weight: 600; color: #2c5aa0; padding: 10px 16px;">Stage 1: Initial Notification</td>
                            </tr>
                            <tr>
                                <td style="font-weight: 500; padding-left: 30px;">CLP Fault</td>
                                <td><a href="#" class="template-link" onclick="previewTemplateFromSummary('stage1-clp-sms'); return false;">Power Outage - CLP Fault (SMS)</a></td>
                                <td><a href="#" class="template-link" onclick="previewTemplateFromSummary('stage1-clp-email'); return false;">Power Outage - CLP Fault (Email)</a></td>
                                <td><a href="#" class="template-link" onclick="previewTemplateFromSummary('stage1-clp-app'); return false;">Power Outage - CLP Fault (App)</a></td>
                            </tr>
                            <tr>
                                <td style="font-weight: 500; padding-left: 30px;">Unconfirmed Case</td>
                                <td><a href="#" class="template-link" onclick="previewTemplateFromSummary('stage1-unconfirmed-sms'); return false;">Power Outage - Unconfirmed (SMS)</a></td>
                                <td><a href="#" class="template-link" onclick="previewTemplateFromSummary('stage1-unconfirmed-email'); return false;">Power Outage - Unconfirmed (Email)</a></td>
                                <td><a href="#" class="template-link" onclick="previewTemplateFromSummary('stage1-unconfirmed-app'); return false;">Power Outage - Unconfirmed (App)</a></td>
                            </tr>
                            <tr>
                                <td colspan="4" style="background-color: #e3f2fd; font-weight: 600; color: #2c5aa0; padding: 10px 16px;">Stage 2: Progress Update</td>
                            </tr>
                            <tr>
                                <td style="font-weight: 500; padding-left: 30px;">CLP Fault</td>
                                <td><a href="#" class="template-link" onclick="previewTemplateFromSummary('stage2-clp-sms'); return false;">Repair In Progress - CLP (SMS)</a></td>
                                <td><a href="#" class="template-link" onclick="previewTemplateFromSummary('stage2-clp-email'); return false;">Repair In Progress - CLP (Email)</a></td>
                                <td><a href="#" class="template-link" onclick="previewTemplateFromSummary('stage2-clp-app'); return false;">Repair In Progress - CLP (App)</a></td>
                            </tr>
                            <tr>
                                <td style="font-weight: 500; padding-left: 30px;">Customer Fault</td>
                                <td><a href="#" class="template-link" onclick="previewTemplateFromSummary('stage2-customer-sms'); return false;">Customer Side Issue (SMS)</a></td>
                                <td><a href="#" class="template-link" onclick="previewTemplateFromSummary('stage2-customer-email'); return false;">Customer Side Issue (Email)</a></td>
                                <td><a href="#" class="template-link" onclick="previewTemplateFromSummary('stage2-customer-app'); return false;">Customer Side Issue (App)</a></td>
                            </tr>
                            <tr>
                                <td style="font-weight: 500; padding-left: 30px;">Unconfirmed Case</td>
                                <td><a href="#" class="template-link" onclick="previewTemplateFromSummary('stage2-unconfirmed-sms'); return false;">Investigation Ongoing (SMS)</a></td>
                                <td><a href="#" class="template-link" onclick="previewTemplateFromSummary('stage2-unconfirmed-email'); return false;">Investigation Ongoing (Email)</a></td>
                                <td><a href="#" class="template-link" onclick="previewTemplateFromSummary('stage2-unconfirmed-app'); return false;">Investigation Ongoing (App)</a></td>
                            </tr>
                            <tr>
                                <td style="font-weight: 500; padding-left: 30px;">Interim update</td>
                                <td><a href="#" class="template-link" onclick="previewTemplateFromSummary('stage2-interim-sms'); return false;">Interim Status Update (SMS)</a></td>
                                <td><a href="#" class="template-link" onclick="previewTemplateFromSummary('stage2-interim-email'); return false;">Interim Status Update (Email)</a></td>
                                <td><a href="#" class="template-link" onclick="previewTemplateFromSummary('stage2-interim-app'); return false;">Interim Status Update (App)</a></td>
                            </tr>
                            <tr>
                                <td colspan="4" style="background-color: #e3f2fd; font-weight: 600; color: #2c5aa0; padding: 10px 16px;">Stage 3: Final Notification</td>
                            </tr>
                            <tr>
                                <td style="font-weight: 500; padding-left: 30px;">Restoration Completion</td>
                                <td><a href="#" class="template-link" onclick="previewTemplateFromSummary('stage3-completion-sms'); return false;">Power Restored (SMS)</a></td>
                                <td><a href="#" class="template-link" onclick="previewTemplateFromSummary('stage3-completion-email'); return false;">Power Restored (Email)</a></td>
                                <td><a href="#" class="template-link" onclick="previewTemplateFromSummary('stage3-completion-app'); return false;">Power Restored (App)</a></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="hidePreviewAutoTriggeredModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Preview Notification Modal -->
    <div id="previewNotificationModal" class="modal-overlay">
        <div class="modal preview-modal">
            <div class="modal-header">
                <h3 class="modal-title">Preview of Message Notification</h3>
                <button class="modal-close" onclick="hidePreviewNotificationModal()"></button>
            </div>
            <div class="modal-body">
                <!-- Template Info -->
                <div class="template-info">
                    <div class="template-info-item">
                        <div class="template-info-label">Template Name</div>
                        <div class="template-info-value" id="previewTemplateName">1st Notification</div>
                    </div>
                    <div class="template-info-item">
                        <div class="template-info-label">Channel</div>
                        <div class="template-info-value" id="previewChannel">TEAMS</div>
                    </div>
                    <div class="template-info-item">
                        <div class="template-info-label">Recipient Group</div>
                        <div class="template-info-value" id="previewRecipientGroup">Internal</div>
                    </div>
                </div>

                <!-- Language Tabs -->
                <div class="language-tabs">
                    <button class="language-tab active" onclick="switchPreviewLanguage('english')">English</button>
                    <button class="language-tab" onclick="switchPreviewLanguage('chinese')">Chinese</button>
                </div>

                <!-- English Preview Content -->
                <div id="englishPreviewContent" class="preview-content active">
                    <div id="englishRegularPreview">
                        <h4 style="font-size: 16px; color: #333; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid #e9ecef;">Message Content</h4>
                        <div class="weather-content" id="englishContentPreview">
                            [CLP] A power outage report has been received for 14:00 at Yau Ma Tei, and your unit may be affected. Our maintenance personnel are on site to carry out repairs. During this period, the emergency service hotline may be busy. If you need assistance, please visit clp.com.hk to fill out the online form to contact us. We apologize for any inconvenience caused.
                        </div>
                    </div>

                    <!-- Email Preview for English -->
                    <div id="englishEmailPreview" style="display: none;">
                        <h4 style="font-size: 16px; color: #333; margin-bottom: 16px;">Email Preview</h4>
                        <div class="email-preview-container">
                            <div class="email-header-section">
                                <div class="email-subject-line" id="englishEmailSubject">Power Outage Notification</div>
                                <div class="email-metadata">
                                    <div class="email-from">
                                        <span class="email-label">From:</span>
                                        <span class="email-meta-text">CLP Power Hong Kong Limited</span>
                                    </div>
                                </div>
                                <div class="email-details">
                                    <div class="email-detail-row">
                                        <span class="email-detail-label">To:</span>
                                        <span class="email-detail-value">customer@example.com</span>
                                    </div>
                                    <div class="email-detail-row">
                                        <span class="email-detail-label">Sent:</span>
                                        <span class="email-detail-value">January 15, 2025 2:30 PM</span>
                                    </div>
                                </div>
                            </div>
                            <div class="email-body-section">
                                <div class="email-body-content" id="englishEmailContentPreview">
                                    [CLP] A power outage report has been received for 14:00 at Yau Ma Tei, and your unit may be affected. Our maintenance personnel are on site to carry out repairs. During this period, the emergency service hotline may be busy. If you need assistance, please visit clp.com.hk to fill out the online form to contact us. We apologize for any inconvenience caused.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Chinese Preview Content -->
                <div id="chinesePreviewContent" class="preview-content">
                    <div id="chineseRegularPreview">
                        <h4 style="font-size: 16px; color: #333; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid #e9ecef;"></h4>
                        <div class="weather-content" id="chineseContentPreview">
                            [] 14:00clp.com.hk
                        </div>
                    </div>

                    <!-- Email Preview for Chinese -->
                    <div id="chineseEmailPreview" style="display: none;">
                        <h4 style="font-size: 16px; color: #333; margin-bottom: 16px;"></h4>
                        <div class="email-preview-container">
                            <div class="email-header-section">
                                <div class="email-subject-line" id="chineseEmailSubject"></div>
                                <div class="email-metadata">
                                    <div class="email-from">
                                        <span class="email-label">:</span>
                                        <span class="email-meta-text"></span>
                                    </div>
                                </div>
                                <div class="email-details">
                                    <div class="email-detail-row">
                                        <span class="email-detail-label">:</span>
                                        <span class="email-detail-value">customer@example.com</span>
                                    </div>
                                    <div class="email-detail-row">
                                        <span class="email-detail-label">:</span>
                                        <span class="email-detail-value">2025115 2:30</span>
                                    </div>
                                </div>
                            </div>
                            <div class="email-body-section">
                                <div class="email-body-content" id="chineseEmailContentPreview">
                                    [] 14:00clp.com.hk
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Manual Notification Modal -->
    <div id="createManualNotificationModal" class="modal-overlay">
        <div class="modal create-notification-modal">
            <div class="modal-header">
                <h3 class="modal-title" id="manualNotificationModalTitle">Create Manual Notification</h3>
                <button class="modal-close" onclick="hideCreateManualNotificationModal()"></button>
            </div>
            <div class="modal-body">
                <div class="create-notification-container">
                    <!-- Form Section -->
                    <div class="notification-form-section">
                        <form id="createManualNotificationForm">
                            <!-- Top Row: Power Incident, Recipient Group, Channel -->
                            <div class="form-row" style="margin-bottom: 20px;">
                                <div class="form-group">
                                    <label class="form-label">Power Incident<span class="required">*</span></label>
                                    <div class="searchable-dropdown" id="powerIncidentDropdown">
                                        <div class="searchable-dropdown-trigger" onclick="toggleSearchableDropdown('powerIncident')">
                                            <span id="powerIncidentDisplay">Select Incident ID</span>
                                            <span class="dropdown-arrow"></span>
                                        </div>
                                        <div class="searchable-dropdown-content" id="powerIncidentContent">
                                            <input type="text" class="search-input" id="powerIncidentSearch" placeholder="Search incident" onkeyup="filterPowerIncidents()">
                                            <div class="searchable-dropdown-options" id="powerIncidentOptions">
                                                <div class="dropdown-option" onclick="selectPowerIncident('Incident-001', 'Incident-001')">Incident-001</div>
                                                <div class="dropdown-option" onclick="selectPowerIncident('Incident-010', 'Incident-010')">Incident-010</div>
                                                <div class="dropdown-option" onclick="selectPowerIncident('Incident-011', 'Incident-011')">Incident-011</div>
                                                <div class="dropdown-option" onclick="selectPowerIncident('Incident-101', 'Incident-101')">Incident-101</div>
                                                <div class="dropdown-option" onclick="selectPowerIncident('INC-2024-001', 'INC-2024-001 - Yau Ma Tei Power Outage')">INC-2024-001 - Yau Ma Tei Power Outage</div>
                                                <div class="dropdown-option" onclick="selectPowerIncident('INC-2024-002', 'INC-2024-002 - Tsim Sha Tsui Substation')">INC-2024-002 - Tsim Sha Tsui Substation</div>
                                                <div class="dropdown-option" onclick="selectPowerIncident('INC-2024-003', 'INC-2024-003 - Causeway Bay Circuit')">INC-2024-003 - Causeway Bay Circuit</div>
                                                <div class="dropdown-option" onclick="selectPowerIncident('INC-2024-015', 'INC-2024-015 - Mong Kok Area')">INC-2024-015 - Mong Kok Area</div>
                                                <div class="dropdown-option" onclick="selectPowerIncident('INC-2024-025', 'INC-2024-025 - Central District')">INC-2024-025 - Central District</div>
                                                <div class="dropdown-option" onclick="selectPowerIncident('INC-2024-050', 'INC-2024-050 - Kwun Tong Industrial')">INC-2024-050 - Kwun Tong Industrial</div>
                                            </div>
                                        </div>
                                    </div>
                                    <input type="hidden" id="manualPowerIncident" value="">
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Recipient Group<span class="required">*</span></label>
                                    <div class="recipient-group-select" id="manualRecipientGroupSelect">
                                        <div class="recipient-group-trigger" onclick="toggleManualRecipientGroupDropdown('manualRecipientGroupSelect')">
                                            <span class="recipient-display-text placeholder" id="manualRecipientDisplay">Select</span>
                                            <span class="recipient-dropdown-arrow"></span>
                                        </div>
                                        <div class="recipient-group-options">
                                            <div class="recipient-option">
                                                <input type="checkbox" id="manualInternal" value="Internal" onchange="updateManualRecipientSelection()">
                                                <label for="manualInternal">Internal</label>
                                            </div>
                                            <div class="recipient-option">
                                                <input type="checkbox" id="manualExternalRT" value="External-RT" onchange="updateManualRecipientSelection()">
                                                <label for="manualExternalRT">External-RT</label>
                                            </div>
                                            <div class="recipient-option">
                                                <input type="checkbox" id="manualExternalNRT" value="External-NRT" onchange="updateManualRecipientSelection()">
                                                <label for="manualExternalNRT">External-NRT</label>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Channel<span class="required">*</span></label>
                                    <select class="form-select" id="manualNotificationChannel" onchange="handleManualChannelChange()" required>
                                        <option value="">Select</option>
                                    </select>
                                </div>
                            </div>

                            <!-- Apply existing template toggle with Language Tabs -->
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <label class="form-label" style="margin-bottom: 0;">Apply existing template</label>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="applyTemplateToggle" onchange="toggleTemplateSelection()">
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                                <div class="inline-language-tabs">
                                    <button type="button" class="inline-language-tab active" onclick="switchManualLanguageTab('english')" id="manualEnglishInlineTab">English</button>
                                    <button type="button" class="inline-language-tab" onclick="switchManualLanguageTab('chinese')" id="manualChineseInlineTab">Chinese</button>
                                </div>
                            </div>

                            <!-- Template Selection (hidden by default) -->
                            <div id="templateSelectionRow" style="display: none; margin-bottom: 20px;">
                                <div style="display: flex; gap: 10px; align-items: flex-end;">
                                    <div style="flex: 1;">
                                        <select class="form-select" id="templateSelect">
                                            <option value="">Predefined template name</option>
                                            <option value="template1" data-recipient="Internal" data-channel="Teams">Power Outage - CLP Fault (Internal - Teams)</option>
                                            <option value="template2" data-recipient="Internal" data-channel="Email">Power Outage - Unconfirmed (Internal - Email)</option>
                                            <option value="template3" data-recipient="Internal" data-channel="Teams">Repair In Progress (Internal - Teams)</option>
                                            <option value="template4" data-recipient="External-RT" data-channel="SMS">Emergency Alert - RT (External-RT - SMS)</option>
                                            <option value="template5" data-recipient="External-RT" data-channel="Email">Service Interruption (External-RT - Email)</option>
                                            <option value="template6" data-recipient="External-RT" data-channel="App Push">Outage Update (External-RT - App Push)</option>
                                            <option value="template7" data-recipient="External-NRT" data-channel="Email">Planned Maintenance (External-NRT - Email)</option>
                                            <option value="template8" data-recipient="External-NRT" data-channel="SMS">Service Advisory (External-NRT - SMS)</option>
                                            <option value="template9" data-recipient="Internal" data-channel="Email">Internal Update - Critical (Internal - Email)</option>
                                            <option value="template10" data-recipient="External-RT" data-channel="SMS">Power Restored (External-RT - SMS)</option>
                                        </select>
                                    </div>
                                    <button type="button" class="btn btn-secondary" style="padding: 10px 20px;" onclick="showTemplateFilterModal()">
                                        <span style="font-size: 16px;"></span>
                                    </button>
                                </div>
                            </div>

                            <!-- Subject Line -->
                            <div class="form-group" id="manualSubjectLineGroup">
                                <label class="form-label">Subject Line<span class="required">*</span></label>
                                <input type="text" class="form-input" id="manualSubjectLine" placeholder="Enter Subject Line" required>
                            </div>

                            <!-- Message Body -->
                            <div class="form-group">
                                <label class="form-label">Message</label>
                                
                                <!-- English Message -->
                                <div class="message-input-container active" id="manualEnglishContainer">
                                    <textarea class="form-textarea message-textarea" id="manualEnglishContent" 
                                        placeholder="Enter your message template..."></textarea>
                                    <div class="char-counter"><span id="manualEnglishCount">0</span></div>
                                </div>
                                
                                <!-- Chinese Message -->
                                <div class="message-input-container" id="manualChineseContainer">
                                    <textarea class="form-textarea message-textarea" id="manualChineseContent" 
                                        placeholder=""></textarea>
                                    <div class="char-counter"><span id="manualChineseCount">0</span></div>
                                </div>
                            </div>
                        </form>
                    </div>

                    <!-- Variables Section -->
                    <div class="variables-section">
                        <h4>Available Variables</h4>
                        <p class="variables-help">Drag a variable to insert it at the cursor position</p>
                        <div class="variables-grid">
                            <div class="variable-item" draggable="true" data-variable="{{outage_location}}">
                                <span class="variable-name">Outage Location</span>
                            </div>
                            <div class="variable-item" draggable="true" data-variable="{{outage_region}}">
                                <span class="variable-name">Outage Region</span>
                            </div>
                            <div class="variable-item" draggable="true" data-variable="{{incident_id}}">
                                <span class="variable-name">Incident ID</span>
                            </div>
                            <div class="variable-item" draggable="true" data-variable="{{start_datetime}}">
                                <span class="variable-name">Start Date & Time</span>
                            </div>
                            <div class="variable-item" draggable="true" data-variable="{{estimated_restoration}}">
                                <span class="variable-name">Estimated time of Restoration (ERT)</span>
                            </div>
                            <div class="variable-item" draggable="true" data-variable="{{actual_arrival}}">
                                <span class="variable-name">Actual Time of Arrival (ATA)</span>
                            </div>
                            <div class="variable-item" draggable="true" data-variable="{{affected_customers}}">
                                <span class="variable-name">Affected Customers Count</span>
                            </div>
                            <div class="variable-item" draggable="true" data-variable="{{outage_details_url}}">
                                <span class="variable-name">URL to the details of the outage (URL)</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="hideCreateManualNotificationModal()">Cancel</button>
                <button class="btn btn-secondary" onclick="saveManualNotificationDraft()" style="background-color: #6c757d;">Save Draft</button>
                <button class="btn btn-primary" onclick="createManualNotification()">Send</button>
            </div>
        </div>
    </div>

    <!-- Template Filtering Modal -->
    <div id="templateFilterModal" class="modal-overlay" style="display: none;">
        <div class="modal" style="max-width: 500px;">
            <div class="modal-header">
                <h3 class="modal-title">Template Filtering</h3>
                <button class="modal-close" onclick="hideTemplateFilterModal()"></button>
            </div>
            <div class="modal-body">
                <div style="display: flex; gap: 20px;">
                    <!-- Recipient Group Column -->
                    <div style="flex: 1;">
                        <h4 style="font-size: 14px; font-weight: 600; margin-bottom: 12px; color: #333;">Recipient Group</h4>
                        <div style="display: flex; flex-direction: column; gap: 8px;">
                            <label class="filter-checkbox-label">
                                <input type="checkbox" class="filter-checkbox" name="filterRecipientGroup" value="Internal" onchange="updateTemplateFilterUI()">
                                <span>Internal</span>
                            </label>
                            <label class="filter-checkbox-label">
                                <input type="checkbox" class="filter-checkbox" name="filterRecipientGroup" value="External-RT" onchange="updateTemplateFilterUI()">
                                <span>External-RT</span>
                            </label>
                            <label class="filter-checkbox-label">
                                <input type="checkbox" class="filter-checkbox" name="filterRecipientGroup" value="External-NRT" onchange="updateTemplateFilterUI()">
                                <span>External-NRT</span>
                            </label>
                        </div>
                    </div>
                    
                    <!-- Channel Column -->
                    <div style="flex: 1;">
                        <h4 style="font-size: 14px; font-weight: 600; margin-bottom: 12px; color: #333;">Channel</h4>
                        <div style="display: flex; flex-direction: column; gap: 8px;">
                            <label class="filter-checkbox-label">
                                <input type="checkbox" class="filter-checkbox" name="filterChannel" value="Teams" onchange="updateTemplateFilterUI()">
                                <span>Teams</span>
                            </label>
                            <label class="filter-checkbox-label">
                                <input type="checkbox" class="filter-checkbox" name="filterChannel" value="Email" onchange="updateTemplateFilterUI()">
                                <span>Email</span>
                            </label>
                            <label class="filter-checkbox-label">
                                <input type="checkbox" class="filter-checkbox" name="filterChannel" value="SMS" onchange="updateTemplateFilterUI()">
                                <span>SMS</span>
                            </label>
                            <label class="filter-checkbox-label">
                                <input type="checkbox" class="filter-checkbox" name="filterChannel" value="App Push" onchange="updateTemplateFilterUI()">
                                <span>App Push</span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer" style="justify-content: flex-end;">
                <button class="btn btn-primary" onclick="applyTemplateFilter()">Apply</button>
            </div>
        </div>
    </div>

    <!-- Create Auto-Triggered Notification Modal -->
    <div id="createAutoTriggeredModal" class="modal-overlay" style="display: none;">
        <div class="modal" style="max-width: 1000px; width: 95%;">
            <div class="modal-header">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <button onclick="hideCreateAutoTriggeredModal()" style="background: none; border: none; cursor: pointer; font-size: 20px; color: #666;"></button>
                    <h3 class="modal-title" id="autoTriggeredModalTitle">Create Auto-triggered Notification</h3>
                </div>
                <button class="modal-close" onclick="hideCreateAutoTriggeredModal()"></button>
            </div>
            <div class="modal-body" style="padding: 32px 48px;">
                <!-- Progress Indicator -->
                <div style="display: flex; align-items: center; justify-content: flex-start; margin-bottom: 40px;">
                    <div style="display: flex; align-items: center; gap: 16px;">
                        <div style="display: flex; flex-direction: column; align-items: center;">
                            <div id="step1Circle" style="width: 40px; height: 40px; border-radius: 50%; background-color: #2c5aa0; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 16px;">1</div>
                            <div id="step1Label" style="margin-top: 8px; font-size: 13px; color: #2c5aa0; font-weight: 500;">Template Selection</div>
                        </div>
                        <div style="width: 120px; height: 2px; background-color: #e0e0e0; margin-bottom: 20px;"></div>
                        <div style="display: flex; flex-direction: column; align-items: center;">
                            <div id="step2Circle" style="width: 40px; height: 40px; border-radius: 50%; background-color: #e0e0e0; display: flex; align-items: center; justify-content: center; color: #999; font-weight: 600; font-size: 16px;">2</div>
                            <div id="step2Label" style="margin-top: 8px; font-size: 13px; color: #999;">Logics</div>
                        </div>
                    </div>
                </div>

                <!-- Step 1: Template Selection -->
                <div id="step1Content" style="display: block;">
                    <!-- Recipient Group -->
                    <div class="form-group">
                        <label class="form-label">Recipient Group<span class="required">*</span></label>
                        <div class="recipient-group-select" id="autoRecipientGroupSelect">
                            <div class="recipient-group-trigger" onclick="toggleRecipientGroupDropdown('autoRecipientGroupSelect')">
                                <span class="recipient-display-text placeholder" id="autoRecipientDisplay">Select</span>
                                <span class="recipient-dropdown-arrow"></span>
                            </div>
                            <div class="recipient-group-options">
                                <div class="recipient-option">
                                    <input type="checkbox" id="autoInternal" value="Internal" onchange="updateAutoRecipientSelection()">
                                    <label for="autoInternal">Internal</label>
                                </div>
                                <div class="recipient-option">
                                    <input type="checkbox" id="autoExternalRT" value="External-RT" onchange="updateAutoRecipientSelection()">
                                    <label for="autoExternalRT">External-RT</label>
                                </div>
                                <div class="recipient-option">
                                    <input type="checkbox" id="autoExternalNRT" value="External-NRT" onchange="updateAutoRecipientSelection()">
                                    <label for="autoExternalNRT">External-NRT</label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Subject Line -->
                    <div class="form-group">
                        <label class="form-label">Subject Line<span class="required">*</span></label>
                        <input type="text" class="form-input" id="autoSubjectLine" placeholder="Enter Subject Line" required>
                    </div>

                    <!-- Internal Layout (Simple Single Column) -->
                    <div id="internalLayout" class="internal-layout" style="display: none;">
                        <!-- Stage 1: Initial Notification -->
                        <div class="form-group">
                            <label class="form-label">Stage 1: Initial Notification</label>
                            <select class="form-select" id="autoStage1Template">
                                <option value="">Select template name</option>
                            </select>
                        </div>

                        <!-- Stage 2: Progress Update -->
                        <div class="form-group">
                            <label class="form-label">Stage 2: Progress Update</label>
                            <select class="form-select" id="autoStage2Template">
                                <option value="">Select template name</option>
                            </select>
                        </div>

                        <!-- Stage 2.1: Interim Update (Indented) -->
                        <div class="form-group" style="margin-left: 40px;">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                <input type="checkbox" id="enableStage2_1" style="width: 18px; height: 18px; cursor: pointer;">
                                <label class="form-label" style="margin: 0;">2.1: interim update</label>
                            </div>
                            <select class="form-select" id="autoStage2_1Template" disabled>
                                <option value="">Select template name</option>
                            </select>
                        </div>

                        <!-- Stage 3: Final Notification -->
                        <div class="form-group">
                            <label class="form-label">Stage 3: Final Notification</label>
                            <select class="form-select" id="autoStage3Template">
                                <option value="">Select template name</option>
                            </select>
                        </div>
                    </div>

                    <!-- External Layout (3-Frame Structure) -->
                    <div id="externalLayout" class="external-layout" style="display: none;">
                        <!-- Priority of Channel Toggle -->
                        <div class="auto-priority-section">
                            <div class="auto-priority-label">
                                <span>Priority of Channel</span>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="autoPriorityToggle" checked onchange="toggleAutoPriority()">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>

                        <!-- 3 Channel Frames -->
                        <div class="auto-channels-container">
                            <!-- First Channel Frame -->
                            <div class="auto-channel-frame">
                                <div class="auto-channel-frame-header">
                                    <label>First</label>
                                    <select id="autoFirstChannel" onchange="updateChannelFrameLabels()">
                                        <option value="SMS">SMS</option>
                                        <option value="Email">Email</option>
                                        <option value="App Push">App Push</option>
                                    </select>
                                </div>
                                <div class="auto-channel-frame-body">
                                    <!-- Stage 1 -->
                                    <div class="auto-stage-section">
                                        <div class="auto-stage-section-header">Stage 1: Initial Notification</div>
                                        <div class="auto-stage-row">
                                            <div class="auto-stage-row-label">CLP Fault</div>
                                            <div class="auto-template-select">
                                                <select id="autoExtStage1_1_First">
                                                    <option value="">Select template name</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="auto-stage-row">
                                            <div class="auto-stage-row-label">Unconfirmed Case</div>
                                            <div class="auto-template-select">
                                                <select id="autoExtStage1_2_First">
                                                    <option value="">Select template name</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Stage 2 -->
                                    <div class="auto-stage-section">
                                        <div class="auto-stage-section-header">Stage 2: Progress Update</div>
                                        <div class="auto-stage-row">
                                            <div class="auto-stage-row-label">CLP Fault</div>
                                            <div class="auto-template-select">
                                                <select id="autoExtStage2_1_First">
                                                    <option value="">Select template name</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="auto-stage-row">
                                            <div class="auto-stage-row-label">Customer Fault</div>
                                            <div class="auto-template-select">
                                                <select id="autoExtStage2_2_First">
                                                    <option value="">Select template name</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="auto-stage-row">
                                            <div class="auto-stage-row-label">Unconfirmed Case</div>
                                            <div class="auto-template-select">
                                                <select id="autoExtStage2_3_First">
                                                    <option value="">Select template name</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="auto-stage-row">
                                            <div class="auto-stage-row-label indent">Interim update</div>
                                            <div class="auto-template-select">
                                                <select id="autoExtStage2_4_First">
                                                    <option value="">Select template name</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Stage 3 -->
                                    <div class="auto-stage-section">
                                        <div class="auto-stage-section-header">Stage 3: Final Notification</div>
                                        <div class="auto-stage-row">
                                            <div class="auto-stage-row-label">Restoration Completion</div>
                                            <div class="auto-template-select">
                                                <select id="autoExtStage3_1_First">
                                                    <option value="">Select template name</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Second Channel Frame -->
                            <div class="auto-channel-frame">
                                <div class="auto-channel-frame-header">
                                    <label>Second</label>
                                    <select id="autoSecondChannel" onchange="updateChannelFrameLabels()">
                                        <option value="Email">Email</option>
                                        <option value="SMS">SMS</option>
                                        <option value="App Push">App Push</option>
                                    </select>
                                </div>
                                <div class="auto-channel-frame-body">
                                    <!-- Stage 1 -->
                                    <div class="auto-stage-section">
                                        <div class="auto-stage-section-header">Stage 1: Initial Notification</div>
                                        <div class="auto-stage-row">
                                            <div class="auto-stage-row-label">CLP Fault</div>
                                            <div class="auto-template-select">
                                                <select id="autoExtStage1_1_Second">
                                                    <option value="">Select template name</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="auto-stage-row">
                                            <div class="auto-stage-row-label">Unconfirmed Case</div>
                                            <div class="auto-template-select">
                                                <select id="autoExtStage1_2_Second">
                                                    <option value="">Select template name</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Stage 2 -->
                                    <div class="auto-stage-section">
                                        <div class="auto-stage-section-header">Stage 2: Progress Update</div>
                                        <div class="auto-stage-row">
                                            <div class="auto-stage-row-label">CLP Fault</div>
                                            <div class="auto-template-select">
                                                <select id="autoExtStage2_1_Second">
                                                    <option value="">Select template name</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="auto-stage-row">
                                            <div class="auto-stage-row-label">Customer Fault</div>
                                            <div class="auto-template-select">
                                                <select id="autoExtStage2_2_Second">
                                                    <option value="">Select template name</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="auto-stage-row">
                                            <div class="auto-stage-row-label">Unconfirmed Case</div>
                                            <div class="auto-template-select">
                                                <select id="autoExtStage2_3_Second">
                                                    <option value="">Select template name</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="auto-stage-row">
                                            <div class="auto-stage-row-label indent">Interim update</div>
                                            <div class="auto-template-select">
                                                <select id="autoExtStage2_4_Second">
                                                    <option value="">Select template name</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Stage 3 -->
                                    <div class="auto-stage-section">
                                        <div class="auto-stage-section-header">Stage 3: Final Notification</div>
                                        <div class="auto-stage-row">
                                            <div class="auto-stage-row-label">Restoration Completion</div>
                                            <div class="auto-template-select">
                                                <select id="autoExtStage3_1_Second">
                                                    <option value="">Select template name</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Third Channel Frame -->
                            <div class="auto-channel-frame">
                                <div class="auto-channel-frame-header">
                                    <label>Third</label>
                                    <select id="autoThirdChannel" onchange="updateChannelFrameLabels()">
                                        <option value="App Push">App Push</option>
                                        <option value="SMS">SMS</option>
                                        <option value="Email">Email</option>
                                    </select>
                                </div>
                                <div class="auto-channel-frame-body">
                                    <!-- Stage 1 -->
                                    <div class="auto-stage-section">
                                        <div class="auto-stage-section-header">Stage 1: Initial Notification</div>
                                        <div class="auto-stage-row">
                                            <div class="auto-stage-row-label">CLP Fault</div>
                                            <div class="auto-template-select">
                                                <select id="autoExtStage1_1_Third">
                                                    <option value="">Select template name</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="auto-stage-row">
                                            <div class="auto-stage-row-label">Unconfirmed Case</div>
                                            <div class="auto-template-select">
                                                <select id="autoExtStage1_2_Third">
                                                    <option value="">Select template name</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Stage 2 -->
                                    <div class="auto-stage-section">
                                        <div class="auto-stage-section-header">Stage 2: Progress Update</div>
                                        <div class="auto-stage-row">
                                            <div class="auto-stage-row-label">CLP Fault</div>
                                            <div class="auto-template-select">
                                                <select id="autoExtStage2_1_Third">
                                                    <option value="">Select template name</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="auto-stage-row">
                                            <div class="auto-stage-row-label">Customer Fault</div>
                                            <div class="auto-template-select">
                                                <select id="autoExtStage2_2_Third">
                                                    <option value="">Select template name</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="auto-stage-row">
                                            <div class="auto-stage-row-label">Unconfirmed Case</div>
                                            <div class="auto-template-select">
                                                <select id="autoExtStage2_3_Third">
                                                    <option value="">Select template name</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="auto-stage-row">
                                            <div class="auto-stage-row-label indent">Interim update</div>
                                            <div class="auto-template-select">
                                                <select id="autoExtStage2_4_Third">
                                                    <option value="">Select template name</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Stage 3 -->
                                    <div class="auto-stage-section">
                                        <div class="auto-stage-section-header">Stage 3: Final Notification</div>
                                        <div class="auto-stage-row">
                                            <div class="auto-stage-row-label">Restoration Completion</div>
                                            <div class="auto-template-select">
                                                <select id="autoExtStage3_1_Third">
                                                    <option value="">Select template name</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 2: Logics (Hidden initially) -->
                <div id="step2Content" style="display: none;">
                    <div style="padding: 20px;">
                        <!-- Stage 1 -->
                        <div class="logic-stage-container" id="logicStage1">
                            <div class="logic-stage-header">
                                <div>
                                    <h3 style="margin: 0; font-size: 18px; font-weight: 600; color: #2c5aa0;">Stage 1</h3>
                                    <div style="font-size: 13px; color: #666; margin-top: 4px;">Initial Notification</div>
                                </div>
                                <button class="btn-edit-small" onclick="toggleStageEdit('stage1')">Edit</button>
                            </div>
                            <div class="logic-stage-body" id="logicStage1Body">
                                <!-- Scenarios will be added here -->
                            </div>
                            <div class="logic-summary">
                                <strong style="color: #2c5aa0;">Logic Summary:</strong>
                                <div id="logicSummaryStage1" style="margin-top: 8px; color: #666; font-size: 13px;">No conditions configured.</div>
                            </div>
                        </div>

                        <!-- Stage 2 -->
                        <div class="logic-stage-container" id="logicStage2">
                            <div class="logic-stage-header">
                                <div>
                                    <h3 style="margin: 0; font-size: 18px; font-weight: 600; color: #2c5aa0;">Stage 2</h3>
                                    <div style="font-size: 13px; color: #666; margin-top: 4px;">Progress Update</div>
                                </div>
                                <button class="btn-edit-small" onclick="toggleStageEdit('stage2')">Edit</button>
                            </div>
                            <div class="logic-stage-body" id="logicStage2Body">
                                <!-- Scenarios will be added here -->
                            </div>
                            <div class="logic-summary">
                                <strong style="color: #2c5aa0;">Logic Summary:</strong>
                                <div id="logicSummaryStage2" style="margin-top: 8px; color: #666; font-size: 13px;">No conditions configured.</div>
                            </div>
                        </div>

                        <!-- Stage 3 -->
                        <div class="logic-stage-container" id="logicStage3">
                            <div class="logic-stage-header">
                                <div>
                                    <h3 style="margin: 0; font-size: 18px; font-weight: 600; color: #2c5aa0;">Stage 3</h3>
                                    <div style="font-size: 13px; color: #666; margin-top: 4px;">Final notification</div>
                                </div>
                                <button class="btn-edit-small" onclick="toggleStageEdit('stage3')">Edit</button>
                            </div>
                            <div class="logic-stage-body" id="logicStage3Body">
                                <!-- Scenarios will be added here -->
                            </div>
                            <div class="logic-summary">
                                <strong style="color: #2c5aa0;">Logic Summary:</strong>
                                <div id="logicSummaryStage3" style="margin-top: 8px; color: #666; font-size: 13px;">No conditions configured.</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="saveAutoTriggeredDraft()" style="background-color: #6c757d;">Save</button>
                <button class="btn btn-primary" id="autoNextBtn" onclick="handleAutoStepNavigation()">Next</button>
            </div>
        </div>
    </div>

    <!-- Validation Warning Modal -->
    <div id="validationWarningModal" class="modal-overlay" style="display: none;">
        <div class="modal-container" style="max-width: 500px; background-color: white;">
            <div class="modal-header">
                <h2> Incomplete Configuration</h2>
                <button class="close-btn" onclick="hideValidationWarningModal()"></button>
            </div>
            <div class="modal-body" style="background-color: white;">
                <p style="margin-bottom: 16px; color: #666;">The following required fields are missing:</p>
                <ul id="missingFieldsList" style="margin-left: 20px; color: #d32f2f; line-height: 1.8;">
                    <!-- Missing fields will be populated here -->
                </ul>
                <p style="margin-top: 20px; color: #666;">The auto-triggered notification will be saved as <strong>Draft</strong> and it will be <strong>inactive</strong>.</p>
                <p style="margin-top: 8px; color: #666;">Please complete all fields and configure logic for all stages to activate the notification.</p>
            </div>
            <div class="modal-footer" style="background-color: white;">
                <button class="btn btn-secondary" onclick="hideValidationWarningModal()">Cancel</button>
                <button class="btn btn-primary" onclick="confirmSaveAsDraft()">Save as Draft</button>
            </div>
        </div>
    </div>

    <!-- Update Message -->
    <div id="updateMessage" class="update-message"></div>

    <script>
        // Global notification counter for unique IDs
        let notificationCounter = 7; // Starting after existing notif-6
        
        // Global edit mode tracking
        let editingNotificationId = null;
        let isEditMode = false;

        // Placeholder data for notifications
        window.notificationData = {
            'notif-1': {
                creationMethod: 'Manual',
                templateName: '1st Notification',
                channel: 'SMS',
                recipientGroup: 'Internal',
                status: 'Draft',
                powerIncident: 'INC-2025-001',
                subjectLine: '1st Notification',
                englishContent: '[CLP] A power outage report has been received for 14:00 at Yau Ma Tei, and your unit may be affected. Our maintenance personnel are on site to carry out repairs. During this period, the emergency service hotline may be busy. If you need assistance, please visit clp.com.hk to fill out the online form to contact us. We apologize for any inconvenience caused.',
                chineseContent: '[] 14:00clp.com.hk',
                lastUpdated: '2025-08-11 13:41:30'
            },
            'notif-2': {
                creationMethod: 'Manual',
                templateName: '1st Notification',
                channel: 'Email',
                recipientGroup: 'Internal',
                status: 'Sent',
                powerIncident: 'INC-2025-002',
                subjectLine: 'Power Outage Alert - Kowloon Area',
                englishContent: '[CLP] We are currently experiencing a power outage in the Kowloon area. Our technical team is working on restoring power as quickly as possible. Estimated restoration time is 3:00 PM. We apologize for the inconvenience.',
                chineseContent: '[] 3:00',
                lastUpdated: '2025-08-11 13:41:30'
            },
            'notif-3': {
                creationMethod: 'Auto-triggered',
                templateName: '1st Notification',
                channel: 'TEAMS',
                recipientGroup: 'Internal',
                status: 'Draft',
                configData: {
                    recipientGroup: 'Internal',
                    subjectLine: 'Auto Power Outage Notification',
                    templates: {
                        stage1: 'Power Outage - CLP Fault (Teams)',
                        stage2: 'Repair In Progress - CLP (Teams)',
                        stage3: 'Power Restored (Teams)'
                    }
                },
                logicConfiguration: {
                    stage1: {
                        scenarios: [{
                            id: 1,
                            name: 'Scenario 1',
                            conditions: [{
                                field: 'Outage Duration',
                                operator: '>',
                                value: '30',
                                unit: 'minutes'
                            }],
                            action: 'Send Notification'
                        }]
                    },
                    stage2: {
                        scenarios: [{
                            id: 1,
                            name: 'Scenario 1',
                            conditions: [{
                                field: 'Repair Progress',
                                operator: '=',
                                value: 'In Progress'
                            }],
                            action: 'Send Notification'
                        }]
                    },
                    stage3: {
                        scenarios: [{
                            id: 1,
                            name: 'Scenario 1',
                            conditions: [{
                                field: 'Power Status',
                                operator: '=',
                                value: 'Restored'
                            }],
                            action: 'Send Notification'
                        }]
                    }
                },
                lastUpdated: '2025-08-11 13:41:30'
            },
            'notif-4': {
                creationMethod: 'Auto-triggered',
                templateName: '1st Notification',
                channel: 'TEAMS',
                recipientGroup: 'Internal',
                status: 'Completed',
                configData: {
                    recipientGroup: 'Internal',
                    subjectLine: 'Completed Power Restoration',
                    templates: {
                        stage1: 'Power Outage - CLP Fault (Teams)',
                        stage2: 'Repair In Progress - CLP (Teams)',
                        stage3: 'Power Restored (Teams)'
                    }
                },
                lastUpdated: '2025-08-11 13:41:30'
            },
            'notif-5': {
                creationMethod: 'Manual',
                templateName: '1st Notification',
                channel: 'TEAMS',
                recipientGroup: 'Internal',
                status: 'Sent',
                powerIncident: 'INC-2025-005',
                subjectLine: 'Urgent: Power Outage Update',
                englishContent: '[CLP] Power has been restored to most affected areas. A small number of customers in Tsim Sha Tsui may still be experiencing issues. Our team is investigating. Thank you for your patience.',
                chineseContent: '[] ',
                lastUpdated: '2025-08-11 13:41:30'
            },
            'notif-6': {
                creationMethod: 'Auto-triggered',
                templateName: '1st Notification',
                channel: 'TEAMS',
                recipientGroup: 'Internal',
                status: 'Draft',
                configData: {
                    recipientGroup: 'Internal',
                    subjectLine: 'Scheduled Maintenance Alert',
                    templates: {
                        stage1: 'Power Outage - Unconfirmed (Teams)',
                        stage2: 'Investigation Ongoing (Teams)',
                        stage3: 'Power Restored (Teams)'
                    }
                },
                logicConfiguration: {
                    stage1: {
                        scenarios: []
                    },
                    stage2: {
                        scenarios: []
                    },
                    stage3: {
                        scenarios: []
                    }
                },
                lastUpdated: '2025-08-11 13:41:30'
            }
        };

        // Tab switching
        function switchTab(tab) {
            // Update tab styling
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');

            // Show/hide sections
            document.getElementById('notificationsSection').style.display = tab === 'notifications' ? 'block' : 'none';
            document.getElementById('optOutSection').style.display = tab === 'opt-out' ? 'block' : 'none';
            document.getElementById('historySection').style.display = tab === 'history' ? 'block' : 'none';
        }

        // Filter notifications
        function filterNotifications() {
            const filterValue = document.getElementById('statusFilter').value;
            const rows = document.querySelectorAll('#notificationTableBody tr');
            
            rows.forEach(row => {
                const status = row.querySelector('.status-badge').textContent;
                if (filterValue === '' || status === filterValue) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        // Pagination
        function changePage(page) {
            console.log('Navigate to page:', page);
            showUpdateMessage('Page navigation functionality would be implemented here', 'info');
        }

        // ============================================================
        // REUSABLE COMPONENT: Multi-Select Dropdown with Checkboxes
        // ============================================================
        // This is a reusable multi-select dropdown component that can be used
        // across the application. It provides:
        // - Multiple checkbox selections
        // - Display selected count
        // - Click outside to close
        // 
        // Usage:
        // 1. Copy the HTML structure (multi-select-dropdown section)
        // 2. Copy the CSS styles (Multi-Select Dropdown section)
        // 3. Copy the JavaScript functions (this section)
        // 4. Update IDs and function names if using multiple instances
        // 5. Call your filter function after selection changes
        // ============================================================

        // Multi-Select Recipient Group State
        let selectedRecipientGroups = [];

        function toggleRecipientGroupDropdown(dropdownId) {
            console.log('=== toggleRecipientGroupDropdown called ===');
            console.log('dropdownId parameter:', dropdownId);
            
            // If dropdownId is provided, use it; otherwise default to recipientGroupDropdown
            const targetId = dropdownId || 'recipientGroupDropdown';
            console.log('Target element ID:', targetId);
            
            const dropdown = document.getElementById(targetId);
            console.log('Dropdown element found:', dropdown);
            
            if (!dropdown) {
                console.error('Dropdown element not found with ID:', targetId);
                console.error('Available elements with recipient-group-select class:', 
                    document.querySelectorAll('.recipient-group-select'));
                return;
            }
            
            dropdown.classList.toggle('open');
            console.log('Dropdown classList after toggle:', dropdown.classList);
            console.log('Dropdown is now open:', dropdown.classList.contains('open'));
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById('recipientGroupDropdown');
            if (dropdown && !dropdown.contains(event.target)) {
                dropdown.classList.remove('open');
            }
        });

        function updateRecipientGroupFilter() {
            const checkboxes = document.querySelectorAll('#recipientGroupContent input[type="checkbox"]');
            selectedRecipientGroups = [];
            
            checkboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    selectedRecipientGroups.push(checkbox.value);
                }
            });
            
            // Update display text
            const display = document.getElementById('recipientGroupDisplay');
            if (!display) {
                console.error('recipientGroupDisplay element not found');
                return;
            }
            
            if (selectedRecipientGroups.length === 0) {
                display.innerHTML = 'Recipient group';
            } else if (selectedRecipientGroups.length === 1) {
                display.innerHTML = selectedRecipientGroups[0];
            } else {
                display.innerHTML = `${selectedRecipientGroups.length} selected <span class="selected-count">${selectedRecipientGroups.length}</span>`;
            }
            
            console.log('Selected recipient groups:', selectedRecipientGroups);
            
            // Apply filter
            filterHistory();
        }

        // ============================================================
        // END: Multi-Select Dropdown Component
        // ============================================================

        // ============================================================
        // REUSABLE COMPONENT: Date Filter with Calendar
        // ============================================================
        // This is a reusable date filter component that can be used across
        // the application. It provides:
        // - Preset date ranges (Today, Past 7 days, Past 30 days, Past year)
        // - Dual calendar view for custom date range selection
        // - Clear filter option
        // 
        // Usage:
        // 1. Copy the HTML structure (date-filter-dropdown section)
        // 2. Copy the CSS styles (Date Filter Dropdown section)
        // 3. Copy the JavaScript functions (this entire section)
        // 4. Update IDs if using multiple instances on the same page
        // 5. Call filterHistory() or your custom filter function after date selection
        // ============================================================

        // History Filter Functions
        // Date Filter State
        let dateFilterState = {
            startDate: null,
            endDate: null,
            startMonth: new Date(2025, 0), // January 2025
            endMonth: new Date(2025, 1),   // February 2025
            selectedPreset: null
        };

        function toggleDateFilter() {
            const dropdown = document.getElementById('dateFilterDropdown');
            dropdown.classList.toggle('open');
            
            if (dropdown.classList.contains('open')) {
                renderCalendar('start', dateFilterState.startMonth);
                renderCalendar('end', dateFilterState.endMonth);
            }
        }

        // Close date filter when clicking outside
        document.addEventListener('click', function(event) {
            const dateFilter = document.getElementById('dateFilterDropdown');
            if (dateFilter && !dateFilter.contains(event.target)) {
                dateFilter.classList.remove('open');
            }
        });

        function selectDatePreset(preset) {
            console.log('=== Select Date Preset Debug ===');
            console.log('Preset selected:', preset);
            
            // Clear previous preset selection
            document.querySelectorAll('.date-preset-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Mark selected preset
            event.target.classList.add('active');
            dateFilterState.selectedPreset = preset;
            
            const today = new Date();
            console.log('Today date object:', today);
            console.log('Today ISO:', today.toISOString());
            console.log('Today local date string:', today.toLocaleDateString());
            
            let startDate, endDate;
            
            switch(preset) {
                case 'today':
                    startDate = endDate = new Date(today);
                    console.log('TODAY preset - same start and end');
                    break;
                case 'past7':
                    endDate = new Date(today);
                    startDate = new Date(today);
                    startDate.setDate(startDate.getDate() - 7);
                    console.log('PAST 7 DAYS preset');
                    break;
                case 'past30':
                    endDate = new Date(today);
                    startDate = new Date(today);
                    startDate.setDate(startDate.getDate() - 30);
                    console.log('PAST 30 DAYS preset');
                    break;
                case 'pastYear':
                    endDate = new Date(today);
                    startDate = new Date(today);
                    startDate.setFullYear(startDate.getFullYear() - 1);
                    console.log('PAST YEAR preset');
                    break;
            }
            
            console.log('Start Date before assignment:', startDate);
            console.log('End Date before assignment:', endDate);
            
            dateFilterState.startDate = startDate;
            dateFilterState.endDate = endDate;
            
            console.log('Date filter state after assignment:', dateFilterState);
            console.log('=== End Preset Debug ===\n');
            
            // Update display
            updateDateFilterDisplay();
            
            // Apply filter and close dropdown
            filterHistory();
            document.getElementById('dateFilterDropdown').classList.remove('open');
        }

        function clearDateFilter() {
            dateFilterState.startDate = null;
            dateFilterState.endDate = null;
            dateFilterState.selectedPreset = null;
            
            // Clear preset selections
            document.querySelectorAll('.date-preset-item').forEach(item => {
                item.classList.remove('active');
            });
            
            document.getElementById('dateFilterDisplay').textContent = 'Date';
            document.getElementById('dateFilterDropdown').classList.remove('open');
            filterHistory();
        }

        function renderCalendar(type, month) {
            const calendar = document.getElementById(type + 'Calendar');
            const monthDisplay = document.getElementById(type + 'MonthDisplay');
            
            const year = month.getFullYear();
            const monthIndex = month.getMonth();
            
            // Update month display
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                              'July', 'August', 'September', 'October', 'November', 'December'];
            monthDisplay.textContent = monthNames[monthIndex] + ' ' + year;
            
            // Build calendar
            let html = '';
            
            // Day headers
            const dayHeaders = ['M', 'T', 'W', 'T', 'F', 'S', 'S'];
            dayHeaders.forEach(day => {
                html += `<div class="calendar-day-header">${day}</div>`;
            });
            
            // Get first day of month (0 = Sunday, 1 = Monday, etc.)
            const firstDay = new Date(year, monthIndex, 1).getDay();
            const daysInMonth = new Date(year, monthIndex + 1, 0).getDate();
            
            // Adjust first day (make Monday = 0)
            const adjustedFirstDay = firstDay === 0 ? 6 : firstDay - 1;
            
            // Empty cells before first day
            for (let i = 0; i < adjustedFirstDay; i++) {
                html += `<div class="calendar-day empty"></div>`;
            }
            
            // Days of month
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, monthIndex, day);
                const dateStr = date.toISOString().split('T')[0];
                let classes = 'calendar-day';
                
                // Check if selected
                if (dateFilterState.startDate && dateFilterState.endDate) {
                    const start = dateFilterState.startDate.toISOString().split('T')[0];
                    const end = dateFilterState.endDate.toISOString().split('T')[0];
                    
                    if (dateStr === start || dateStr === end) {
                        classes += ' selected';
                    } else if (dateStr > start && dateStr < end) {
                        classes += ' in-range';
                    }
                }
                
                html += `<div class="${classes}" onclick="selectCalendarDate('${type}', ${year}, ${monthIndex}, ${day})">${day}</div>`;
            }
            
            calendar.innerHTML = html;
        }

        function selectCalendarDate(type, year, month, day) {
            const date = new Date(year, month, day);
            
            if (type === 'start') {
                dateFilterState.startDate = date;
                if (!dateFilterState.endDate || date > dateFilterState.endDate) {
                    dateFilterState.endDate = date;
                }
            } else {
                dateFilterState.endDate = date;
                if (!dateFilterState.startDate || date < dateFilterState.startDate) {
                    dateFilterState.startDate = date;
                }
            }
            
            // Clear preset selection
            dateFilterState.selectedPreset = null;
            document.querySelectorAll('.date-preset-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Re-render both calendars
            renderCalendar('start', dateFilterState.startMonth);
            renderCalendar('end', dateFilterState.endMonth);
        }

        function previousMonth(type, double = true) {
            if (type === 'start') {
                dateFilterState.startMonth = new Date(
                    dateFilterState.startMonth.getFullYear(),
                    dateFilterState.startMonth.getMonth() - (double ? 12 : 1)
                );
                renderCalendar('start', dateFilterState.startMonth);
            } else {
                dateFilterState.endMonth = new Date(
                    dateFilterState.endMonth.getFullYear(),
                    dateFilterState.endMonth.getMonth() - (double ? 12 : 1)
                );
                renderCalendar('end', dateFilterState.endMonth);
            }
        }

        function nextMonth(type, double = true) {
            if (type === 'start') {
                dateFilterState.startMonth = new Date(
                    dateFilterState.startMonth.getFullYear(),
                    dateFilterState.startMonth.getMonth() + (double ? 12 : 1)
                );
                renderCalendar('start', dateFilterState.startMonth);
            } else {
                dateFilterState.endMonth = new Date(
                    dateFilterState.endMonth.getFullYear(),
                    dateFilterState.endMonth.getMonth() + (double ? 12 : 1)
                );
                renderCalendar('end', dateFilterState.endMonth);
            }
        }

        function cancelDateSelection() {
            document.getElementById('dateFilterDropdown').classList.remove('open');
        }

        function applyDateSelection() {
            if (dateFilterState.startDate && dateFilterState.endDate) {
                updateDateFilterDisplay();
                filterHistory();
            }
            document.getElementById('dateFilterDropdown').classList.remove('open');
        }

        function updateDateFilterDisplay() {
            const display = document.getElementById('dateFilterDisplay');
            if (dateFilterState.startDate && dateFilterState.endDate) {
                const start = dateFilterState.startDate.toISOString().split('T')[0];
                const end = dateFilterState.endDate.toISOString().split('T')[0];
                
                if (start === end) {
                    display.textContent = start;
                } else {
                    display.textContent = `${start} - ${end}`;
                }
            } else {
                display.textContent = 'Date';
            }
        }

        // ============================================================
        // END: Date Filter with Calendar Component
        // ============================================================

        function filterHistory() {
            const incidentSearch = document.getElementById('historyIncidentSearch').value.toLowerCase();
            const rows = document.querySelectorAll('#historyTableBody tr');
            
            console.log('=== Filter History Debug ===');
            console.log('Date Filter State:', dateFilterState);
            console.log('Start Date:', dateFilterState.startDate);
            console.log('End Date:', dateFilterState.endDate);
            console.log('Selected Recipient Groups:', selectedRecipientGroups);
            console.log('Incident Search:', incidentSearch);
            console.log('Total Rows:', rows.length);
            
            rows.forEach((row, index) => {
                const dateTimeCell = row.cells[1];
                const recipient = row.cells[4].textContent.trim();
                const incidentId = row.cells[10].textContent.trim().toLowerCase();
                
                let showRow = true;
                
                // Filter by date range
                if (dateFilterState.startDate && dateFilterState.endDate) {
                    // Get innerHTML to preserve <br> tag, then extract date
                    const dateTimeHTML = dateTimeCell.innerHTML.trim();
                    console.log(`\nRow ${index + 1}:`);
                    console.log('  Raw cell HTML:', dateTimeHTML);
                    
                    // Split by <br> tag to get the date part
                    const rowDateStr = dateTimeHTML.split('<br>')[0].trim();
                    console.log('  Extracted date string:', rowDateStr);
                    
                    const rowDate = new Date(rowDateStr);
                    console.log('  Parsed row date:', rowDate);
                    
                    if (isNaN(rowDate.getTime())) {
                        console.log('  ERROR: Invalid date!');
                        showRow = false;
                    } else {
                        console.log('  Row date ISO:', rowDate.toISOString());
                        
                        const startDate = new Date(dateFilterState.startDate);
                        const endDate = new Date(dateFilterState.endDate);
                        
                        console.log('  Filter start date:', startDate);
                        console.log('  Filter end date:', endDate);
                        
                        // Set time to start and end of day for comparison
                        startDate.setHours(0, 0, 0, 0);
                        endDate.setHours(23, 59, 59, 999);
                        rowDate.setHours(0, 0, 0, 0);
                        
                        console.log('  Normalized row date:', rowDate);
                        console.log('  Normalized start date:', startDate);
                        console.log('  Normalized end date:', endDate);
                        console.log('  Is before start?', rowDate < startDate);
                        console.log('  Is after end?', rowDate > endDate);
                        
                        if (rowDate < startDate || rowDate > endDate) {
                            showRow = false;
                            console.log('  FILTERED OUT by date');
                        } else {
                            console.log('  PASSED date filter');
                        }
                    }
                }
                
                // Filter by recipient group (multi-select)
                if (selectedRecipientGroups.length > 0) {
                    if (!selectedRecipientGroups.includes(recipient)) {
                        showRow = false;
                        console.log('  FILTERED OUT by recipient group');
                    } else {
                        console.log('  PASSED recipient group filter');
                    }
                }
                
                // Filter by incident ID (contains search)
                if (incidentSearch && !incidentId.includes(incidentSearch)) {
                    showRow = false;
                    console.log('  FILTERED OUT by incident ID');
                }
                
                console.log('  Final result:', showRow ? 'SHOW' : 'HIDE');
                row.style.display = showRow ? '' : 'none';
            });
            
            console.log('=== End Filter Debug ===\n');
        }

        function toggleSelectAllHistory() {
            const selectAll = document.getElementById('selectAllHistory');
            const checkboxes = document.querySelectorAll('#historyTableBody .row-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAll.checked;
            });
        }

        function exportDetailedReport() {
            const selectedRows = document.querySelectorAll('#historyTableBody .row-checkbox:checked');
            if (selectedRows.length === 0) {
                showUpdateMessage('Please select at least one record to export', 'warning');
                return;
            }
            
            // Generate detailed CSV data for selected notifications
            let csvContent = 'Sent Date & Time,Status,Incident ID,Recipient Group,Channels,Contact Account,Customer Name,Phone,Email,Street,District,City,Template Name,Manual Notification,Language,Weather,Content\n';
            
            selectedRows.forEach(checkbox => {
                const row = checkbox.closest('tr');
                const cells = row.querySelectorAll('td');
                
                // Extract data from the row
                const dateTime = cells[1].innerHTML.replace('<br>', ' ');
                const stage = cells[2].textContent;
                const channels = cells[3].textContent;
                const recipientGroup = cells[4].textContent;
                const incidentId = cells[10].textContent;
                const numRecords = parseInt(cells[6].textContent.replace(/,/g, ''));
                
                // Generate placeholder customer records for this notification
                const customerRecords = generateCustomerRecords(dateTime, incidentId, stage, recipientGroup, channels, numRecords);
                csvContent += customerRecords;
            });
            
            // Create and download CSV file
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `notification_detailed_report_${new Date().toISOString().slice(0, 10)}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showUpdateMessage(`Exported detailed report for ${selectedRows.length} notification(s)`, 'success');
        }
        
        // Generate customer records for CSV export
        function generateCustomerRecords(dateTime, incidentId, stage, recipientGroup, channels, numRecords) {
            // Placeholder data arrays
            const statuses = ['Success', 'Success', 'Success', 'Success', 'Success', 'Success', 'Success', 'Success', 'Failed', 'Timeout'];
            const customerNames = ['Arthur Chan', 'Betty Wong', 'Charles Lee', 'David Ng', 'Emily Cheung', 'Frank Lam', 'Grace Ho', 'Henry Tsang', 'Iris Leung', 'Jack Liu',
                                   'Karen Chow', 'Leo Tam', 'Mary Yip', 'Nancy Kwok', 'Oliver Fung', 'Peter Mak', 'Queenie Siu', 'Raymond Tse', 'Sarah Wan', 'Thomas Cheng',
                                   'Uma Poon', 'Victor Yu', 'Wendy Chiu', 'Xavier Lok', 'Yvonne Hung', 'Zoe Kwan', 'MEI FOO Hospital', 'CDT', 'KCC Shopping Centre', 'ABC Company Ltd'];
            const streets = ['MEI LAI RD', 'SHUM SHUI PO', 'NATHAN RD', 'CANTON RD', 'YAU MA TEI', 'ARGYLE ST', 'MONGKOK RD', 'PRINCE EDWARD RD', 'BOUNDARY ST', 'TAI KOK TSUI RD',
                           'CHERRY ST', 'WATERLOO RD', 'LIBERTY AVE', 'MAPLE AVE', 'CASTLE PEAK RD', 'RECLAMATION ST', 'SAI YEUNG CHOI ST', 'FA YUEN ST', 'TUNG CHOI ST', 'PORTLAND ST',
                           'TEMPLE ST', 'JORDAN RD', 'AUSTIN RD', 'GASCOIGNE RD', 'CHATHAM RD', 'SALISBURY RD', 'GRANVILLE RD', 'KIMBERLEY RD', 'CAMERON RD', 'HAIPHONG RD'];
            const districts = ['LAI CHI KOK', 'SHAM SHUI PO', 'YAU MA TEI', 'TSIM SHA TSUI', 'MONGKOK', 'HUNG HOM', 'TO KWA WAN', 'KWUN TONG', 'KOWLOON BAY', 'DIAMOND HILL',
                             'WONG TAI SIN', 'SAN PO KONG', 'KOWLOON TONG', 'CHEUNG SHA WAN', 'MEI FOO', 'LAI KING', 'KWAI CHUNG', 'TSUEN WAN', 'TUEN MUN', 'YUEN LONG'];
            const cities = ['KOWLOON', 'KOWLOON', 'KOWLOON', 'KOWLOON', 'KOWLOON', 'KOWLOON', 'KOWLOON', 'KOWLOON', 'NEW TERRITORIES', 'NEW TERRITORIES'];
            const templateNames = ['1st Notification', '2nd Notification', 'Final Notification', 'Emergency Alert', 'Maintenance Notice'];
            const languages = ['E', 'C', 'E', 'E', 'C'];
            const weathers = ['NORMAL', 'NORMAL', 'NORMAL', 'NORMAL', 'EXTREME'];
            const contents = [
                '[CLP] A power outage report has been received for {start_time} at {outage_location}, and your unit may be affected. We will keep you informed of progress.',
                '[] {start_time}{outage_location}',
                '[CLP] Power restoration is in progress at {outage_location}. Estimated completion: {end_time}.',
                '[CLP] URGENT: Severe weather may cause power disruption in your area. Please take necessary precautions.',
                '[CLP] Scheduled maintenance will be conducted on {start_time} at {outage_location}. Power supply will be temporarily interrupted.'
            ];
            
            // Generate 20-30 records for demonstration (in real scenario, would be numRecords)
            const recordsToGenerate = Math.min(30, Math.max(20, Math.floor(Math.random() * 11) + 20));
            let records = '';
            
            for (let i = 0; i < recordsToGenerate; i++) {
                const status = statuses[Math.floor(Math.random() * statuses.length)];
                const customerName = customerNames[i % customerNames.length];
                const contactAccount = `A${Math.floor(Math.random() * 90000000) + 10000000}`;
                const phone = status === 'Success' ? `${Math.floor(Math.random() * 90000000) + 10000000}` : '';
                const email = status === 'Success' ? `${customerName.toLowerCase().replace(' ', '.')}.${Math.floor(Math.random() * 100)}@${Math.random() > 0.5 ? 'gmail.com' : 'clp.com'}` : '';
                const street = streets[i % streets.length];
                const district = districts[i % districts.length];
                const city = cities[i % cities.length];
                const templateName = templateNames[Math.floor(Math.random() * templateNames.length)];
                const manualNotification = Math.random() > 0.7 ? 'Y' : 'N';
                const language = languages[Math.floor(Math.random() * languages.length)];
                const weather = weathers[Math.floor(Math.random() * weathers.length)];
                const content = contents[Math.floor(Math.random() * contents.length)];
                
                // Build CSV row with proper escaping
                records += `"${dateTime}","${status}","${incidentId}","${recipientGroup}","${channels}","${contactAccount}","${customerName}","${phone}","${email}","${street}","${district}","${city}","${templateName}","${manualNotification}","${language}","${weather}","${content}"\n`;
            }
            
            return records;
        }

        // View notification
        function viewNotification(id) {
            console.log('View notification:', id);
            document.getElementById('viewNotificationModal').classList.add('show');
        }

        function hideViewNotificationModal() {
            document.getElementById('viewNotificationModal').classList.remove('show');
        }

        // Edit notification
        function editNotification(id) {
            console.log('Edit notification:', id);
            
            // Get notification data
            if (!window.notificationData || !window.notificationData[id]) {
                showUpdateMessage('Notification data not found', 'error');
                return;
            }
            
            const data = window.notificationData[id];
            isEditMode = true;
            editingNotificationId = id;
            
            // Open appropriate modal based on creation method
            if (data.creationMethod === 'Manual') {
                editManualNotification(id, data);
            } else if (data.creationMethod === 'Auto-triggered') {
                editAutoTriggeredNotification(id, data);
            }
        }
        
        function editManualNotification(id, data) {
            // Update modal title
            document.getElementById('manualNotificationModalTitle').textContent = 'Edit Manual Notification';
            
            // Reset form first
            resetManualNotificationForm();
            
            // Set Power Incident
            if (data.powerIncident) {
                document.getElementById('manualPowerIncident').value = data.powerIncident;
                document.getElementById('powerIncidentDisplay').textContent = data.powerIncident;
            }
            
            // Set Recipient Group checkboxes
            if (data.recipientGroup) {
                const groups = data.recipientGroup.split(', ');
                groups.forEach(group => {
                    if (group === 'Internal') {
                        document.getElementById('manualInternal').checked = true;
                    } else if (group === 'External-RT') {
                        document.getElementById('manualExternalRT').checked = true;
                    } else if (group === 'External-NRT') {
                        document.getElementById('manualExternalNRT').checked = true;
                    }
                });
                updateManualRecipientSelection();
            }
            
            // Set Channel - need to populate options first based on recipient group
            setTimeout(() => {
                if (data.channel) {
                    document.getElementById('manualNotificationChannel').value = data.channel;
                    handleManualChannelChange();
                }
            }, 100);
            
            // Set Subject Line
            if (data.subjectLine) {
                document.getElementById('manualSubjectLine').value = data.subjectLine;
            }
            
            // Set English Content
            if (data.englishContent) {
                document.getElementById('manualEnglishContent').value = data.englishContent;
                updateCharCount('manualEnglishContent', 'manualEnglishCount');
            }
            
            // Set Chinese Content
            if (data.chineseContent) {
                document.getElementById('manualChineseContent').value = data.chineseContent;
                updateCharCount('manualChineseContent', 'manualChineseCount');
            }
            
            // Show modal
            document.getElementById('createManualNotificationModal').style.display = 'flex';
        }
        
        function resetManualNotificationForm() {
            // Reset Power Incident
            document.getElementById('manualPowerIncident').value = '';
            document.getElementById('powerIncidentDisplay').textContent = 'Select Incident ID';
            
            // Reset Recipient Group
            document.getElementById('manualInternal').checked = false;
            document.getElementById('manualExternalRT').checked = false;
            document.getElementById('manualExternalNRT').checked = false;
            document.getElementById('manualRecipientDisplay').textContent = 'Select';
            document.getElementById('manualRecipientDisplay').classList.add('placeholder');
            
            // Reset Channel
            document.getElementById('manualNotificationChannel').value = '';
            
            // Reset Subject Line
            document.getElementById('manualSubjectLine').value = '';
            
            // Reset Content
            document.getElementById('manualEnglishContent').value = '';
            document.getElementById('manualChineseContent').value = '';
            document.getElementById('manualEnglishCount').textContent = '0';
            document.getElementById('manualChineseCount').textContent = '0';
            
            // Reset template toggle
            document.getElementById('applyTemplateToggle').checked = false;
            document.getElementById('templateSelectionRow').style.display = 'none';
            
            // Reset language tab to English
            switchManualLanguageTab('english');
        }
        
        function updateCharCount(textareaId, counterId) {
            const textarea = document.getElementById(textareaId);
            const counter = document.getElementById(counterId);
            if (textarea && counter) {
                counter.textContent = textarea.value.length;
            }
        }
        
        function editAutoTriggeredNotification(id, data) {
            // Update modal title
            document.getElementById('autoTriggeredModalTitle').textContent = 'Edit Auto-triggered Notification';
            
            // Reset and populate form
            const configData = data.configData || {};
            
            // Set recipient groups
            document.getElementById('autoInternal').checked = false;
            document.getElementById('autoExternalRT').checked = false;
            document.getElementById('autoExternalNRT').checked = false;
            
            if (configData.recipientGroup) {
                const groups = configData.recipientGroup.split(', ');
                groups.forEach(group => {
                    if (group === 'Internal') {
                        document.getElementById('autoInternal').checked = true;
                    } else if (group === 'External-RT') {
                        document.getElementById('autoExternalRT').checked = true;
                    } else if (group === 'External-NRT') {
                        document.getElementById('autoExternalNRT').checked = true;
                    }
                });
            }
            
            // Set subject line
            document.getElementById('autoSubjectLine').value = configData.subjectLine || '';
            
            // Update recipient group display
            updateAutoRecipientSelection();
            
            // Populate templates after updating the layout
            setTimeout(() => {
                if (configData.templates) {
                    // Check if internal or external layout
                    const internalLayout = document.getElementById('internalLayout');
                    
                    if (internalLayout.style.display === 'block') {
                        // Internal layout - set values or ensure "Select template name" is shown
                        const stage1Select = document.getElementById('autoStage1Template');
                        const stage2Select = document.getElementById('autoStage2Template');
                        const stage3Select = document.getElementById('autoStage3Template');
                        
                        if (configData.templates.stage1 && stage1Select.querySelector(`option[value="${configData.templates.stage1}"]`)) {
                            stage1Select.value = configData.templates.stage1;
                        } else {
                            stage1Select.value = '';
                        }
                        
                        if (configData.templates.stage2 && stage2Select.querySelector(`option[value="${configData.templates.stage2}"]`)) {
                            stage2Select.value = configData.templates.stage2;
                        } else {
                            stage2Select.value = '';
                        }
                        
                        if (configData.templates.stage3 && stage3Select.querySelector(`option[value="${configData.templates.stage3}"]`)) {
                            stage3Select.value = configData.templates.stage3;
                        } else {
                            stage3Select.value = '';
                        }
                    } else {
                        // External layout - populate all frame selects
                        Object.keys(configData.templates).forEach(key => {
                            const element = document.getElementById(key);
                            if (element) {
                                element.value = configData.templates[key];
                            }
                        });
                        
                        // Set channel priority if exists
                        if (configData.channelPriority) {
                            document.getElementById('autoFirstChannel').value = configData.channelPriority.first;
                            document.getElementById('autoSecondChannel').value = configData.channelPriority.second;
                            document.getElementById('autoThirdChannel').value = configData.channelPriority.third;
                        }
                    }
                }
            }, 100);
            
            // Load logic data if exists
            if (data.logicConfiguration) {
                logicData = JSON.parse(JSON.stringify(data.logicConfiguration));
                // Re-render all stages
                if (logicData.stage1 && logicData.stage1.scenarios.length > 0) {
                    renderStage('stage1');
                    updateLogicSummary('stage1');
                }
                if (logicData.stage2 && logicData.stage2.scenarios.length > 0) {
                    renderStage('stage2');
                    updateLogicSummary('stage2');
                }
                if (logicData.stage3 && logicData.stage3.scenarios.length > 0) {
                    renderStage('stage3');
                    updateLogicSummary('stage3');
                }
            }
            
            // Show modal
            document.getElementById('createAutoTriggeredModal').style.display = 'flex';
        }

        // Delete notification
        function deleteNotification(id) {
            if (confirm('Are you sure you want to delete this notification?')) {
                // Find the row in the table
                const tableBody = document.getElementById('notificationTableBody');
                const rows = tableBody.getElementsByTagName('tr');
                
                for (let i = 0; i < rows.length; i++) {
                    const row = rows[i];
                    const previewBtn = row.querySelector(`button[onclick*="${id}"]`);
                    
                    if (previewBtn) {
                        // Add fade-out effect
                        row.style.transition = 'opacity 0.3s ease';
                        row.style.opacity = '0';
                        
                        // Remove the row after animation
                        setTimeout(() => {
                            row.remove();
                            showUpdateMessage('Notification deleted successfully', 'success');
                            
                            // Clean up stored data
                            if (window.notificationData && window.notificationData[id]) {
                                delete window.notificationData[id];
                            }
                        }, 300);
                        
                        break;
                    }
                }
            }
        }

        // Create notifications
        function showCreateAutoModal() {
            showCreateAutoTriggeredModal();
        }

        // Auto-Triggered Notification Functions
        let currentAutoStep = 1;
        
        // Comprehensive template data organized by recipient group, stage, category, and channel
        const autoTemplateLibrary = {
            'Internal': {
                'stage1': {
                    'initial': [
                        { id: 'int-s1-init-teams-1', name: 'Power Outage Alert (Teams)', channel: 'TEAMS' },
                        { id: 'int-s1-init-teams-2', name: 'Service Interruption Notice (Teams)', channel: 'TEAMS' },
                        { id: 'int-s1-init-email-1', name: 'Outage Notification (Email)', channel: 'Email' },
                        { id: 'int-s1-init-email-2', name: 'Emergency Alert (Email)', channel: 'Email' }
                    ]
                },
                'stage2': {
                    'progress': [
                        { id: 'int-s2-prog-teams-1', name: 'Repair In Progress (Teams)', channel: 'TEAMS' },
                        { id: 'int-s2-prog-teams-2', name: 'Investigation Update (Teams)', channel: 'TEAMS' },
                        { id: 'int-s2-prog-email-1', name: 'Status Update (Email)', channel: 'Email' }
                    ],
                    'interim': [
                        { id: 'int-s2-interim-teams-1', name: 'Interim Progress (Teams)', channel: 'TEAMS' },
                        { id: 'int-s2-interim-email-1', name: 'Interim Update (Email)', channel: 'Email' }
                    ]
                },
                'stage3': {
                    'final': [
                        { id: 'int-s3-final-teams-1', name: 'Restoration Complete (Teams)', channel: 'TEAMS' },
                        { id: 'int-s3-final-email-1', name: 'Service Restored (Email)', channel: 'Email' },
                        { id: 'int-s3-final-email-2', name: 'Resolution Notice (Email)', channel: 'Email' }
                    ]
                }
            },
            'External-RT': {
                'stage1': {
                    'clp_fault': [
                        { id: 'ext-rt-s1-clp-sms-1', name: 'CLP Fault Alert (SMS)', channel: 'SMS' },
                        { id: 'ext-rt-s1-clp-email-1', name: 'CLP Fault Notification (Email)', channel: 'Email' },
                        { id: 'ext-rt-s1-clp-app-1', name: 'CLP Fault Push (App)', channel: 'App Push' }
                    ],
                    'unconfirmed': [
                        { id: 'ext-rt-s1-unconf-sms-1', name: 'Unconfirmed Outage (SMS)', channel: 'SMS' },
                        { id: 'ext-rt-s1-unconf-email-1', name: 'Investigation Alert (Email)', channel: 'Email' },
                        { id: 'ext-rt-s1-unconf-app-1', name: 'Checking Status (App)', channel: 'App Push' }
                    ]
                },
                'stage2': {
                    'clp_fault': [
                        { id: 'ext-rt-s2-clp-sms-1', name: 'CLP Repair Update (SMS)', channel: 'SMS' },
                        { id: 'ext-rt-s2-clp-email-1', name: 'CLP Progress Report (Email)', channel: 'Email' },
                        { id: 'ext-rt-s2-clp-app-1', name: 'CLP Status Push (App)', channel: 'App Push' }
                    ],
                    'customer_fault': [
                        { id: 'ext-rt-s2-cust-sms-1', name: 'Customer Fault Notice (SMS)', channel: 'SMS' },
                        { id: 'ext-rt-s2-cust-email-1', name: 'Customer Issue Alert (Email)', channel: 'Email' },
                        { id: 'ext-rt-s2-cust-app-1', name: 'Customer Action Required (App)', channel: 'App Push' }
                    ],
                    'unconfirmed': [
                        { id: 'ext-rt-s2-unconf-sms-1', name: 'Investigation Ongoing (SMS)', channel: 'SMS' },
                        { id: 'ext-rt-s2-unconf-email-1', name: 'Status Unknown Update (Email)', channel: 'Email' },
                        { id: 'ext-rt-s2-unconf-app-1', name: 'Checking Progress (App)', channel: 'App Push' }
                    ],
                    'interim': [
                        { id: 'ext-rt-s2-interim-sms-1', name: 'Interim Status (SMS)', channel: 'SMS' },
                        { id: 'ext-rt-s2-interim-email-1', name: 'Interim Progress (Email)', channel: 'Email' },
                        { id: 'ext-rt-s2-interim-app-1', name: 'Interim Update (App)', channel: 'App Push' }
                    ]
                },
                'stage3': {
                    'restoration': [
                        { id: 'ext-rt-s3-rest-sms-1', name: 'Power Restored (SMS)', channel: 'SMS' },
                        { id: 'ext-rt-s3-rest-email-1', name: 'Service Back Online (Email)', channel: 'Email' },
                        { id: 'ext-rt-s3-rest-app-1', name: 'Restoration Complete (App)', channel: 'App Push' }
                    ]
                }
            },
            'External-NRT': {
                'stage1': {
                    'clp_fault': [
                        { id: 'ext-nrt-s1-clp-sms-1', name: 'CLP Fault NRT (SMS)', channel: 'SMS' },
                        { id: 'ext-nrt-s1-clp-email-1', name: 'CLP Fault Notice NRT (Email)', channel: 'Email' },
                        { id: 'ext-nrt-s1-clp-app-1', name: 'CLP Fault Alert NRT (App)', channel: 'App Push' }
                    ],
                    'unconfirmed': [
                        { id: 'ext-nrt-s1-unconf-sms-1', name: 'Unconfirmed Case NRT (SMS)', channel: 'SMS' },
                        { id: 'ext-nrt-s1-unconf-email-1', name: 'Investigation NRT (Email)', channel: 'Email' },
                        { id: 'ext-nrt-s1-unconf-app-1', name: 'Status Check NRT (App)', channel: 'App Push' }
                    ]
                },
                'stage2': {
                    'clp_fault': [
                        { id: 'ext-nrt-s2-clp-sms-1', name: 'CLP Update NRT (SMS)', channel: 'SMS' },
                        { id: 'ext-nrt-s2-clp-email-1', name: 'CLP Progress NRT (Email)', channel: 'Email' },
                        { id: 'ext-nrt-s2-clp-app-1', name: 'CLP Status NRT (App)', channel: 'App Push' }
                    ],
                    'customer_fault': [
                        { id: 'ext-nrt-s2-cust-sms-1', name: 'Customer Issue NRT (SMS)', channel: 'SMS' },
                        { id: 'ext-nrt-s2-cust-email-1', name: 'Customer Fault NRT (Email)', channel: 'Email' },
                        { id: 'ext-nrt-s2-cust-app-1', name: 'Customer Alert NRT (App)', channel: 'App Push' }
                    ],
                    'unconfirmed': [
                        { id: 'ext-nrt-s2-unconf-sms-1', name: 'Investigation NRT (SMS)', channel: 'SMS' },
                        { id: 'ext-nrt-s2-unconf-email-1', name: 'Status Check NRT (Email)', channel: 'Email' },
                        { id: 'ext-nrt-s2-unconf-app-1', name: 'Progress NRT (App)', channel: 'App Push' }
                    ],
                    'interim': [
                        { id: 'ext-nrt-s2-interim-sms-1', name: 'Interim NRT (SMS)', channel: 'SMS' },
                        { id: 'ext-nrt-s2-interim-email-1', name: 'Interim Status NRT (Email)', channel: 'Email' },
                        { id: 'ext-nrt-s2-interim-app-1', name: 'Interim Progress NRT (App)', channel: 'App Push' }
                    ]
                },
                'stage3': {
                    'restoration': [
                        { id: 'ext-nrt-s3-rest-sms-1', name: 'Restored NRT (SMS)', channel: 'SMS' },
                        { id: 'ext-nrt-s3-rest-email-1', name: 'Service Restored NRT (Email)', channel: 'Email' },
                        { id: 'ext-nrt-s3-rest-app-1', name: 'Back Online NRT (App)', channel: 'App Push' }
                    ]
                }
            }
        };

        function showCreateAutoTriggeredModal() {
            // Reset edit mode
            isEditMode = false;
            editingNotificationId = null;
            
            // Set title to Create mode
            document.getElementById('autoTriggeredModalTitle').textContent = 'Create Auto-triggered Notification';
            
            document.getElementById('createAutoTriggeredModal').style.display = 'flex';
            currentAutoStep = 1;
            resetAutoTriggeredForm();
            updateAutoStepUI();
        }

        function hideCreateAutoTriggeredModal() {
            document.getElementById('createAutoTriggeredModal').style.display = 'none';
            resetAutoTriggeredForm();
            // Reset edit mode
            isEditMode = false;
            editingNotificationId = null;
        }

        function resetAutoTriggeredForm() {
            // Reset step to 1
            currentAutoStep = 1;
            
            // Reset recipient group checkboxes
            document.getElementById('autoInternal').checked = false;
            document.getElementById('autoExternalRT').checked = false;
            document.getElementById('autoExternalNRT').checked = false;
            document.getElementById('autoRecipientDisplay').textContent = 'Select';
            document.getElementById('autoRecipientDisplay').classList.add('placeholder');
            
            // Reset Subject Line
            document.getElementById('autoSubjectLine').value = '';
            
            // Hide both layouts
            document.getElementById('internalLayout').style.display = 'none';
            document.getElementById('externalLayout').style.display = 'none';
            
            // Reset Internal layout form fields
            document.getElementById('autoStage1Template').innerHTML = '<option value="">Select template name</option>';
            document.getElementById('autoStage2Template').innerHTML = '<option value="">Select template name</option>';
            document.getElementById('autoStage2_1Template').innerHTML = '<option value="">Select template name</option>';
            document.getElementById('autoStage3Template').innerHTML = '<option value="">Select template name</option>';
            document.getElementById('enableStage2_1').checked = false;
            document.getElementById('autoStage2_1Template').disabled = true;
            
            // Reset External layout form fields (all frame selects)
            const externalSelects = [
                'autoExtStage1_1_First', 'autoExtStage1_2_First',
                'autoExtStage2_1_First', 'autoExtStage2_2_First', 'autoExtStage2_3_First', 'autoExtStage2_4_First',
                'autoExtStage3_1_First',
                'autoExtStage1_1_Second', 'autoExtStage1_2_Second',
                'autoExtStage2_1_Second', 'autoExtStage2_2_Second', 'autoExtStage2_3_Second', 'autoExtStage2_4_Second',
                'autoExtStage3_1_Second',
                'autoExtStage1_1_Third', 'autoExtStage1_2_Third',
                'autoExtStage2_1_Third', 'autoExtStage2_2_Third', 'autoExtStage2_3_Third', 'autoExtStage2_4_Third',
                'autoExtStage3_1_Third'
            ];
            
            externalSelects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) {
                    select.innerHTML = '<option value="">Select template name</option>';
                }
            });
            
            // Reset priority toggle and channels
            document.getElementById('autoPriorityToggle').checked = true;
            document.getElementById('autoFirstChannel').value = 'SMS';
            document.getElementById('autoSecondChannel').value = 'Email';
            document.getElementById('autoThirdChannel').value = 'App Push';
            
            // Reset UI
            updateAutoStepUI();
        }

        function updateAutoStageTemplates() {
            const selectedGroups = getSelectedAutoRecipientGroups();
            
            // If no groups selected, clear all template dropdowns
            if (selectedGroups.length === 0) {
                // Clear Internal layout
                const internalSelects = [
                    'autoStage1Template',
                    'autoStage2Template',
                    'autoStage2_1Template',
                    'autoStage3Template'
                ];
                
                internalSelects.forEach(selectId => {
                    const select = document.getElementById(selectId);
                    if (select) {
                        select.innerHTML = '<option value="">Select template name</option>';
                    }
                });
                
                // Clear External layout
                const externalSelects = [
                    'autoExtStage1_1_First', 'autoExtStage1_2_First',
                    'autoExtStage2_1_First', 'autoExtStage2_2_First', 'autoExtStage2_3_First', 'autoExtStage2_4_First',
                    'autoExtStage3_1_First',
                    'autoExtStage1_1_Second', 'autoExtStage1_2_Second',
                    'autoExtStage2_1_Second', 'autoExtStage2_2_Second', 'autoExtStage2_3_Second', 'autoExtStage2_4_Second',
                    'autoExtStage3_1_Second',
                    'autoExtStage1_1_Third', 'autoExtStage1_2_Third',
                    'autoExtStage2_1_Third', 'autoExtStage2_2_Third', 'autoExtStage2_3_Third', 'autoExtStage2_4_Third',
                    'autoExtStage3_1_Third'
                ];
                
                externalSelects.forEach(selectId => {
                    const select = document.getElementById(selectId);
                    if (select) {
                        select.innerHTML = '<option value="">Select template name</option>';
                    }
                });
                
                return;
            }
            
            // Check if Internal is selected
            if (selectedGroups.includes('Internal')) {
                populateInternalTemplates();
            } 
            // Check if External groups are selected
            else if (selectedGroups.includes('External-RT') || selectedGroups.includes('External-NRT')) {
                populateExternalTemplates(selectedGroups);
            }
        }

        function populateInternalTemplates() {
            const internalData = autoTemplateLibrary['Internal'];
            
            // Populate Stage 1
            const stage1Select = document.getElementById('autoStage1Template');
            stage1Select.innerHTML = '<option value="">Select template name</option>';
            if (internalData.stage1 && internalData.stage1.initial) {
                internalData.stage1.initial.forEach(template => {
                    const option = document.createElement('option');
                    option.value = template.id;
                    option.textContent = template.name;
                    stage1Select.appendChild(option);
                });
            }
            
            // Populate Stage 2 - Progress
            const stage2Select = document.getElementById('autoStage2Template');
            stage2Select.innerHTML = '<option value="">Select template name</option>';
            if (internalData.stage2 && internalData.stage2.progress) {
                internalData.stage2.progress.forEach(template => {
                    const option = document.createElement('option');
                    option.value = template.id;
                    option.textContent = template.name;
                    stage2Select.appendChild(option);
                });
            }
            
            // Populate Stage 2.1 - Interim
            const stage2_1Select = document.getElementById('autoStage2_1Template');
            stage2_1Select.innerHTML = '<option value="">Select template name</option>';
            if (internalData.stage2 && internalData.stage2.interim) {
                internalData.stage2.interim.forEach(template => {
                    const option = document.createElement('option');
                    option.value = template.id;
                    option.textContent = template.name;
                    stage2_1Select.appendChild(option);
                });
            }
            
            // Populate Stage 3 - Final
            const stage3Select = document.getElementById('autoStage3Template');
            stage3Select.innerHTML = '<option value="">Select template name</option>';
            if (internalData.stage3 && internalData.stage3.final) {
                internalData.stage3.final.forEach(template => {
                    const option = document.createElement('option');
                    option.value = template.id;
                    option.textContent = template.name;
                    stage3Select.appendChild(option);
                });
            }
        }

        function populateExternalTemplates(selectedGroups) {
            // Get currently selected channels
            const firstChannel = document.getElementById('autoFirstChannel').value;
            const secondChannel = document.getElementById('autoSecondChannel').value;
            const thirdChannel = document.getElementById('autoThirdChannel').value;
            
            // Populate each frame with templates matching the selected channel
            // Templates start empty, but options are filtered by channel
            populateFrameTemplates('First', firstChannel, selectedGroups);
            populateFrameTemplates('Second', secondChannel, selectedGroups);
            populateFrameTemplates('Third', thirdChannel, selectedGroups);
        }

        function populateExternalSelect(selectId, templates, channelFilter) {
            const select = document.getElementById(selectId);
            if (!select) return;
            
            select.innerHTML = '<option value="">Select template name</option>';
            
            // Filter templates by channel
            const filteredTemplates = templates.filter(t => t.channel === channelFilter);
            
            filteredTemplates.forEach(template => {
                const option = document.createElement('option');
                option.value = template.id;
                option.textContent = template.name;
                select.appendChild(option);
            });
        }

        // Enable/disable Stage 2.1 based on checkbox
        document.getElementById('enableStage2_1').addEventListener('change', function() {
            const stage2_1Select = document.getElementById('autoStage2_1Template');
            stage2_1Select.disabled = !this.checked;
            if (!this.checked) {
                stage2_1Select.value = '';
            }
        });

        function handleAutoStepNavigation() {
            if (currentAutoStep === 1) {
                // Move to Step 2 (no validation required)
                currentAutoStep = 2;
                updateAutoStepUI();
            }
        }

        function updateAutoStepUI() {
            const step1Content = document.getElementById('step1Content');
            const step2Content = document.getElementById('step2Content');
            const step1Circle = document.getElementById('step1Circle');
            const step2Circle = document.getElementById('step2Circle');
            const step1Label = document.getElementById('step1Label');
            const step2Label = document.getElementById('step2Label');
            const nextBtn = document.getElementById('autoNextBtn');
            
            if (currentAutoStep === 1) {
                // Show Step 1
                step1Content.style.display = 'block';
                step2Content.style.display = 'none';
                
                // Update circles
                step1Circle.style.backgroundColor = '#2c5aa0';
                step1Circle.style.color = 'white';
                step1Circle.innerHTML = '1';
                step1Label.style.color = '#2c5aa0';
                step1Label.style.fontWeight = '500';
                
                step2Circle.style.backgroundColor = '#e0e0e0';
                step2Circle.style.color = '#999';
                step2Circle.innerHTML = '2';
                step2Label.style.color = '#999';
                step2Label.style.fontWeight = 'normal';
                
                // Update Next button
                nextBtn.textContent = 'Next';
                nextBtn.onclick = handleAutoStepNavigation;
                
            } else if (currentAutoStep === 2) {
                // Show Step 2
                step1Content.style.display = 'none';
                step2Content.style.display = 'block';
                
                // Update circles
                step1Circle.style.backgroundColor = '#28a745';
                step1Circle.innerHTML = '';
                step1Label.style.color = '#28a745';
                
                step2Circle.style.backgroundColor = '#2c5aa0';
                step2Circle.style.color = 'white';
                step2Label.style.color = '#2c5aa0';
                step2Label.style.fontWeight = '500';
                
                // Update Next button to Back
                nextBtn.textContent = 'Back';
                nextBtn.onclick = function() {
                    currentAutoStep = 1;
                    updateAutoStepUI();
                };
            }
        }

        function toggleAutoPriority() {
            const toggle = document.getElementById('autoPriorityToggle');
            const channelSelects = [
                document.getElementById('autoFirstChannel'),
                document.getElementById('autoSecondChannel'),
                document.getElementById('autoThirdChannel')
            ];
            
            // Enable/disable channel priority selects based on toggle
            channelSelects.forEach(select => {
                select.disabled = !toggle.checked;
                if (!toggle.checked) {
                    select.style.opacity = '0.5';
                    select.style.cursor = 'not-allowed';
                } else {
                    select.style.opacity = '1';
                    select.style.cursor = 'pointer';
                }
            });
        }

        function updateChannelFrameLabels() {
            // Get selected recipient groups
            const selectedGroups = getSelectedAutoRecipientGroups();
            if (selectedGroups.length === 0 || !selectedGroups.some(g => g.includes('External'))) {
                return;
            }
            
            // Get currently selected channels
            const firstChannel = document.getElementById('autoFirstChannel').value;
            const secondChannel = document.getElementById('autoSecondChannel').value;
            const thirdChannel = document.getElementById('autoThirdChannel').value;
            
            // Repopulate templates for each frame based on selected channel
            // This will update the dropdown options to match the new channel
            populateFrameTemplates('First', firstChannel, selectedGroups);
            populateFrameTemplates('Second', secondChannel, selectedGroups);
            populateFrameTemplates('Third', thirdChannel, selectedGroups);
        }

        function populateFrameTemplates(frameName, channel, selectedGroups) {
            // Combine templates from all selected External groups
            let combinedData = {
                stage1: { clp_fault: [], unconfirmed: [] },
                stage2: { clp_fault: [], customer_fault: [], unconfirmed: [], interim: [] },
                stage3: { restoration: [] }
            };
            
            selectedGroups.forEach(group => {
                const groupData = autoTemplateLibrary[group];
                if (groupData) {
                    // Stage 1
                    if (groupData.stage1) {
                        if (groupData.stage1.clp_fault) {
                            combinedData.stage1.clp_fault.push(...groupData.stage1.clp_fault);
                        }
                        if (groupData.stage1.unconfirmed) {
                            combinedData.stage1.unconfirmed.push(...groupData.stage1.unconfirmed);
                        }
                    }
                    
                    // Stage 2
                    if (groupData.stage2) {
                        if (groupData.stage2.clp_fault) {
                            combinedData.stage2.clp_fault.push(...groupData.stage2.clp_fault);
                        }
                        if (groupData.stage2.customer_fault) {
                            combinedData.stage2.customer_fault.push(...groupData.stage2.customer_fault);
                        }
                        if (groupData.stage2.unconfirmed) {
                            combinedData.stage2.unconfirmed.push(...groupData.stage2.unconfirmed);
                        }
                        if (groupData.stage2.interim) {
                            combinedData.stage2.interim.push(...groupData.stage2.interim);
                        }
                    }
                    
                    // Stage 3
                    if (groupData.stage3 && groupData.stage3.restoration) {
                        combinedData.stage3.restoration.push(...groupData.stage3.restoration);
                    }
                }
            });
            
            // Populate each select in this frame
            populateFrameSelect(`autoExtStage1_1_${frameName}`, combinedData.stage1.clp_fault, channel);
            populateFrameSelect(`autoExtStage1_2_${frameName}`, combinedData.stage1.unconfirmed, channel);
            populateFrameSelect(`autoExtStage2_1_${frameName}`, combinedData.stage2.clp_fault, channel);
            populateFrameSelect(`autoExtStage2_2_${frameName}`, combinedData.stage2.customer_fault, channel);
            populateFrameSelect(`autoExtStage2_3_${frameName}`, combinedData.stage2.unconfirmed, channel);
            populateFrameSelect(`autoExtStage2_4_${frameName}`, combinedData.stage2.interim, channel);
            populateFrameSelect(`autoExtStage3_1_${frameName}`, combinedData.stage3.restoration, channel);
        }

        function populateFrameSelect(selectId, templates, channelFilter) {
            const select = document.getElementById(selectId);
            if (!select) return;
            
            select.innerHTML = '<option value="">Select template name</option>';
            
            // Filter templates by channel
            const filteredTemplates = templates.filter(t => t.channel === channelFilter);
            
            filteredTemplates.forEach(template => {
                const option = document.createElement('option');
                option.value = template.id;
                option.textContent = template.name;
                select.appendChild(option);
            });
        }

        function saveAutoTriggeredDraft() {
            const selectedGroups = getSelectedAutoRecipientGroups();
            const subjectLine = document.getElementById('autoSubjectLine').value.trim();
            
            // Track missing fields with detailed stage information
            let missingFields = [];
            let missingLogic = [];
            let externalMissingTemplates = null;
            
            // Validate Recipient Group
            if (selectedGroups.length === 0) {
                missingFields.push('Recipient Group');
            }
            
            // Validate Subject Line
            if (!subjectLine) {
                missingFields.push('Subject Line');
            }
            
            // Validate Templates and Logic for each stage
            const internalLayout = document.getElementById('internalLayout');
            
            if (internalLayout.style.display === 'block') {
                // Internal layout - check each stage separately
                
                // Stage 1: Initial Notification
                const stage1Template = document.getElementById('autoStage1Template').value;
                if (!stage1Template) {
                    missingFields.push('Stage 1: Initial Notification template');
                }
                if (!logicData.stage1.scenarios || logicData.stage1.scenarios.length === 0) {
                    missingLogic.push('Stage 1');
                }
                
                // Stage 2: Progress Update
                const stage2Template = document.getElementById('autoStage2Template').value;
                if (!stage2Template) {
                    missingFields.push('Stage 2: Progress Update template');
                }
                if (!logicData.stage2.scenarios || logicData.stage2.scenarios.length === 0) {
                    missingLogic.push('Stage 2');
                }
                
                // Stage 3: Final notification
                const stage3Template = document.getElementById('autoStage3Template').value;
                if (!stage3Template) {
                    missingFields.push('Stage 3: Final notification template');
                }
                if (!logicData.stage3.scenarios || logicData.stage3.scenarios.length === 0) {
                    missingLogic.push('Stage 3');
                }
                
            } else {
                // External layout - check each frame and stage separately
                externalMissingTemplates = {
                    First: { channel: '', stage1: [], stage2: [], stage3: [] },
                    Second: { channel: '', stage1: [], stage2: [], stage3: [] },
                    Third: { channel: '', stage1: [], stage2: [], stage3: [] }
                };
                
                // Get channel names for each frame
                externalMissingTemplates.First.channel = document.getElementById('autoFirstChannel').value;
                externalMissingTemplates.Second.channel = document.getElementById('autoSecondChannel').value;
                externalMissingTemplates.Third.channel = document.getElementById('autoThirdChannel').value;
                
                // Check First frame
                const stage1Categories = ['CLP Fault', 'Unconfirm Case'];
                const stage2Categories = ['CLP Fault', 'Customer Fault', 'Unconfirm Case', 'Interim Update'];
                const stage3Categories = ['Restoration Completion'];
                
                // First Frame - Stage 1
                if (!document.getElementById('autoExtStage1_1_First').value) {
                    externalMissingTemplates.First.stage1.push(stage1Categories[0]);
                }
                if (!document.getElementById('autoExtStage1_2_First').value) {
                    externalMissingTemplates.First.stage1.push(stage1Categories[1]);
                }
                
                // First Frame - Stage 2
                if (!document.getElementById('autoExtStage2_1_First').value) {
                    externalMissingTemplates.First.stage2.push(stage2Categories[0]);
                }
                if (!document.getElementById('autoExtStage2_2_First').value) {
                    externalMissingTemplates.First.stage2.push(stage2Categories[1]);
                }
                if (!document.getElementById('autoExtStage2_3_First').value) {
                    externalMissingTemplates.First.stage2.push(stage2Categories[2]);
                }
                if (!document.getElementById('autoExtStage2_4_First').value) {
                    externalMissingTemplates.First.stage2.push(stage2Categories[3]);
                }
                
                // First Frame - Stage 3
                if (!document.getElementById('autoExtStage3_1_First').value) {
                    externalMissingTemplates.First.stage3.push(stage3Categories[0]);
                }
                
                // Second Frame - Stage 1
                if (!document.getElementById('autoExtStage1_1_Second').value) {
                    externalMissingTemplates.Second.stage1.push(stage1Categories[0]);
                }
                if (!document.getElementById('autoExtStage1_2_Second').value) {
                    externalMissingTemplates.Second.stage1.push(stage1Categories[1]);
                }
                
                // Second Frame - Stage 2
                if (!document.getElementById('autoExtStage2_1_Second').value) {
                    externalMissingTemplates.Second.stage2.push(stage2Categories[0]);
                }
                if (!document.getElementById('autoExtStage2_2_Second').value) {
                    externalMissingTemplates.Second.stage2.push(stage2Categories[1]);
                }
                if (!document.getElementById('autoExtStage2_3_Second').value) {
                    externalMissingTemplates.Second.stage2.push(stage2Categories[2]);
                }
                if (!document.getElementById('autoExtStage2_4_Second').value) {
                    externalMissingTemplates.Second.stage2.push(stage2Categories[3]);
                }
                
                // Second Frame - Stage 3
                if (!document.getElementById('autoExtStage3_1_Second').value) {
                    externalMissingTemplates.Second.stage3.push(stage3Categories[0]);
                }
                
                // Third Frame - Stage 1
                if (!document.getElementById('autoExtStage1_1_Third').value) {
                    externalMissingTemplates.Third.stage1.push(stage1Categories[0]);
                }
                if (!document.getElementById('autoExtStage1_2_Third').value) {
                    externalMissingTemplates.Third.stage1.push(stage1Categories[1]);
                }
                
                // Third Frame - Stage 2
                if (!document.getElementById('autoExtStage2_1_Third').value) {
                    externalMissingTemplates.Third.stage2.push(stage2Categories[0]);
                }
                if (!document.getElementById('autoExtStage2_2_Third').value) {
                    externalMissingTemplates.Third.stage2.push(stage2Categories[1]);
                }
                if (!document.getElementById('autoExtStage2_3_Third').value) {
                    externalMissingTemplates.Third.stage2.push(stage2Categories[2]);
                }
                if (!document.getElementById('autoExtStage2_4_Third').value) {
                    externalMissingTemplates.Third.stage2.push(stage2Categories[3]);
                }
                
                // Third Frame - Stage 3
                if (!document.getElementById('autoExtStage3_1_Third').value) {
                    externalMissingTemplates.Third.stage3.push(stage3Categories[0]);
                }
                
                // Check logic for each stage
                if (!logicData.stage1.scenarios || logicData.stage1.scenarios.length === 0) {
                    missingLogic.push('Stage 1');
                }
                if (!logicData.stage2.scenarios || logicData.stage2.scenarios.length === 0) {
                    missingLogic.push('Stage 2');
                }
                if (!logicData.stage3.scenarios || logicData.stage3.scenarios.length === 0) {
                    missingLogic.push('Stage 3');
                }
            }
            
            // Check if any fields are missing
            if (missingFields.length > 0 || missingLogic.length > 0 || externalMissingTemplates) {
                // Show warning modal with missing fields
                showValidationWarningModal(missingFields, missingLogic, externalMissingTemplates);
                return;
            }
            
            // All fields are complete, save as Completed
            performSaveAutoTriggered('Completed');
        }

        function showValidationWarningModal(missingFields, missingLogic, externalMissingTemplates) {
            const modal = document.getElementById('validationWarningModal');
            const listEl = document.getElementById('missingFieldsList');
            
            let html = '';
            
            // Show basic missing fields (Recipient Group, Subject Line)
            if (missingFields.length > 0) {
                missingFields.forEach(field => {
                    html += `<li style="margin-bottom: 8px;">${field}</li>`;
                });
            }
            
            // Show external template missing details
            if (externalMissingTemplates) {
                html += '<li style="margin-bottom: 8px; margin-top: 12px;"><strong>Template Selection:</strong></li>';
                
                ['First', 'Second', 'Third'].forEach(frame => {
                    const frameData = externalMissingTemplates[frame];
                    const hasMissing = frameData.stage1.length > 0 || frameData.stage2.length > 0 || frameData.stage3.length > 0;
                    
                    if (hasMissing) {
                        html += `<li style="margin-left: 20px; margin-bottom: 4px;"><strong>${frame}: ${frameData.channel}</strong></li>`;
                        
                        if (frameData.stage1.length > 0) {
                            html += `<li style="margin-left: 40px; margin-bottom: 2px;">Stage1: Initial Notification (${frameData.stage1.join('/')})</li>`;
                        }
                        if (frameData.stage2.length > 0) {
                            html += `<li style="margin-left: 40px; margin-bottom: 2px;">Stage2: Progress Update (${frameData.stage2.join('/')})</li>`;
                        }
                        if (frameData.stage3.length > 0) {
                            html += `<li style="margin-left: 40px; margin-bottom: 8px;">Stage3: Final Notification (${frameData.stage3.join('/')})</li>`;
                        }
                    }
                });
            }
            
            // Show logic missing details
            if (missingLogic.length > 0) {
                html += '<li style="margin-bottom: 4px; margin-top: 12px;"><strong>Logic:</strong></li>';
                missingLogic.forEach(stage => {
                    html += `<li style="margin-left: 20px; margin-bottom: 2px;"> ${stage}</li>`;
                });
            }
            
            // Populate missing fields list
            listEl.innerHTML = html;
            
            // Store missing fields for later use
            window.currentMissingFields = missingFields;
            
            modal.style.display = 'flex';
        }

        function hideValidationWarningModal() {
            document.getElementById('validationWarningModal').style.display = 'none';
        }

        function confirmSaveAsDraft() {
            hideValidationWarningModal();
            performSaveAutoTriggered('Draft');
        }

        function performSaveAutoTriggered(status) {
            const selectedGroups = getSelectedAutoRecipientGroups();
            const subjectLine = document.getElementById('autoSubjectLine').value.trim();
            
            // Determine if creating new or updating existing
            let notificationId;
            let isUpdate = false;
            
            if (isEditMode && editingNotificationId) {
                // Edit mode - use existing ID
                notificationId = editingNotificationId;
                isUpdate = true;
            } else {
                // Create mode - generate new ID
                notificationCounter++;
                notificationId = `notif-${notificationCounter}`;
            }
            
            // Prepare notification data
            const recipientGroup = selectedGroups.join(', ') || 'Not specified';
            const currentDate = new Date();
            const dateStr = currentDate.toISOString().split('T')[0];
            const timeStr = currentDate.toTimeString().split(' ')[0].substring(0, 5);
            
            let templateSummary = subjectLine || 'Auto-triggered Configuration';
            let configData = {
                recipientGroup: recipientGroup,
                subjectLine: subjectLine,
                templates: {}
            };
            
            // Collect data based on which layout is active
            const internalLayout = document.getElementById('internalLayout');
            if (internalLayout.style.display === 'block') {
                // Internal layout
                const stage1 = document.getElementById('autoStage1Template');
                const stage1Text = stage1.options[stage1.selectedIndex]?.text || '';
                if (stage1Text) {
                    templateSummary = stage1Text;
                }
                
                configData.templates = {
                    stage1: stage1.value,
                    stage2: document.getElementById('autoStage2Template').value,
                    stage2_1: document.getElementById('enableStage2_1').checked ? 
                             document.getElementById('autoStage2_1Template').value : null,
                    stage3: document.getElementById('autoStage3Template').value
                };
            } else {
                // External layout - collect first non-empty template as summary
                const allSelectIds = [
                    'autoExtStage1_1_First', 'autoExtStage1_2_First',
                    'autoExtStage1_1_Second', 'autoExtStage1_2_Second',
                    'autoExtStage1_1_Third', 'autoExtStage1_2_Third'
                ];
                
                for (let selectId of allSelectIds) {
                    const select = document.getElementById(selectId);
                    if (select && select.value) {
                        templateSummary = select.options[select.selectedIndex].text;
                        break;
                    }
                }
                
                // Collect all selected templates from all frames
                const allFrameSelects = [
                    'autoExtStage1_1_First', 'autoExtStage1_2_First',
                    'autoExtStage2_1_First', 'autoExtStage2_2_First', 'autoExtStage2_3_First', 'autoExtStage2_4_First',
                    'autoExtStage3_1_First',
                    'autoExtStage1_1_Second', 'autoExtStage1_2_Second',
                    'autoExtStage2_1_Second', 'autoExtStage2_2_Second', 'autoExtStage2_3_Second', 'autoExtStage2_4_Second',
                    'autoExtStage3_1_Second',
                    'autoExtStage1_1_Third', 'autoExtStage1_2_Third',
                    'autoExtStage2_1_Third', 'autoExtStage2_2_Third', 'autoExtStage2_3_Third', 'autoExtStage2_4_Third',
                    'autoExtStage3_1_Third'
                ];
                
                allFrameSelects.forEach(id => {
                    const select = document.getElementById(id);
                    if (select && select.value) {
                        configData.templates[id] = select.value;
                    }
                });
                
                // Add channel priority if enabled
                const priorityEnabled = document.getElementById('autoPriorityToggle').checked;
                if (priorityEnabled) {
                    configData.channelPriority = {
                        first: document.getElementById('autoFirstChannel').value,
                        second: document.getElementById('autoSecondChannel').value,
                        third: document.getElementById('autoThirdChannel').value
                    };
                }
            }
            
            // Store logic configuration
            configData.logicConfiguration = JSON.parse(JSON.stringify(logicData));
            
            // Store notification data
            if (!window.notificationData) {
                window.notificationData = {};
            }
            
            // Keep existing lastUpdated if exists, otherwise use current timestamp
            let lastUpdated = `${dateStr} ${timeStr}:00`;
            if (isUpdate && window.notificationData[notificationId] && window.notificationData[notificationId].lastUpdated) {
                // When updating, always use current timestamp
                lastUpdated = `${dateStr} ${timeStr}:00`;
            } else if (!isUpdate) {
                // When creating new, use current timestamp
                lastUpdated = `${dateStr} ${timeStr}:00`;
            }
            
            window.notificationData[notificationId] = {
                templateName: subjectLine || 'Untitled',
                channel: 'Multiple',
                recipientGroup: recipientGroup,
                creationMethod: 'Auto-triggered',
                status: status,
                configData: configData,
                logicConfiguration: configData.logicConfiguration,
                lastUpdated: lastUpdated
            };
            
            // Determine status badge class
            const statusClass = status === 'Draft' ? 'status-draft' : 'status-completed';
            
            if (isUpdate) {
                // Update existing row in table
                const tableBody = document.getElementById('notificationTableBody');
                const rows = tableBody.getElementsByTagName('tr');
                
                for (let row of rows) {
                    const actionButtons = row.querySelector('.table-actions');
                    if (actionButtons) {
                        const editBtn = actionButtons.querySelector(`button[onclick*="'${notificationId}'"]`);
                        if (editBtn) {
                            // Update the row
                            row.innerHTML = `
                                <td>${subjectLine || 'Untitled'}</td>
                                <td>Multiple</td>
                                <td>${recipientGroup}</td>
                                <td>Auto-triggered</td>
                                <td><span class="status-badge ${statusClass}">${status}</span></td>
                                <td>${lastUpdated}</td>
                                <td>
                                    <div class="table-actions">
                                        <button class="action-btn" onclick="previewNotification('${notificationId}')" title="Preview Notification"></button>
                                        <button class="action-btn" onclick="editNotification('${notificationId}')" title="Edit Notification"></button>
                                        <button class="action-btn" onclick="deleteNotification('${notificationId}')" title="Delete Notification"></button>
                                    </div>
                                </td>
                            `;
                            
                            // Add highlight effect
                            row.classList.add('highlight-row');
                            
                            // Scroll to row
                            row.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            
                            // Remove highlight after animation
                            setTimeout(() => {
                                row.classList.remove('highlight-row');
                            }, 2000);
                            
                            break;
                        }
                    }
                }
                
                showUpdateMessage('Auto-triggered notification updated successfully!', 'success');
            } else {
                // Add new row to table
                const tableBody = document.getElementById('notificationTableBody');
                const newRow = document.createElement('tr');
                newRow.innerHTML = `
                    <td>${subjectLine || 'Untitled'}</td>
                    <td>Multiple</td>
                    <td>${recipientGroup}</td>
                    <td>Auto-triggered</td>
                    <td><span class="status-badge ${statusClass}">${status}</span></td>
                    <td>${lastUpdated}</td>
                    <td>
                        <div class="table-actions">
                            <button class="action-btn" onclick="previewNotification('${notificationId}')" title="Preview Notification"></button>
                            <button class="action-btn" onclick="editNotification('${notificationId}')" title="Edit Notification"></button>
                            <button class="action-btn" onclick="deleteNotification('${notificationId}')" title="Delete Notification"></button>
                        </div>
                    </td>
                `;
                
                // Add highlight effect
                newRow.classList.add('highlight-row');
                
                // Insert at the top of the table
                if (tableBody.firstChild) {
                    tableBody.insertBefore(newRow, tableBody.firstChild);
                } else {
                    tableBody.appendChild(newRow);
                }
                
                // Scroll to top of table
                document.querySelector('.notification-table').scrollIntoView({ behavior: 'smooth', block: 'start' });
                
                // Remove highlight after animation completes
                setTimeout(() => {
                    newRow.classList.remove('highlight-row');
                }, 2000);
                
                // Show success message
                const message = status === 'Draft' 
                    ? 'Auto-triggered notification saved as draft successfully!' 
                    : 'Auto-triggered notification saved successfully!';
                showUpdateMessage(message, 'success');
            }
            
            // Close modal
            hideCreateAutoTriggeredModal();
            
            console.log('Auto-triggered notification saved:', notificationId, status, configData);
        }

        function saveAutoTriggeredNotification() {
            const selectedGroups = getSelectedAutoRecipientGroups();
            const recipientGroup = selectedGroups.join(', ');
            
            // Final validation
            if (selectedGroups.length === 0) {
                alert('Please select at least one recipient group');
                return;
            }
            
            let configData = {
                recipientGroup: recipientGroup,
                stages: {}
            };
            
            // Check which layout is active
            const internalLayout = document.getElementById('internalLayout');
            if (internalLayout.style.display === 'block') {
                // Internal layout
                const stage1 = document.getElementById('autoStage1Template').value;
                const stage2 = document.getElementById('autoStage2Template').value;
                const stage2_1Enabled = document.getElementById('enableStage2_1').checked;
                const stage2_1 = document.getElementById('autoStage2_1Template').value;
                const stage3 = document.getElementById('autoStage3Template').value;
                
                if (!stage1 || !stage2 || !stage3) {
                    alert('Please complete all required fields');
                    return;
                }
                
                configData.stages = {
                    stage1,
                    stage2,
                    stage2_1: stage2_1Enabled ? stage2_1 : null,
                    stage3
                };
            } else {
                // External layout
                const priorityEnabled = document.getElementById('autoPriorityToggle').checked;
                const channelPriority = priorityEnabled ? {
                    first: document.getElementById('autoFirstChannel').value,
                    second: document.getElementById('autoSecondChannel').value,
                    third: document.getElementById('autoThirdChannel').value
                } : null;
                
                // Collect all selected templates from grid
                const externalTemplates = {};
                const allSelectIds = [
                    'autoExtStage1_1_SMS', 'autoExtStage1_1_Email', 'autoExtStage1_1_App',
                    'autoExtStage1_2_SMS', 'autoExtStage1_2_Email', 'autoExtStage1_2_App',
                    'autoExtStage2_1_SMS', 'autoExtStage2_1_Email', 'autoExtStage2_1_App',
                    'autoExtStage2_2_SMS', 'autoExtStage2_2_Email', 'autoExtStage2_2_App',
                    'autoExtStage2_3_SMS', 'autoExtStage2_3_Email', 'autoExtStage2_3_App',
                    'autoExtStage2_4_SMS', 'autoExtStage2_4_Email', 'autoExtStage2_4_App',
                    'autoExtStage3_1_SMS', 'autoExtStage3_1_Email', 'autoExtStage3_1_App'
                ];
                
                allSelectIds.forEach(id => {
                    const value = document.getElementById(id).value;
                    if (value) {
                        externalTemplates[id] = value;
                    }
                });
                
                if (Object.keys(externalTemplates).length === 0) {
                    alert('Please select at least one template');
                    return;
                }
                
                configData.channelPriority = channelPriority;
                configData.templates = externalTemplates;
            }
            
            // Show success message
            showUpdateMessage('Auto-triggered notification configuration saved successfully!', 'success');
            
            // Close modal
            hideCreateAutoTriggeredModal();
            
            // In a real application, you would save this configuration to the server
            console.log('Auto-triggered notification config:', configData);
        }

        // Preview notification function
        function previewNotification(id) {
            console.log('Preview notification:', id);
            
            // Sample notification data (in real app, this would come from server)
            const notificationData = {
                'notif-1': {
                    templateName: '1st Notification',
                    channel: 'SMS',
                    recipientGroup: 'Internal',
                    creationMethod: 'Manual',
                    subjectLine: 'Power Outage Notification',
                    englishContent: '[CLP] A power outage report has been received for 14:00 at Yau Ma Tei, and your unit may be affected. Our maintenance personnel are on site to carry out repairs. During this period, the emergency service hotline may be busy. If you need assistance, please visit clp.com.hk to fill out the online form to contact us. We apologize for any inconvenience caused.',
                    chineseContent: '[] 14:00clp.com.hk'
                },
                'notif-2': {
                    templateName: '1st Notification',
                    channel: 'Email',
                    recipientGroup: 'Internal',
                    creationMethod: 'Manual',
                    subjectLine: 'Power Outage Notification',
                    englishContent: '[CLP] A power outage report has been received for 14:00 at Yau Ma Tei, and your unit may be affected. Our maintenance personnel are on site to carry out repairs. During this period, the emergency service hotline may be busy. If you need assistance, please visit clp.com.hk to fill out the online form to contact us. We apologize for any inconvenience caused.',
                    chineseContent: '[] 14:00clp.com.hk'
                },
                'notif-3': {
                    templateName: '1st Notification',
                    channel: 'TEAMS',
                    recipientGroup: 'Internal',
                    creationMethod: 'Auto-triggered',
                    subjectLine: '',
                    englishContent: '[CLP] A power outage report has been received for 14:00 at Yau Ma Tei, and your unit may be affected. Our maintenance personnel are on site to carry out repairs. During this period, the emergency service hotline may be busy. If you need assistance, please visit clp.com.hk to fill out the online form to contact us. We apologize for any inconvenience caused.',
                    chineseContent: '[] 14:00clp.com.hk'
                },
                'notif-4': {
                    templateName: '1st Notification',
                    channel: 'TEAMS',
                    recipientGroup: 'Internal',
                    creationMethod: 'Auto-triggered',
                    subjectLine: '',
                    englishContent: '[CLP] A power outage report has been received for 14:00 at Yau Ma Tei, and your unit may be affected. Our maintenance personnel are on site to carry out repairs. During this period, the emergency service hotline may be busy. If you need assistance, please visit clp.com.hk to fill out the online form to contact us. We apologize for any inconvenience caused.',
                    chineseContent: '[] 14:00clp.com.hk'
                },
                'notif-5': {
                    templateName: '1st Notification',
                    channel: 'TEAMS',
                    recipientGroup: 'Internal',
                    creationMethod: 'Manual',
                    subjectLine: '',
                    englishContent: '[CLP] A power outage report has been received for 14:00 at Yau Ma Tei, and your unit may be affected. Our maintenance personnel are on site to carry out repairs. During this period, the emergency service hotline may be busy. If you need assistance, please visit clp.com.hk to fill out the online form to contact us. We apologize for any inconvenience caused.',
                    chineseContent: '[] 14:00clp.com.hk'
                },
                'notif-6': {
                    templateName: '1st Notification',
                    channel: 'TEAMS',
                    recipientGroup: 'External-RT',
                    creationMethod: 'Auto-triggered',
                    subjectLine: '',
                    englishContent: '[CLP] A power outage report has been received for 14:00 at Yau Ma Tei, and your unit may be affected. Our maintenance personnel are on site to carry out repairs. During this period, the emergency service hotline may be busy. If you need assistance, please visit clp.com.hk to fill out the online form to contact us. We apologize for any inconvenience caused.',
                    chineseContent: '[] 14:00clp.com.hk'
                }
            };

            // Check if notification exists in dynamic storage (newly created drafts)
            let data;
            if (window.notificationData && window.notificationData[id]) {
                data = window.notificationData[id];
            } else {
                data = notificationData[id];
            }
            
            if (!data) {
                showUpdateMessage('Notification data not found', 'error');
                return;
            }

            // Check if it's Auto-triggered - show summary table
            if (data.creationMethod === 'Auto-triggered') {
                document.getElementById('autoTriggeredRecipientGroup').textContent = data.recipientGroup;
                document.getElementById('previewAutoTriggeredModal').classList.add('show');
                return;
            }

            // Manual notifications - show single preview
            // Update modal content
            document.getElementById('previewTemplateName').textContent = data.templateName;
            document.getElementById('previewChannel').textContent = data.channel;
            document.getElementById('previewRecipientGroup').textContent = data.recipientGroup;

            // Determine if it's an email channel
            const isEmail = data.channel === 'Email';

            // Update English content
            if (isEmail) {
                document.getElementById('englishRegularPreview').style.display = 'none';
                document.getElementById('englishEmailPreview').style.display = 'block';
                document.getElementById('englishEmailSubject').textContent = data.subjectLine;
                document.getElementById('englishEmailContentPreview').textContent = data.englishContent;
            } else {
                document.getElementById('englishRegularPreview').style.display = 'block';
                document.getElementById('englishEmailPreview').style.display = 'none';
                document.getElementById('englishContentPreview').textContent = data.englishContent;
            }

            // Update Chinese content
            if (isEmail) {
                document.getElementById('chineseRegularPreview').style.display = 'none';
                document.getElementById('chineseEmailPreview').style.display = 'block';
                document.getElementById('chineseEmailSubject').textContent = '';
                document.getElementById('chineseEmailContentPreview').textContent = data.chineseContent;
            } else {
                document.getElementById('chineseRegularPreview').style.display = 'block';
                document.getElementById('chineseEmailPreview').style.display = 'none';
                document.getElementById('chineseContentPreview').textContent = data.chineseContent;
            }

            // Reset to English tab
            switchPreviewLanguage('english');

            // Show modal
            document.getElementById('previewNotificationModal').classList.add('show');
        }

        function hidePreviewAutoTriggeredModal() {
            document.getElementById('previewAutoTriggeredModal').classList.remove('show');
        }

        function previewTemplateFromSummary(templateId) {
            console.log('Preview template from summary:', templateId);
            
            // Template data for each link
            const templateData = {
                'stage1-clp-sms': {
                    name: 'Power Outage - CLP Fault (SMS)',
                    channel: 'SMS',
                    recipientGroup: 'External-RT',
                    englishContent: '[CLP] A power outage has been reported at {{location}} at {{time}}. Your unit may be affected. Our maintenance team is on-site working on repairs. We apologize for any inconvenience.',
                    chineseContent: '[] {{location}}{{time}}'
                },
                'stage1-clp-email': {
                    name: 'Power Outage - CLP Fault (Email)',
                    channel: 'Email',
                    recipientGroup: 'External-RT',
                    subjectLine: 'Power Outage Notification - CLP Fault',
                    englishContent: 'Dear Customer,\n\nWe have received a power outage report at {{location}} at {{time}}. Your unit may be affected.\n\nOur maintenance personnel are currently on site carrying out repairs. During this period, the emergency service hotline may be busy. If you need assistance, please visit clp.com.hk to fill out the online form to contact us.\n\nWe apologize for any inconvenience caused.\n\nBest regards,\nCLP Power Hong Kong Limited',
                    chineseContent: '\n\n{{location}}{{time}}\n\nclp.com.hk\n\n\n\n'
                },
                'stage1-clp-app': {
                    name: 'Power Outage - CLP Fault (App)',
                    channel: 'App Push',
                    recipientGroup: 'External-RT',
                    englishContent: '[CLP] Power outage at {{location}} ({{time}}). Your unit may be affected. Repairs in progress. Visit clp.com.hk for assistance.',
                    chineseContent: '[] {{location}}({{time}})clp.com.hk'
                },
                'stage2-clp-sms': {
                    name: 'Repair In Progress - CLP (SMS)',
                    channel: 'SMS',
                    recipientGroup: 'External-RT',
                    englishContent: '[CLP] Update: Repair work is still in progress at {{location}}. Estimated restoration time: {{estimated_time}}. Thank you for your patience.',
                    chineseContent: '[] {{location}}{{estimated_time}}'
                },
                'stage3-completion-sms': {
                    name: 'Power Restored (SMS)',
                    channel: 'SMS',
                    recipientGroup: 'External-RT',
                    englishContent: '[CLP] Power has been restored at {{location}}. If you still experience issues, please contact us at 2678 2678. Thank you for your understanding.',
                    chineseContent: '[] {{location}}2678 2678'
                }
            };

            const template = templateData[templateId] || {
                name: 'Sample Template',
                channel: 'SMS',
                recipientGroup: 'External-RT',
                englishContent: 'This is a sample notification message.',
                chineseContent: ''
            };

            // Hide auto-triggered modal
            hidePreviewAutoTriggeredModal();

            // Show single template preview
            document.getElementById('previewTemplateName').textContent = template.name;
            document.getElementById('previewChannel').textContent = template.channel;
            document.getElementById('previewRecipientGroup').textContent = template.recipientGroup;

            const isEmail = template.channel === 'Email';

            // Update English content
            if (isEmail) {
                document.getElementById('englishRegularPreview').style.display = 'none';
                document.getElementById('englishEmailPreview').style.display = 'block';
                document.getElementById('englishEmailSubject').textContent = template.subjectLine || 'Notification';
                document.getElementById('englishEmailContentPreview').textContent = template.englishContent;
            } else {
                document.getElementById('englishRegularPreview').style.display = 'block';
                document.getElementById('englishEmailPreview').style.display = 'none';
                document.getElementById('englishContentPreview').textContent = template.englishContent;
            }

            // Update Chinese content
            if (isEmail) {
                document.getElementById('chineseRegularPreview').style.display = 'none';
                document.getElementById('chineseEmailPreview').style.display = 'block';
                document.getElementById('chineseEmailSubject').textContent = template.subjectLine || '';
                document.getElementById('chineseEmailContentPreview').textContent = template.chineseContent;
            } else {
                document.getElementById('chineseRegularPreview').style.display = 'block';
                document.getElementById('chineseEmailPreview').style.display = 'none';
                document.getElementById('chineseContentPreview').textContent = template.chineseContent;
            }

            // Reset to English tab
            switchPreviewLanguage('english');

            // Show modal
            document.getElementById('previewNotificationModal').classList.add('show');
        }

        function hidePreviewNotificationModal() {
            document.getElementById('previewNotificationModal').classList.remove('show');
        }

        function switchPreviewLanguage(language) {
            // Update tab buttons
            document.querySelectorAll('#previewNotificationModal .language-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target?.classList.add('active');

            // Show/hide content
            if (language === 'english') {
                document.getElementById('englishPreviewContent').classList.add('active');
                document.getElementById('chinesePreviewContent').classList.remove('active');
            } else {
                document.getElementById('englishPreviewContent').classList.remove('active');
                document.getElementById('chinesePreviewContent').classList.add('active');
            }
        }

        // Logic Configuration Functions
        let logicData = {
            stage1: { scenarios: [] },
            stage2: { scenarios: [] },
            stage3: { scenarios: [] }
        };

        let scenarioCounter = { stage1: 0, stage2: 0, stage3: 0 };
        let conditionCounter = { stage1: 0, stage2: 0, stage3: 0 };

        function toggleStageEdit(stageId) {
            const stageBody = document.getElementById(`logic${stageId.charAt(0).toUpperCase() + stageId.slice(1)}Body`);
            
            // Check if stage already has scenarios
            if (logicData[stageId].scenarios.length === 0) {
                // Add first scenario
                addScenario(stageId);
            }
        }

        function addScenario(stageId) {
            scenarioCounter[stageId]++;
            const scenarioId = `${stageId}_scenario${scenarioCounter[stageId]}`;
            
            const scenario = {
                id: scenarioId,
                name: `Scenario ${scenarioCounter[stageId]}`,
                conditions: []
            };
            
            logicData[stageId].scenarios.push(scenario);
            
            // Add first condition to the scenario
            addCondition(stageId, scenarioId);
            
            renderStage(stageId);
            updateLogicSummary(stageId);
        }

        function addCondition(stageId, scenarioId) {
            conditionCounter[stageId]++;
            const conditionId = `${stageId}_condition${conditionCounter[stageId]}`;
            
            const condition = {
                id: conditionId,
                name: `Condition ${conditionCounter[stageId]}`,
                enabled: true,
                dataPoint: '',
                operator: '',
                value: ''
            };
            
            const scenario = logicData[stageId].scenarios.find(s => s.id === scenarioId);
            if (scenario) {
                scenario.conditions.push(condition);
            }
            
            renderStage(stageId);
            updateLogicSummary(stageId);
        }

        function deleteCondition(stageId, scenarioId, conditionId) {
            const scenario = logicData[stageId].scenarios.find(s => s.id === scenarioId);
            if (scenario) {
                scenario.conditions = scenario.conditions.filter(c => c.id !== conditionId);
                
                // If no conditions left, delete the scenario
                if (scenario.conditions.length === 0) {
                    deleteScenario(stageId, scenarioId);
                    return;
                }
            }
            
            renderStage(stageId);
            updateLogicSummary(stageId);
        }

        function deleteScenario(stageId, scenarioId) {
            logicData[stageId].scenarios = logicData[stageId].scenarios.filter(s => s.id !== scenarioId);
            renderStage(stageId);
            updateLogicSummary(stageId);
        }

        function renderStage(stageId) {
            const stageBodyId = `logic${stageId.charAt(0).toUpperCase() + stageId.slice(1)}Body`;
            const stageBody = document.getElementById(stageBodyId);
            
            if (logicData[stageId].scenarios.length === 0) {
                stageBody.innerHTML = '';
                return;
            }
            
            let html = '';
            
            logicData[stageId].scenarios.forEach((scenario, scenarioIndex) => {
                if (scenarioIndex > 0) {
                    html += '<div class="scenario-divider">OR</div>';
                }
                
                html += `
                    <div class="scenario-container">
                        <div class="scenario-header">
                            <span class="scenario-title" id="${scenario.id}_title" onclick="editScenarioName('${stageId}', '${scenario.id}')">${scenario.name} </span>
                            <div>
                                <button class="btn-icon delete" onclick="deleteScenario('${stageId}', '${scenario.id}')" title="Delete Scenario"></button>
                            </div>
                        </div>
                `;
                
                scenario.conditions.forEach((condition, condIndex) => {
                    if (condIndex > 0) {
                        html += '<div class="logic-operator">AND</div>';
                    }
                    
                    html += `
                        <div class="condition-row">
                            <input type="checkbox" class="condition-checkbox" 
                                ${condition.enabled ? 'checked' : ''} 
                                onchange="toggleCondition('${stageId}', '${scenario.id}', '${condition.id}')">
                            <span class="condition-name" id="${condition.id}_name" onclick="editConditionName('${stageId}', '${scenario.id}', '${condition.id}')">${condition.name} </span>
                            <select class="condition-select" onchange="updateConditionField('${stageId}', '${scenario.id}', '${condition.id}', 'dataPoint', this.value)">
                                <option value="">Select Data Point</option>
                                <option value="incident_status" ${condition.dataPoint === 'incident_status' ? 'selected' : ''}>Incident Status</option>
                                <option value="status_remark" ${condition.dataPoint === 'status_remark' ? 'selected' : ''}>Status Remark</option>
                                <option value="system_generated_etr" ${condition.dataPoint === 'system_generated_etr' ? 'selected' : ''}>System Generated ETR</option>
                                <option value="affected_customers" ${condition.dataPoint === 'affected_customers' ? 'selected' : ''}>Affected Customers</option>
                                <option value="crew_status" ${condition.dataPoint === 'crew_status' ? 'selected' : ''}>Crew Status</option>
                                <option value="power_status" ${condition.dataPoint === 'power_status' ? 'selected' : ''}>Power Status</option>
                            </select>
                            <select class="condition-select" onchange="updateConditionField('${stageId}', '${scenario.id}', '${condition.id}', 'operator', this.value)">
                                <option value="">Operator</option>
                                <option value="equals" ${condition.operator === 'equals' ? 'selected' : ''}>=</option>
                                <option value="not_equals" ${condition.operator === 'not_equals' ? 'selected' : ''}>!=</option>
                                <option value="greater_than" ${condition.operator === 'greater_than' ? 'selected' : ''}>></option>
                                <option value="less_than" ${condition.operator === 'less_than' ? 'selected' : ''}><</option>
                                <option value="contains" ${condition.operator === 'contains' ? 'selected' : ''}>contains</option>
                            </select>`;
                    
                    // Add value field - dropdown for certain data points, text input for others
                    const valueFieldId = `${condition.id}_value`;
                    if (condition.dataPoint === 'incident_status') {
                        html += `
                            <select class="condition-select" id="${valueFieldId}" onchange="updateConditionField('${stageId}', '${scenario.id}', '${condition.id}', 'value', this.value)">
                                <option value="">Select Value</option>
                                <option value="New" ${condition.value === 'New' ? 'selected' : ''}>New</option>
                                <option value="Dispatched" ${condition.value === 'Dispatched' ? 'selected' : ''}>Dispatched</option>
                                <option value="Suspended" ${condition.value === 'Suspended' ? 'selected' : ''}>Suspended</option>
                                <option value="In Progress" ${condition.value === 'In Progress' ? 'selected' : ''}>In Progress</option>
                                <option value="Site restored" ${condition.value === 'Site restored' ? 'selected' : ''}>Site restored</option>
                                <option value="Field completed" ${condition.value === 'Field completed' ? 'selected' : ''}>Field completed</option>
                                <option value="Cancelled" ${condition.value === 'Cancelled' ? 'selected' : ''}>Cancelled</option>
                                <option value="Closed" ${condition.value === 'Closed' ? 'selected' : ''}>Closed</option>
                            </select>`;
                    } else if (condition.dataPoint === 'status_remark') {
                        html += `
                            <select class="condition-select" id="${valueFieldId}" onchange="updateConditionField('${stageId}', '${scenario.id}', '${condition.id}', 'value', this.value)">
                                <option value="">Select Value</option>
                                <option value="Confirmed" ${condition.value === 'Confirmed' ? 'selected' : ''}>Confirmed</option>
                                <option value="Unconfirmed" ${condition.value === 'Unconfirmed' ? 'selected' : ''}>Unconfirmed</option>
                            </select>`;
                    } else if (condition.dataPoint === 'crew_status') {
                        html += `
                            <select class="condition-select" id="${valueFieldId}" onchange="updateConditionField('${stageId}', '${scenario.id}', '${condition.id}', 'value', this.value)">
                                <option value="">Select Value</option>
                                <option value="Assigned" ${condition.value === 'Assigned' ? 'selected' : ''}>Assigned</option>
                                <option value="Accepted" ${condition.value === 'Accepted' ? 'selected' : ''}>Accepted</option>
                                <option value="On route" ${condition.value === 'On route' ? 'selected' : ''}>On route</option>
                                <option value="Rejected" ${condition.value === 'Rejected' ? 'selected' : ''}>Rejected</option>
                                <option value="Arrived" ${condition.value === 'Arrived' ? 'selected' : ''}>Arrived</option>
                                <option value="Working" ${condition.value === 'Working' ? 'selected' : ''}>Working</option>
                                <option value="Completed" ${condition.value === 'Completed' ? 'selected' : ''}>Completed</option>
                                <option value="Re-assigned" ${condition.value === 'Re-assigned' ? 'selected' : ''}>Re-assigned</option>
                            </select>`;
                    } else if (condition.dataPoint === 'power_status') {
                        html += `
                            <select class="condition-select" id="${valueFieldId}" onchange="updateConditionField('${stageId}', '${scenario.id}', '${condition.id}', 'value', this.value)">
                                <option value="">Select Value</option>
                                <option value="NoOutage" ${condition.value === 'NoOutage' ? 'selected' : ''}>NoOutage</option>
                                <option value="Restored" ${condition.value === 'Restored' ? 'selected' : ''}>Restored</option>
                                <option value="Not restored" ${condition.value === 'Not restored' ? 'selected' : ''}>Not restored</option>
                                <option value="PartiallyRestored" ${condition.value === 'PartiallyRestored' ? 'selected' : ''}>PartiallyRestored</option>
                            </select>`;
                    } else {
                        // Text input for integer values (System Generated ETR, Affected Customers)
                        html += `
                            <input type="text" class="condition-input" id="${valueFieldId}" placeholder="Enter Value" 
                                value="${condition.value}" 
                                onchange="updateConditionField('${stageId}', '${scenario.id}', '${condition.id}', 'value', this.value)">`;
                    }
                    
                    html += `
                            <button class="btn-icon delete" onclick="deleteCondition('${stageId}', '${scenario.id}', '${condition.id}')" title="Delete Condition"></button>
                        </div>
                    `;
                });
                
                html += `
                        <button class="btn-add-condition" onclick="addCondition('${stageId}', '${scenario.id}')">+ Add Condition (AND)</button>
                    </div>
                `;
            });
            
            html += `<button class="btn-add-scenario" onclick="addScenario('${stageId}')">+ Add Scenario (OR)</button>`;
            
            stageBody.innerHTML = html;
        }

        function editScenarioName(stageId, scenarioId) {
            const scenario = logicData[stageId].scenarios.find(s => s.id === scenarioId);
            if (!scenario) return;
            
            const titleEl = document.getElementById(`${scenarioId}_title`);
            const currentName = scenario.name;
            
            titleEl.innerHTML = `<input type="text" class="scenario-title-input" id="${scenarioId}_input" value="${currentName}">`;
            
            const inputEl = document.getElementById(`${scenarioId}_input`);
            inputEl.focus();
            inputEl.select();
            
            inputEl.addEventListener('blur', function() {
                finishEditScenarioName(stageId, scenarioId);
            });
            
            inputEl.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    finishEditScenarioName(stageId, scenarioId);
                }
            });
        }

        function finishEditScenarioName(stageId, scenarioId) {
            const inputEl = document.getElementById(`${scenarioId}_input`);
            if (!inputEl) return;
            
            const newName = inputEl.value.trim() || 'Scenario';
            const scenario = logicData[stageId].scenarios.find(s => s.id === scenarioId);
            if (scenario) {
                scenario.name = newName;
            }
            
            renderStage(stageId);
            updateLogicSummary(stageId);
        }

        function editConditionName(stageId, scenarioId, conditionId) {
            const scenario = logicData[stageId].scenarios.find(s => s.id === scenarioId);
            if (!scenario) return;
            
            const condition = scenario.conditions.find(c => c.id === conditionId);
            if (!condition) return;
            
            const nameEl = document.getElementById(`${conditionId}_name`);
            const currentName = condition.name;
            
            nameEl.innerHTML = `<input type="text" class="condition-name-input" id="${conditionId}_input" value="${currentName}">`;
            
            const inputEl = document.getElementById(`${conditionId}_input`);
            inputEl.focus();
            inputEl.select();
            
            inputEl.addEventListener('blur', function() {
                finishEditConditionName(stageId, scenarioId, conditionId);
            });
            
            inputEl.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    finishEditConditionName(stageId, scenarioId, conditionId);
                }
            });
        }

        function finishEditConditionName(stageId, scenarioId, conditionId) {
            const inputEl = document.getElementById(`${conditionId}_input`);
            if (!inputEl) return;
            
            const newName = inputEl.value.trim() || 'Condition';
            const scenario = logicData[stageId].scenarios.find(s => s.id === scenarioId);
            if (scenario) {
                const condition = scenario.conditions.find(c => c.id === conditionId);
                if (condition) {
                    condition.name = newName;
                }
            }
            
            renderStage(stageId);
            updateLogicSummary(stageId);
        }

        function toggleCondition(stageId, scenarioId, conditionId) {
            const scenario = logicData[stageId].scenarios.find(s => s.id === scenarioId);
            if (scenario) {
                const condition = scenario.conditions.find(c => c.id === conditionId);
                if (condition) {
                    condition.enabled = !condition.enabled;
                    updateLogicSummary(stageId);
                }
            }
        }

        function updateConditionField(stageId, scenarioId, conditionId, field, value) {
            const scenario = logicData[stageId].scenarios.find(s => s.id === scenarioId);
            if (scenario) {
                const condition = scenario.conditions.find(c => c.id === conditionId);
                if (condition) {
                    condition[field] = value;
                    
                    // If data point changed, clear the value and re-render to show appropriate value field
                    if (field === 'dataPoint') {
                        condition.value = '';
                        renderStage(stageId);
                    }
                    
                    updateLogicSummary(stageId);
                }
            }
        }

        function updateLogicSummary(stageId) {
            const summaryId = `logicSummary${stageId.charAt(0).toUpperCase() + stageId.slice(1)}`;
            const summaryEl = document.getElementById(summaryId);
            
            if (logicData[stageId].scenarios.length === 0) {
                summaryEl.innerHTML = 'No conditions configured.';
                return;
            }
            
            let html = '';
            
            logicData[stageId].scenarios.forEach((scenario, scenarioIndex) => {
                if (scenarioIndex > 0) {
                    html += '<div style="margin: 8px 0; font-weight: 600; color: #1976d2;">OR</div>';
                }
                
                html += `<div style="margin-bottom: 12px;">`;
                html += `<strong style="color: #1976d2;">${scenario.name}:</strong><br>`;
                
                const enabledConditions = scenario.conditions.filter(c => c.enabled);
                
                if (enabledConditions.length === 0) {
                    html += `<span style="color: #999; font-style: italic; margin-left: 16px;">No active conditions</span>`;
                } else {
                    enabledConditions.forEach((condition, condIndex) => {
                        if (condIndex > 0) {
                            html += '<span style="font-weight: 600; color: #666; margin: 0 4px;">AND</span>';
                        }
                        
                        const dataPointText = condition.dataPoint.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                        
                        // Map operator values to symbols
                        const operatorSymbols = {
                            'equals': '=',
                            'not_equals': '!=',
                            'greater_than': '>',
                            'less_than': '<',
                            'contains': 'contains'
                        };
                        const operatorText = operatorSymbols[condition.operator] || '?';
                        
                        html += `<span style="margin-left: 16px;">${condition.name}: <em>${dataPointText || '?'} ${operatorText} "${condition.value || '?'}"</em></span>`;
                    });
                }
                
                html += `</div>`;
            });
            
            summaryEl.innerHTML = html;
        }

        function saveLogicConfiguration() {
            // Validate that at least one stage has configuration
            const hasConfig = logicData.stage1.scenarios.length > 0 || 
                            logicData.stage2.scenarios.length > 0 || 
                            logicData.stage3.scenarios.length > 0;
            
            if (!hasConfig) {
                alert('Please configure at least one stage with conditions before saving.');
                return;
            }
            
            showUpdateMessage('Logic configuration saved successfully!', 'success');
            console.log('Logic configuration saved:', logicData);
        }

        // Show update message
        function showUpdateMessage(message, type = 'success') {
            const messageEl = document.getElementById('updateMessage');
            messageEl.textContent = message;
            messageEl.className = `update-message ${type} show`;
            
            setTimeout(() => {
                messageEl.classList.remove('show');
            }, type === 'error' ? 5000 : 3000);
        }

        // Close modal when clicking outside
        document.querySelectorAll('.modal-overlay').forEach(overlay => {
            overlay.addEventListener('click', function(e) {
                if (e.target === this) {
                    // Handle different modal types
                    if (this.id === 'templateFilterModal') {
                        hideTemplateFilterModal();
                    } else if (this.id === 'createManualNotificationModal') {
                        hideCreateManualNotificationModal();
                    } else {
                        this.classList.remove('show');
                    }
                }
            });
        });

        // Recipient Group Multi-Select Functions (for Manual Notification section)
        function toggleManualRecipientGroupDropdown(selectId) {
            const select = document.getElementById(selectId);
            const isOpen = select.classList.contains('open');
            
            // Close all recipient group dropdowns
            document.querySelectorAll('.recipient-group-select').forEach(dropdown => {
                dropdown.classList.remove('open');
            });
            
            // Toggle current dropdown
            if (!isOpen) {
                select.classList.add('open');
            }
        }

        function updateManualRecipientSelection() {
            const internalCheckbox = document.getElementById('manualInternal');
            const externalRTCheckbox = document.getElementById('manualExternalRT');
            const externalNRTCheckbox = document.getElementById('manualExternalNRT');
            const displayEl = document.getElementById('manualRecipientDisplay');
            
            // Get which checkbox was just changed
            const clickedCheckbox = event ? event.target : null;
            
            // Enforce mutual exclusivity: Internal OR External groups
            if (clickedCheckbox) {
                if (clickedCheckbox.id === 'manualInternal' && clickedCheckbox.checked) {
                    // If Internal is checked, uncheck all External
                    externalRTCheckbox.checked = false;
                    externalNRTCheckbox.checked = false;
                } else if ((clickedCheckbox.id === 'manualExternalRT' || clickedCheckbox.id === 'manualExternalNRT') && clickedCheckbox.checked) {
                    // If any External is checked, uncheck Internal
                    internalCheckbox.checked = false;
                }
            }
            
            // Get all checked checkboxes after enforcement
            const checkboxes = ['manualInternal', 'manualExternalRT', 'manualExternalNRT'];
            const checked = checkboxes.filter(id => document.getElementById(id).checked);
            
            if (checked.length === 0) {
                displayEl.textContent = 'Select';
                displayEl.classList.add('placeholder');
            } else {
                const labels = checked.map(id => document.querySelector(`label[for="${id}"]`).textContent);
                displayEl.textContent = labels.join(', ');
                displayEl.classList.remove('placeholder');
            }
            
            // Update available channels based on selected recipient groups
            const selectedGroups = getSelectedManualRecipientGroups();
            updateManualChannelOptions(selectedGroups);
        }

        function updateAutoRecipientSelection() {
            console.log('=== updateAutoRecipientSelection called ===');
            
            const internalCheckbox = document.getElementById('autoInternal');
            const externalRTCheckbox = document.getElementById('autoExternalRT');
            const externalNRTCheckbox = document.getElementById('autoExternalNRT');
            const displayEl = document.getElementById('autoRecipientDisplay');
            
            console.log('Checkbox elements found:', {
                internal: internalCheckbox,
                externalRT: externalRTCheckbox,
                externalNRT: externalNRTCheckbox,
                display: displayEl
            });
            
            // Get which checkbox was just changed
            const clickedCheckbox = event ? event.target : null;
            console.log('Clicked checkbox:', clickedCheckbox);
            
            // Enforce mutual exclusivity: Internal OR External groups
            if (clickedCheckbox) {
                if (clickedCheckbox.id === 'autoInternal' && clickedCheckbox.checked) {
                    // If Internal is checked, uncheck all External
                    externalRTCheckbox.checked = false;
                    externalNRTCheckbox.checked = false;
                    console.log('Internal checked - unchecked External groups');
                } else if ((clickedCheckbox.id === 'autoExternalRT' || clickedCheckbox.id === 'autoExternalNRT') && clickedCheckbox.checked) {
                    // If any External is checked, uncheck Internal
                    internalCheckbox.checked = false;
                    console.log('External checked - unchecked Internal');
                }
            }
            
            // Get all checked checkboxes after enforcement
            const checkboxes = ['autoInternal', 'autoExternalRT', 'autoExternalNRT'];
            const checked = checkboxes.filter(id => document.getElementById(id).checked);
            console.log('Checked checkboxes:', checked);
            
            if (checked.length === 0) {
                displayEl.textContent = 'Select';
                displayEl.classList.add('placeholder');
            } else {
                const labels = checked.map(id => document.querySelector(`label[for="${id}"]`).textContent);
                displayEl.textContent = labels.join(', ');
                displayEl.classList.remove('placeholder');
                console.log('Display updated to:', displayEl.textContent);
            }
            
            // Toggle between Internal and External layouts
            const internalLayout = document.getElementById('internalLayout');
            const externalLayout = document.getElementById('externalLayout');
            
            console.log('Layout elements:', { internalLayout, externalLayout });
            
            if (internalCheckbox.checked) {
                // Show Internal layout
                internalLayout.style.display = 'block';
                externalLayout.style.display = 'none';
                console.log('Showing Internal layout');
            } else if (externalRTCheckbox.checked || externalNRTCheckbox.checked) {
                // Show External layout
                internalLayout.style.display = 'none';
                externalLayout.style.display = 'block';
                console.log('Showing External layout');
            } else {
                // Hide both if nothing selected
                internalLayout.style.display = 'none';
                externalLayout.style.display = 'none';
                console.log('Hiding all layouts');
            }
            
            // Update template options based on selected recipient groups
            updateAutoStageTemplates();
        }

        function getSelectedManualRecipientGroups() {
            const checkboxes = ['manualInternal', 'manualExternalRT', 'manualExternalNRT'];
            return checkboxes
                .filter(id => document.getElementById(id).checked)
                .map(id => document.getElementById(id).value);
        }

        function getSelectedAutoRecipientGroups() {
            const checkboxes = ['autoInternal', 'autoExternalRT', 'autoExternalNRT'];
            return checkboxes
                .filter(id => document.getElementById(id).checked)
                .map(id => document.getElementById(id).value);
        }

        // Close recipient group dropdowns when clicking outside
        document.addEventListener('click', function(event) {
            if (!event.target.closest('.recipient-group-select')) {
                document.querySelectorAll('.recipient-group-select').forEach(dropdown => {
                    dropdown.classList.remove('open');
                });
            }
        });

        function updateManualChannelOptions() {
            const selectedGroups = getSelectedManualRecipientGroups();
            const channelSelect = document.getElementById('manualNotificationChannel');
            const currentChannel = channelSelect.value;
            
            // Clear all options
            channelSelect.innerHTML = '<option value="">Select</option>';
            
            if (selectedGroups.length === 0) {
                return;
            }
            
            // Determine available channels based on validation matrix
            // 4 valid options:
            // a. Internal  TEAMS, Email
            // b. External-RT  SMS, Email, App Push
            // c. External-NRT  SMS, Email, App Push
            // d. External-RT + External-NRT  SMS, Email, App Push
            let availableChannels = [];
            
            const hasInternal = selectedGroups.includes('Internal');
            const hasExternal = selectedGroups.includes('External-RT') || selectedGroups.includes('External-NRT');
            
            if (hasInternal) {
                // Option a: Internal only
                availableChannels = ['TEAMS', 'Email'];
            } else if (hasExternal) {
                // Options b, c, d: Any External combination
                availableChannels = ['SMS', 'Email', 'App Push'];
            }
            
            // Populate channel options
            availableChannels.forEach(channel => {
                const option = document.createElement('option');
                option.value = channel;
                option.textContent = channel;
                channelSelect.appendChild(option);
            });
            
            // Restore previous selection if still valid
            if (currentChannel && availableChannels.includes(currentChannel)) {
                channelSelect.value = currentChannel;
            }
        }

        // Create Manual Notification Modal Functions
        function showCreateManualNotificationModal() {
            // Reset edit mode
            isEditMode = false;
            editingNotificationId = null;
            
            // Set title to Create mode
            document.getElementById('manualNotificationModalTitle').textContent = 'Create Manual Notification';
            
            document.getElementById('createManualNotificationModal').style.display = 'flex';
            
            // Reset form
            document.getElementById('manualPowerIncident').value = '';
            document.getElementById('powerIncidentDisplay').textContent = 'Select Incident ID';
            
            // Reset recipient group checkboxes
            document.getElementById('manualInternal').checked = false;
            document.getElementById('manualExternalRT').checked = false;
            document.getElementById('manualExternalNRT').checked = false;
            document.getElementById('manualRecipientDisplay').textContent = 'Select';
            document.getElementById('manualRecipientDisplay').classList.add('placeholder');
            
            document.getElementById('manualSubjectLine').value = '';
            document.getElementById('manualEnglishContent').value = '';
            document.getElementById('manualChineseContent').value = '';
            document.getElementById('applyTemplateToggle').checked = false;
            document.getElementById('templateSelectionRow').style.display = 'none';
            
            // Reset channel dropdown to empty (no options except default)
            const channelSelect = document.getElementById('manualNotificationChannel');
            channelSelect.innerHTML = '<option value="">Select</option>';
            
            // Show English tab by default
            document.getElementById('manualEnglishInlineTab').classList.add('active');
            document.getElementById('manualChineseInlineTab').classList.remove('active');
            document.getElementById('manualEnglishContainer').classList.add('active');
            document.getElementById('manualChineseContainer').classList.remove('active');
            
            // Reset character counters (no max shown initially)
            document.getElementById('manualEnglishCount').parentElement.innerHTML = '<span id="manualEnglishCount">0</span>';
            document.getElementById('manualChineseCount').parentElement.innerHTML = '<span id="manualChineseCount">0</span>';
            
            // Setup event listeners
            setupManualCharacterCounting();
            setupManualVariableDragDrop();
        }

        function hideCreateManualNotificationModal() {
            document.getElementById('createManualNotificationModal').style.display = 'none';
            // Reset edit mode
            isEditMode = false;
            editingNotificationId = null;
        }

        function switchManualLanguageTab(language) {
            // Update tab buttons
            const englishTab = document.getElementById('manualEnglishInlineTab');
            const chineseTab = document.getElementById('manualChineseInlineTab');
            
            if (language === 'english') {
                englishTab.classList.add('active');
                chineseTab.classList.remove('active');
                document.getElementById('manualEnglishContainer').classList.add('active');
                document.getElementById('manualChineseContainer').classList.remove('active');
            } else {
                englishTab.classList.remove('active');
                chineseTab.classList.add('active');
                document.getElementById('manualEnglishContainer').classList.remove('active');
                document.getElementById('manualChineseContainer').classList.add('active');
            }
        }

        // New function for single-select recipient group
        function handleManualRecipientChangeSingle() {
            const recipientSelect = document.getElementById('manualRecipientGroupSingle');
            const selectedGroup = recipientSelect.value;
            
            // Update channel options based on selection
            updateManualChannelOptionsSingle(selectedGroup);
        }

        function updateManualChannelOptionsSingle(selectedGroup) {
            const channelSelect = document.getElementById('manualNotificationChannel');
            const currentChannel = channelSelect.value;
            
            // Clear current options except the default
            channelSelect.innerHTML = '<option value="">Select</option>';
            
            let allowedChannels = [];
            
            if (!selectedGroup) {
                // If no group selected, disable all channels
                allowedChannels = [];
            } else if (selectedGroup === 'Internal') {
                // Internal group selected: Only TEAMS and Email
                allowedChannels = ['TEAMS', 'Email'];
            } else if (selectedGroup.startsWith('External-')) {
                // External groups selected: Email, SMS, App Push
                allowedChannels = ['Email', 'SMS', 'App Push'];
            }
            
            // Add allowed channels to select
            allowedChannels.forEach(channel => {
                const option = document.createElement('option');
                option.value = channel;
                option.textContent = channel;
                channelSelect.appendChild(option);
            });
            
            // Reset channel selection if current selection is not allowed
            if (currentChannel && !allowedChannels.includes(currentChannel)) {
                channelSelect.value = '';
            } else if (currentChannel && allowedChannels.includes(currentChannel)) {
                // Restore the previous selection if still valid
                channelSelect.value = currentChannel;
            }
        }

        // Toggle template selection
        function toggleTemplateSelection() {
            const toggle = document.getElementById('applyTemplateToggle');
            const templateRow = document.getElementById('templateSelectionRow');
            
            if (toggle.checked) {
                templateRow.style.display = 'block';
            } else {
                templateRow.style.display = 'none';
            }
        }

        // Searchable Dropdown Functions
        function toggleSearchableDropdown(dropdownId) {
            const dropdown = document.getElementById(dropdownId + 'Dropdown');
            const isOpen = dropdown.classList.contains('open');
            
            // Close all other searchable dropdowns
            document.querySelectorAll('.searchable-dropdown').forEach(d => {
                d.classList.remove('open');
            });
            
            // Toggle current dropdown
            if (!isOpen) {
                dropdown.classList.add('open');
                // Focus on search input
                const searchInput = document.getElementById(dropdownId + 'Search');
                if (searchInput) {
                    setTimeout(() => searchInput.focus(), 100);
                }
            }
        }

        function selectPowerIncident(incidentId, displayText) {
            // Update hidden input value
            document.getElementById('manualPowerIncident').value = incidentId;
            
            // Update display text
            document.getElementById('powerIncidentDisplay').textContent = displayText;
            
            // Close dropdown
            document.getElementById('powerIncidentDropdown').classList.remove('open');
            
            // Clear search
            document.getElementById('powerIncidentSearch').value = '';
            
            // Show all options again
            const options = document.querySelectorAll('#powerIncidentOptions .dropdown-option');
            options.forEach(option => option.classList.remove('hidden'));
        }

        function filterPowerIncidents() {
            const searchInput = document.getElementById('powerIncidentSearch');
            const filter = searchInput.value.toLowerCase();
            const options = document.querySelectorAll('#powerIncidentOptions .dropdown-option');
            
            options.forEach(option => {
                const text = option.textContent.toLowerCase();
                if (text.includes(filter)) {
                    option.classList.remove('hidden');
                } else {
                    option.classList.add('hidden');
                }
            });
        }

        // Close searchable dropdowns when clicking outside
        document.addEventListener('click', function(event) {
            if (!event.target.closest('.searchable-dropdown')) {
                document.querySelectorAll('.searchable-dropdown').forEach(dropdown => {
                    dropdown.classList.remove('open');
                });
            }
        });

        // Template Filtering Functions
        function showTemplateFilterModal() {
            document.getElementById('templateFilterModal').style.display = 'flex';
            
            // Reset all checkboxes to unchecked
            document.querySelectorAll('#templateFilterModal .filter-checkbox').forEach(checkbox => {
                checkbox.checked = false;
            });
        }

        function hideTemplateFilterModal() {
            document.getElementById('templateFilterModal').style.display = 'none';
        }

        function updateTemplateFilterUI() {
            // This function can be used to provide visual feedback when filters are selected
            // Currently just for UX - the actual filtering happens on Apply
        }

        function applyTemplateFilter() {
            // Get selected filters
            const selectedRecipientGroups = Array.from(
                document.querySelectorAll('input[name="filterRecipientGroup"]:checked')
            ).map(cb => cb.value);
            
            const selectedChannels = Array.from(
                document.querySelectorAll('input[name="filterChannel"]:checked')
            ).map(cb => cb.value);
            
            // Get the template select dropdown
            const templateSelect = document.getElementById('templateSelect');
            const allOptions = templateSelect.querySelectorAll('option[data-recipient]');
            
            // If no filters selected, show all templates
            if (selectedRecipientGroups.length === 0 && selectedChannels.length === 0) {
                allOptions.forEach(option => {
                    option.style.display = '';
                });
                hideTemplateFilterModal();
                return;
            }
            
            // Filter templates based on selected criteria
            let visibleCount = 0;
            allOptions.forEach(option => {
                const optionRecipient = option.getAttribute('data-recipient');
                const optionChannel = option.getAttribute('data-channel');
                
                let matchesRecipient = selectedRecipientGroups.length === 0 || 
                                      selectedRecipientGroups.includes(optionRecipient);
                let matchesChannel = selectedChannels.length === 0 || 
                                    selectedChannels.includes(optionChannel);
                
                if (matchesRecipient && matchesChannel) {
                    option.style.display = '';
                    visibleCount++;
                } else {
                    option.style.display = 'none';
                }
            });
            
            // Reset selection if current selection is now hidden
            const currentValue = templateSelect.value;
            if (currentValue) {
                const currentOption = templateSelect.querySelector(`option[value="${currentValue}"]`);
                if (currentOption && currentOption.style.display === 'none') {
                    templateSelect.value = '';
                }
            }
            
            // Show success message with count
            const filterSummary = [];
            if (selectedRecipientGroups.length > 0) {
                filterSummary.push(`Recipient: ${selectedRecipientGroups.join(', ')}`);
            }
            if (selectedChannels.length > 0) {
                filterSummary.push(`Channel: ${selectedChannels.join(', ')}`);
            }
            
            showUpdateMessage(
                `Filter applied: ${filterSummary.join(' | ')} - ${visibleCount} template(s) available`,
                'success'
            );
            
            hideTemplateFilterModal();
        }

        // Validation Matrix Logic (keeping old function for backward compatibility)
        function handleManualRecipientChange() {
            const checkboxes = document.querySelectorAll('input[name="manualRecipientGroup"]');
            const changedCheckbox = event.target;
            const changedValue = changedCheckbox.value;
            const isChecked = changedCheckbox.checked;
            
            // Handle mutual exclusivity: Cannot select Internal and External at the same time
            if (isChecked) {
                if (changedValue === 'Internal') {
                    // If Internal is selected, uncheck all External groups
                    checkboxes.forEach(checkbox => {
                        if (checkbox.value.startsWith('External-') && checkbox.checked) {
                            checkbox.checked = false;
                        }
                    });
                } else if (changedValue.startsWith('External-')) {
                    // If External group is selected, uncheck Internal
                    checkboxes.forEach(checkbox => {
                        if (checkbox.value === 'Internal' && checkbox.checked) {
                            checkbox.checked = false;
                        }
                    });
                }
            }
            
            // Update display text
            const selectedGroups = Array.from(checkboxes).filter(cb => cb.checked).map(cb => cb.value);
            const display = document.getElementById('manualRecipientGroupDisplay');
            if (selectedGroups.length === 0) {
                display.textContent = 'Select recipient group';
            } else {
                display.textContent = selectedGroups.join(', ');
            }
            
            // Apply validation matrix and update available channels
            updateManualChannelOptions(selectedGroups);
        }

        function updateManualChannelOptions(selectedGroups) {
            const channelSelect = document.getElementById('manualNotificationChannel');
            const currentChannel = channelSelect.value;
            
            // Clear current options except the default
            channelSelect.innerHTML = '<option value="">Select channel</option>';
            
            let allowedChannels = [];
            
            if (selectedGroups.length === 0) {
                // If no groups selected, disable all channels
                allowedChannels = [];
            } else if (selectedGroups.includes('Internal')) {
                // Internal group selected: Only TEAMS and Email
                allowedChannels = ['TEAMS', 'Email'];
            } else if (selectedGroups.some(group => group.startsWith('External-'))) {
                // External groups selected: Email, SMS, App Push
                allowedChannels = ['Email', 'SMS', 'App Push'];
            }
            
            // Add allowed channels to select
            allowedChannels.forEach(channel => {
                const option = document.createElement('option');
                option.value = channel;
                option.textContent = channel;
                channelSelect.appendChild(option);
            });
            
            // Reset channel selection if current selection is not allowed
            if (currentChannel && !allowedChannels.includes(currentChannel)) {
                channelSelect.value = '';
                document.getElementById('manualSubjectLineGroup').style.display = 'none';
            } else if (currentChannel && allowedChannels.includes(currentChannel)) {
                // Restore the previous selection if still valid
                channelSelect.value = currentChannel;
            }
        }

        function handleManualChannelChange() {
            const channel = document.getElementById('manualNotificationChannel').value;
            
            // Subject line is always visible
            
            // Update character limits and counter display based on channel
            updateManualCharacterLimits(channel);
        }

        function updateManualCharacterLimits(channel) {
            const englishTextarea = document.getElementById('manualEnglishContent');
            const chineseTextarea = document.getElementById('manualChineseContent');
            const englishCounterSpan = document.getElementById('manualEnglishCount');
            const chineseCounterSpan = document.getElementById('manualChineseCount');
            
            let maxLength;
            let showMax = false; // Only show max for SMS and App Push
            
            if (channel === 'SMS' || channel === 'App Push') {
                maxLength = 160;
                showMax = true;
            } else {
                // TEAMS, Email, or no channel selected - no maxlength
                maxLength = null;
                showMax = false;
            }
            
            // Update maxlength attributes
            if (maxLength) {
                englishTextarea.setAttribute('maxlength', maxLength);
                chineseTextarea.setAttribute('maxlength', maxLength);
            } else {
                englishTextarea.removeAttribute('maxlength');
                chineseTextarea.removeAttribute('maxlength');
            }
            
            // Update counter display
            const englishLength = englishTextarea.value.length;
            const chineseLength = chineseTextarea.value.length;
            
            if (showMax) {
                englishCounterSpan.textContent = englishLength;
                englishCounterSpan.parentElement.innerHTML = `<span id="manualEnglishCount">${englishLength}</span>/${maxLength}`;
                
                chineseCounterSpan.textContent = chineseLength;
                chineseCounterSpan.parentElement.innerHTML = `<span id="manualChineseCount">${chineseLength}</span>/${maxLength}`;
            } else {
                englishCounterSpan.textContent = englishLength;
                englishCounterSpan.parentElement.innerHTML = `<span id="manualEnglishCount">${englishLength}</span>`;
                
                chineseCounterSpan.textContent = chineseLength;
                chineseCounterSpan.parentElement.innerHTML = `<span id="manualChineseCount">${chineseLength}</span>`;
            }
            
            // Update warning/danger classes
            updateManualCounterColors();
        }

        function updateManualCounterColors() {
            const channel = document.getElementById('manualNotificationChannel').value;
            const englishTextarea = document.getElementById('manualEnglishContent');
            const chineseTextarea = document.getElementById('manualChineseContent');
            const englishCounter = document.getElementById('manualEnglishCount').parentElement;
            const chineseCounter = document.getElementById('manualChineseCount').parentElement;
            
            if (channel === 'SMS' || channel === 'App Push') {
                const maxLength = 160;
                
                // English counter
                englishCounter.classList.remove('warning', 'danger');
                const englishLength = englishTextarea.value.length;
                if (englishLength > maxLength * 0.9) {
                    englishCounter.classList.add('danger');
                } else if (englishLength > maxLength * 0.8) {
                    englishCounter.classList.add('warning');
                }
                
                // Chinese counter
                chineseCounter.classList.remove('warning', 'danger');
                const chineseLength = chineseTextarea.value.length;
                if (chineseLength > maxLength * 0.9) {
                    chineseCounter.classList.add('danger');
                } else if (chineseLength > maxLength * 0.8) {
                    chineseCounter.classList.add('warning');
                }
            } else {
                // Remove warning/danger for TEAMS and Email
                englishCounter.classList.remove('warning', 'danger');
                chineseCounter.classList.remove('warning', 'danger');
            }
        }

        function setupManualCharacterCounting() {
            const englishTextarea = document.getElementById('manualEnglishContent');
            const chineseTextarea = document.getElementById('manualChineseContent');
            
            function updateCounter(textarea) {
                const channel = document.getElementById('manualNotificationChannel').value;
                const length = textarea.value.length;
                const counterId = textarea.id === 'manualEnglishContent' ? 'manualEnglishCount' : 'manualChineseCount';
                const counterSpan = document.getElementById(counterId);
                
                if (channel === 'SMS' || channel === 'App Push') {
                    // Show count with max (e.g., "50/160")
                    const maxLength = 160;
                    counterSpan.textContent = length;
                    counterSpan.parentElement.innerHTML = `<span id="${counterId}">${length}</span>/${maxLength}`;
                } else {
                    // Show count only (e.g., "50")
                    counterSpan.textContent = length;
                    counterSpan.parentElement.innerHTML = `<span id="${counterId}">${length}</span>`;
                }
                
                // Update colors
                updateManualCounterColors();
            }
            
            // Add event listeners
            englishTextarea.addEventListener('input', () => updateCounter(englishTextarea));
            chineseTextarea.addEventListener('input', () => updateCounter(chineseTextarea));
        }

        function setupManualVariableDragDrop() {
            const variables = document.querySelectorAll('#createManualNotificationModal .variable-item');
            const textareas = [
                document.getElementById('manualEnglishContent'),
                document.getElementById('manualChineseContent')
            ];
            
            variables.forEach(variable => {
                // Remove existing listeners by cloning and replacing (prevents duplicates)
                const newVariable = variable.cloneNode(true);
                variable.parentNode.replaceChild(newVariable, variable);
                
                // Click to insert variable
                newVariable.addEventListener('click', () => {
                    const variableName = newVariable.getAttribute('data-variable');
                    const activeTextarea = document.querySelector('#createManualNotificationModal .message-input-container.active textarea');
                    if (activeTextarea) {
                        const start = activeTextarea.selectionStart;
                        const end = activeTextarea.selectionEnd;
                        const text = activeTextarea.value;
                        activeTextarea.value = text.substring(0, start) + variableName + text.substring(end);
                        activeTextarea.focus();
                        
                        // Update cursor position
                        const newPosition = start + variableName.length;
                        activeTextarea.setSelectionRange(newPosition, newPosition);
                        
                        // Trigger input event to update character counter
                        activeTextarea.dispatchEvent(new Event('input'));
                    }
                });
                
                // Drag and drop
                newVariable.addEventListener('dragstart', (e) => {
                    const variableName = newVariable.getAttribute('data-variable');
                    e.dataTransfer.setData('text/plain', variableName);
                });
            });
            
            textareas.forEach(textarea => {
                // Clone and replace to remove all existing event listeners
                const newTextarea = textarea.cloneNode(true);
                textarea.parentNode.replaceChild(newTextarea, textarea);
                
                newTextarea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                });
                
                newTextarea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    const variableName = e.dataTransfer.getData('text/plain');
                    const start = newTextarea.selectionStart;
                    const end = newTextarea.selectionEnd;
                    const text = newTextarea.value;
                    newTextarea.value = text.substring(0, start) + variableName + text.substring(end);
                    
                    // Trigger input event to update character counter
                    newTextarea.dispatchEvent(new Event('input'));
                });
                
                // Re-setup character counting for the new textarea element
                newTextarea.addEventListener('input', function() {
                    const countId = this.id === 'manualEnglishContent' ? 'manualEnglishCount' : 'manualChineseCount';
                    const countElement = document.getElementById(countId);
                    if (countElement) {
                        countElement.textContent = this.value.length;
                    }
                });
            });
        }

        function toggleMultiSelect(id) {
            const dropdown = document.getElementById(id + 'Dropdown');
            dropdown.classList.toggle('open');
        }

        // Close multi-select when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.multi-select-dropdown')) {
                document.querySelectorAll('.multi-select-dropdown').forEach(dropdown => {
                    dropdown.classList.remove('open');
                });
            }
        });

        function saveManualNotificationDraft() {
            // Get form values
            const powerIncident = document.getElementById('manualPowerIncident').value;
            const name = document.getElementById('manualSubjectLine').value.trim();
            const selectedGroups = getSelectedManualRecipientGroups();
            const recipientGroup = selectedGroups.join(', ');
            const channel = document.getElementById('manualNotificationChannel').value;
            const englishMessage = document.getElementById('manualEnglishContent').value.trim();
            const chineseMessage = document.getElementById('manualChineseContent').value.trim();
            
            // Validate required fields
            if (!name) {
                alert('Please enter a subject line');
                return;
            }
            
            if (selectedGroups.length === 0) {
                alert('Please select at least one recipient group');
                return;
            }
            
            if (!channel) {
                alert('Please select a channel');
                return;
            }
            
            if (!englishMessage && !chineseMessage) {
                alert('Please enter message content for at least one language');
                return;
            }
            
            // Determine if creating new or updating existing
            let notificationId;
            let isUpdate = false;
            
            if (isEditMode && editingNotificationId) {
                // Edit mode - use existing ID
                notificationId = editingNotificationId;
                isUpdate = true;
            } else {
                // Create mode - generate new ID
                notificationCounter++;
                notificationId = 'notif-' + notificationCounter;
            }
            
            // Get current timestamp
            const now = new Date();
            const timestamp = now.getFullYear() + '-' + 
                String(now.getMonth() + 1).padStart(2, '0') + '-' + 
                String(now.getDate()).padStart(2, '0') + ' ' + 
                String(now.getHours()).padStart(2, '0') + ':' + 
                String(now.getMinutes()).padStart(2, '0') + ':' + 
                String(now.getSeconds()).padStart(2, '0');
            
            // Store notification data for preview
            if (!window.notificationData) {
                window.notificationData = {};
            }
            
            // Keep existing timestamp if updating
            let finalTimestamp = timestamp;
            if (isUpdate && window.notificationData[notificationId]) {
                finalTimestamp = window.notificationData[notificationId].lastUpdated || window.notificationData[notificationId].timestamp || timestamp;
            }
            
            window.notificationData[notificationId] = {
                templateName: name || 'Draft Notification',
                channel: channel,
                recipientGroup: recipientGroup,
                creationMethod: 'Manual',
                status: 'Draft',
                powerIncident: powerIncident,
                subjectLine: name,
                englishContent: englishMessage,
                chineseContent: chineseMessage,
                lastUpdated: isUpdate ? timestamp : finalTimestamp
            };
            
            if (isUpdate) {
                // Update existing row in table
                const tableBody = document.getElementById('notificationTableBody');
                const rows = tableBody.getElementsByTagName('tr');
                
                // Use the new timestamp when updating
                const displayTimestamp = timestamp;
                
                for (let row of rows) {
                    const actionButtons = row.querySelector('.table-actions');
                    if (actionButtons) {
                        const editBtn = actionButtons.querySelector(`button[onclick*="'${notificationId}'"]`);
                        if (editBtn) {
                            // Update the row
                            row.innerHTML = `
                                <td>${name || 'Draft Notification'}</td>
                                <td>${channel}</td>
                                <td>${recipientGroup}</td>
                                <td>Manual</td>
                                <td><span class="status-badge status-draft">Draft</span></td>
                                <td>${displayTimestamp}</td>
                                <td>
                                    <div class="table-actions">
                                        <button class="action-btn" onclick="previewNotification('${notificationId}')" title="Preview Notification"></button>
                                        <button class="action-btn" onclick="editNotification('${notificationId}')" title="Edit Notification"></button>
                                        <button class="action-btn" onclick="deleteNotification('${notificationId}')" title="Delete Notification"></button>
                                    </div>
                                </td>
                            `;
                            
                            // Add highlight effect
                            row.classList.add('highlight-row');
                            
                            // Scroll to row
                            row.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            
                            // Remove highlight after animation
                            setTimeout(() => {
                                row.classList.remove('highlight-row');
                            }, 2000);
                            
                            break;
                        }
                    }
                }
                
                // Close modal
                hideCreateManualNotificationModal();
                
                // Show success message
                showUpdateMessage('Manual notification "' + name + '" updated successfully!', 'success');
            } else {
                // Create new table row
                const tableBody = document.getElementById('notificationTableBody');
                const newRow = document.createElement('tr');
                newRow.className = 'new-row-highlight';
                newRow.innerHTML = `
                    <td>${name || 'Draft Notification'}</td>
                    <td>${channel}</td>
                    <td>${recipientGroup}</td>
                    <td>Manual</td>
                    <td><span class="status-badge status-draft">Draft</span></td>
                    <td>${finalTimestamp}</td>
                    <td>
                        <div class="table-actions">
                            <button class="action-btn" onclick="previewNotification('${notificationId}')" title="Preview Notification"></button>
                            <button class="action-btn" onclick="editNotification('${notificationId}')" title="Edit Notification"></button>
                            <button class="action-btn" onclick="deleteNotification('${notificationId}')" title="Delete Notification"></button>
                        </div>
                    </td>
                `;
                
                // Insert at the top of the table
                tableBody.insertBefore(newRow, tableBody.firstChild);
                
                // Close modal
                hideCreateManualNotificationModal();
                
                // Show success message
                showUpdateMessage('Draft notification "' + name + '" saved successfully!', 'success');
                
                // Scroll to the new row smoothly
                setTimeout(() => {
                    newRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }, 100);
            }
        }

        function createManualNotification() {
            // Get form values
            const powerIncident = document.getElementById('manualPowerIncident').value;
            const subjectLine = document.getElementById('manualSubjectLine').value.trim();
            const selectedGroups = getSelectedManualRecipientGroups();
            const recipientGroup = selectedGroups.join(', ');
            const channel = document.getElementById('manualNotificationChannel').value;
            const englishMessage = document.getElementById('manualEnglishContent').value.trim();
            const chineseMessage = document.getElementById('manualChineseContent').value.trim();
            
            // Validate required fields
            if (!powerIncident) {
                alert('Please select a power incident');
                return;
            }
            
            if (!subjectLine) {
                alert('Please enter a subject line');
                return;
            }
            
            if (selectedGroups.length === 0) {
                alert('Please select at least one recipient group');
                return;
            }
            
            if (!channel) {
                alert('Please select a channel');
                return;
            }
            
            // Language validation based on recipient group
            // 4 valid options with their language requirements:
            // a. Internal  English mandatory, Chinese optional
            // b. External-RT  Both mandatory
            // c. External-NRT  Both mandatory
            // d. External-RT + External-NRT  Both mandatory
            const hasInternal = selectedGroups.includes('Internal');
            const hasExternal = selectedGroups.some(g => g.startsWith('External-'));
            
            if (hasInternal) {
                // Option a: Internal only - English mandatory, Chinese optional
                if (!englishMessage) {
                    alert('English message is required for Internal recipient group');
                    return;
                }
            } else if (hasExternal) {
                // Options b, c, d: Any External selection - Both languages mandatory
                if (!englishMessage || !chineseMessage) {
                    alert('Both English and Chinese messages are required for External recipient groups');
                    return;
                }
            } else {
                // Fallback: at least one language required
                if (!englishMessage && !chineseMessage) {
                    alert('Please enter message content for at least one language');
                    return;
                }
            }
            
            // Determine if creating new or updating existing
            let notificationId;
            let isUpdate = false;
            
            if (isEditMode && editingNotificationId) {
                // Edit mode - use existing ID
                notificationId = editingNotificationId;
                isUpdate = true;
            } else {
                // Create mode - generate new ID
                notificationCounter++;
                notificationId = 'notif-' + notificationCounter;
            }
            
            // Get current timestamp
            const now = new Date();
            const timestamp = now.getFullYear() + '-' + 
                String(now.getMonth() + 1).padStart(2, '0') + '-' + 
                String(now.getDate()).padStart(2, '0') + ' ' + 
                String(now.getHours()).padStart(2, '0') + ':' + 
                String(now.getMinutes()).padStart(2, '0') + ':' + 
                String(now.getSeconds()).padStart(2, '0');
            
            // Store notification data for preview
            if (!window.notificationData) {
                window.notificationData = {};
            }
            
            // Keep existing timestamp if updating
            let finalTimestamp = timestamp;
            if (isUpdate && window.notificationData[notificationId]) {
                finalTimestamp = window.notificationData[notificationId].lastUpdated || window.notificationData[notificationId].timestamp || timestamp;
            }
            
            window.notificationData[notificationId] = {
                templateName: subjectLine || 'Manual Notification',
                channel: channel,
                recipientGroup: recipientGroup,
                creationMethod: 'Manual',
                status: 'Sent',
                powerIncident: powerIncident,
                subjectLine: subjectLine,
                englishContent: englishMessage,
                chineseContent: chineseMessage,
                lastUpdated: isUpdate ? timestamp : finalTimestamp
            };
            
            if (isUpdate) {
                // Update existing row in table
                const tableBody = document.getElementById('notificationTableBody');
                const rows = tableBody.getElementsByTagName('tr');
                
                // Use the new timestamp when updating
                const displayTimestamp = timestamp;
                
                for (let row of rows) {
                    const actionButtons = row.querySelector('.table-actions');
                    if (actionButtons) {
                        const editBtn = actionButtons.querySelector(`button[onclick*="'${notificationId}'"]`);
                        if (editBtn) {
                            // Update the row (keep disabled state since it's Sent status)
                            row.innerHTML = `
                                <td>${subjectLine || 'Manual Notification'}</td>
                                <td>${channel}</td>
                                <td>${recipientGroup}</td>
                                <td>Manual</td>
                                <td><span class="status-badge status-sent">Sent</span></td>
                                <td>${displayTimestamp}</td>
                                <td>
                                    <div class="table-actions">
                                        <button class="action-btn" onclick="previewNotification('${notificationId}')" title="Preview Notification"></button>
                                        <button class="action-btn" disabled title="Cannot edit sent notification"></button>
                                        <button class="action-btn" disabled title="Cannot delete sent notification"></button>
                                    </div>
                                </td>
                            `;
                            
                            // Add highlight effect
                            row.classList.add('highlight-row');
                            
                            // Scroll to row
                            row.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            
                            // Remove highlight after animation
                            setTimeout(() => {
                                row.classList.remove('highlight-row');
                            }, 2000);
                            
                            break;
                        }
                    }
                }
                
                // Close modal
                hideCreateManualNotificationModal();
                
                // Show success message
                showUpdateMessage('Manual notification "' + (subjectLine || 'Manual Notification') + '" updated and sent successfully!', 'success');
            } else {
                // Create new table row with "Sent" status
                const tableBody = document.getElementById('notificationTableBody');
                const newRow = document.createElement('tr');
                newRow.className = 'new-row-highlight';
                newRow.innerHTML = `
                    <td>${subjectLine || 'Manual Notification'}</td>
                    <td>${channel}</td>
                    <td>${recipientGroup}</td>
                    <td>Manual</td>
                    <td><span class="status-badge status-sent">Sent</span></td>
                    <td>${finalTimestamp}</td>
                    <td>
                        <div class="table-actions">
                            <button class="action-btn" onclick="previewNotification('${notificationId}')" title="Preview Notification"></button>
                            <button class="action-btn" disabled title="Cannot edit sent notification"></button>
                            <button class="action-btn" disabled title="Cannot delete sent notification"></button>
                        </div>
                    </td>
                `;
                
                // Insert at the top of the table
                tableBody.insertBefore(newRow, tableBody.firstChild);
                
                // Close modal
                hideCreateManualNotificationModal();
                
                // Show success message
                showUpdateMessage('Manual notification "' + (subjectLine || 'Manual Notification') + '" sent successfully!', 'success');
                
                // Scroll to the new row smoothly
                setTimeout(() => {
                    newRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }, 100);
            }
        }

        // Add event listeners for character counting
        document.addEventListener('DOMContentLoaded', function() {
            const manualEnglishContent = document.getElementById('manualEnglishContent');
            const manualChineseContent = document.getElementById('manualChineseContent');
            
            if (manualEnglishContent) {
                manualEnglishContent.addEventListener('input', function() {
                    updateCharCount('manualEnglishContent', 'manualEnglishCount');
                });
            }
            
            if (manualChineseContent) {
                manualChineseContent.addEventListener('input', function() {
                    updateCharCount('manualChineseContent', 'manualChineseCount');
                });
            }
        });
    </script>
</body>
</html>
